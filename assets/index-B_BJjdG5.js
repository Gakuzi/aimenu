import{initializeApp as E}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";import{getFirestore as b,getDoc as S,setDoc as I,doc as v}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";import{getAuth as L,GoogleAuthProvider as x,signOut as $,onAuthStateChanged as k,signInWithPopup as M}from"https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";import{GoogleGenAI as f,Type as c}from"https://esm.run/@google/genai";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const T={apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0,measurementId:void 0},B=E(T),w=b(B),C=L(B);try{const t=new x;window.firebaseServices={auth:C,provider:t,firestore:w,signInWithPopup:M,onAuthStateChanged:k,signOut:$,doc:v,setDoc:I,getDoc:S}}catch(t){console.error("Firebase services setup failed:",t),document.body.innerHTML="<h1>–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ Firebase.</h1>"}const N={version:"1.4.0",changelog:{"1.4.0":['–£–ª—É—á—à–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã.',"–î–æ–±–∞–≤–ª–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ –≤ –∫—É—Ä—Å–µ –Ω–æ–≤—à–µ—Å—Ç–≤.","–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞–ª –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ —É–¥–æ–±–Ω—ã–º."],"1.3.0":["–î–æ–±–∞–≤–ª–µ–Ω —ç–∫—Ä–∞–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–Ω—é –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.","–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–ª—é–¥ –∏ –¥–Ω–µ–π.","–ó–∞–º–µ–Ω–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é.","–í —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –∫ –ø–æ–∫—É–ø–∫–µ.",'–ü—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –±–ª—é–¥–∞ –∫–∞–∫ "–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ" –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∏–∑ –∑–∞–ø–∞—Å–æ–≤.',"–ù–∞ —ç–∫—Ä–∞–Ω –±—é–¥–∂–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π."],"1.2.0":["–î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –∏ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.","–ü—Ä–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–Ω—é —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.","–£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –±–ª—é–¥ –≤ –º–µ–Ω—é, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.","–û–±–Ω–æ–≤–ª–µ–Ω –¥–∏–∑–∞–π–Ω –∫–Ω–æ–ø–∫–∏ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.","–£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."],"1.1.0":["–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞—Å—Ç–∞–≤–∫–∞-–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è.","–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫—É—Ö–Ω—è, —Å–ª–æ–∂–Ω–æ—Å—Ç—å, –≤—Ä–µ–º—è).",'–£–ª—É—á—à–µ–Ω –ò–ò –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫ —Å —É—á–µ—Ç–æ–º "–º–∞–≥–∞–∑–∏–Ω–Ω—ã—Ö" –µ–¥–∏–Ω–∏—Ü.',"–í —à–∞–≥–∞—Ö —Ä–µ—Ü–µ–ø—Ç–∞ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.",'–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è "–ü–æ–ø—Ä–æ—Å–∏—Ç—å –∫—É–ø–∏—Ç—å" –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã.'],"1.0.0":["–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–ø—É—Å–∫."]},state:{settings:{apiKey:null,family:[],preferences:"–ë–µ–∑ —Ä—ã–±—ã, –±–µ–∑ –≥—Ä–∏–±–æ–≤",menuDuration:7,totalBudget:1e4,cuisine:"–õ—é–±–∞—è",difficulty:"–õ—é–±–∞—è"},menu:[],recipes:{},shoppingList:[],cookedMeals:{},timestamp:null,currentDayIndex:0},tempState:null,dom:{},wizard:{currentStep:1,totalSteps:3},currentRecipe:{id:null,step:0},timer:{interval:null,timeLeft:0,initialTime:0,isRunning:!1},async init(){this.cacheDom(),this.addEventListeners(),await this.loadState(),await new Promise(t=>{const e=setInterval(()=>{window.firebaseServices&&(clearInterval(e),t())},50)}),this.addEventListeners(),this.setupAuthListener()},cacheDom(){this.dom={splashScreen:document.getElementById("splash-screen"),startAppBtn:document.getElementById("start-app-btn"),screens:document.querySelectorAll(".screen"),welcomeScreen:document.getElementById("welcome-screen"),googleSigninBtn:document.getElementById("google-signin-btn"),setupScreen:document.getElementById("setup-screen"),mainScreen:document.getElementById("main-screen"),recipeScreen:document.getElementById("recipe-screen"),settingsScreen:document.getElementById("settings-screen"),previewScreen:document.getElementById("preview-screen"),setupWizard:document.getElementById("setup-wizard"),wizardSteps:document.querySelectorAll(".wizard-step"),wizardNav:document.getElementById("wizard-nav"),wizardBackBtn:document.getElementById("wizard-back-btn"),wizardNextBtn:document.getElementById("wizard-next-btn"),wizardStepCounter:document.getElementById("wizard-step-counter"),wizardFamilyContainer:document.getElementById("wizard-family-members-container"),wizardAddMemberBtn:document.getElementById("wizard-add-family-member-btn"),wizardDuration:document.getElementById("wizard-menu-duration"),wizardBudget:document.getElementById("wizard-total-budget"),wizardPreferences:document.getElementById("wizard-preferences"),wizardCuisine:document.getElementById("wizard-cuisine"),wizardDifficulty:document.getElementById("wizard-difficulty"),generationProgress:document.getElementById("generation-progress"),progressBar:document.getElementById("progress-bar"),progressStatus:document.getElementById("progress-status"),progressDetails:document.getElementById("progress-details"),previewMenuContainer:document.getElementById("preview-menu-container"),previewRegenerateAllBtn:document.getElementById("preview-regenerate-all-btn"),previewAcceptBtn:document.getElementById("preview-accept-btn"),mainHeaderTitle:document.getElementById("main-header-title"),openSettingsBtn:document.getElementById("open-settings-btn"),closeSettingsBtn:document.getElementById("close-settings-btn"),bottomNav:document.querySelector(".bottom-nav"),mainContents:document.querySelectorAll(".main-content"),dateSelector:document.getElementById("date-selector"),prevDayBtn:document.getElementById("prev-day-btn"),currentDateDisplay:document.getElementById("current-date-display"),nextDayBtn:document.getElementById("next-day-btn"),dailyMenuContainer:document.getElementById("daily-menu-container"),shoppingListContainer:document.getElementById("shopping-list-container"),shoppingProgressText:document.getElementById("shopping-progress-text"),shoppingProgress:document.getElementById("shopping-progress"),shoppingListTotal:document.getElementById("shopping-list-total"),backToMenuBtn:document.getElementById("back-to-menu-btn"),recipeTitle:document.getElementById("recipe-title"),stepIndicator:document.getElementById("step-indicator"),stepImage:document.getElementById("step-image"),stepDescription:document.getElementById("step-description"),timerSection:document.getElementById("timer-section"),timerDisplay:document.getElementById("timer-display"),startTimerBtn:document.getElementById("start-timer-btn"),pauseTimerBtn:document.getElementById("pause-timer-btn"),resetTimerBtn:document.getElementById("reset-timer-btn"),stepIngredientsList:document.getElementById("step-ingredients"),stepIngredientsTitle:document.getElementById("step-ingredients-title"),prevStepBtn:document.getElementById("prev-step-btn"),nextStepBtn:document.getElementById("next-step-btn"),budget:{pieProducts:document.getElementById("pie-products"),spentTotal:document.getElementById("budget-spent-total"),total:document.getElementById("budget-total"),remaining:document.getElementById("budget-remaining"),barChart:document.getElementById("bar-chart")},settings:{content:document.getElementById("settings-content"),duration:document.getElementById("settings-menu-duration"),budget:document.getElementById("settings-total-budget"),preferences:document.getElementById("settings-preferences"),cuisine:document.getElementById("settings-cuisine"),difficulty:document.getElementById("settings-difficulty"),saveBtn:document.getElementById("save-settings-btn"),familyContainer:document.getElementById("family-members-container"),addMemberBtn:document.getElementById("add-family-member-btn"),regenerateAllBtn:document.getElementById("regenerate-all-btn"),apiKeyInput:document.getElementById("settings-api-key"),saveApiKeyBtn:document.getElementById("save-api-key-btn"),runWizardBtn:document.getElementById("run-wizard-btn"),appVersionInfo:document.getElementById("app-version-info"),showChangelogBtn:document.getElementById("show-changelog-btn")},exportBtn:document.getElementById("export-btn"),importBtn:document.getElementById("import-btn"),importFileInput:document.getElementById("import-file-input"),devConsole:document.getElementById("dev-console"),logOutput:document.getElementById("log-output"),commandInput:document.getElementById("command-input"),notification:document.getElementById("notification"),notificationSound:document.getElementById("notification-sound"),modalOverlay:document.getElementById("modal-overlay"),modalTitle:document.getElementById("modal-title"),modalBody:document.getElementById("modal-body"),modalButtons:document.getElementById("modal-buttons")}},addEventListeners(){this.dom.startAppBtn.addEventListener("click",()=>{localStorage.setItem("hasSeenSplash","true"),this.showScreen("welcome-screen")}),this.dom.googleSigninBtn.addEventListener("click",()=>this.signInWithGoogle()),this.dom.wizardNextBtn.addEventListener("click",()=>this.navigateWizard(1)),this.dom.wizardBackBtn.addEventListener("click",()=>this.navigateWizard(-1)),this.dom.previewAcceptBtn.addEventListener("click",()=>this.acceptPreview()),this.dom.previewRegenerateAllBtn.addEventListener("click",()=>this.startGenerationProcess(!0)),this.dom.bottomNav.addEventListener("click",e=>this.handleNav(e)),this.dom.backToMenuBtn.addEventListener("click",()=>this.showScreen("main-screen")),this.dom.prevStepBtn.addEventListener("click",()=>this.navigateRecipeStep(-1)),this.dom.nextStepBtn.addEventListener("click",()=>this.navigateRecipeStep(1)),this.dom.prevDayBtn.addEventListener("click",()=>this.navigateMenuDay(-1)),this.dom.nextDayBtn.addEventListener("click",()=>this.navigateMenuDay(1)),this.dom.startTimerBtn.addEventListener("click",()=>this.startTimer()),this.dom.pauseTimerBtn.addEventListener("click",()=>this.pauseTimer()),this.dom.resetTimerBtn.addEventListener("click",()=>this.resetTimer()),this.dom.openSettingsBtn.addEventListener("click",()=>this.showSettingsPanel()),this.dom.closeSettingsBtn.addEventListener("click",()=>this.hideSettingsPanel()),this.dom.settings.saveBtn.addEventListener("click",()=>this.saveSettings()),this.dom.settings.addMemberBtn.addEventListener("click",()=>this.openFamilyMemberModal()),this.dom.settings.regenerateAllBtn.addEventListener("click",()=>this.confirmRegenerateAll()),this.dom.settings.saveApiKeyBtn.addEventListener("click",()=>this.saveApiKey()),this.dom.wizardAddMemberBtn.addEventListener("click",()=>this.openFamilyMemberModal(!0)),this.dom.settings.runWizardBtn.addEventListener("click",()=>{this.hideSettingsPanel(),this.showWizard()}),this.dom.settings.showChangelogBtn.addEventListener("click",()=>this.showChangelogModal()),this.dom.exportBtn.addEventListener("click",()=>this.exportData()),this.dom.importBtn.addEventListener("click",()=>this.dom.importFileInput.click()),this.dom.importFileInput.addEventListener("change",e=>this.importData(e));let t;document.body.addEventListener("touchstart",e=>{e.touches.length===3&&(t=setTimeout(()=>this.toggleDevConsole(),1e3))}),document.body.addEventListener("touchend",()=>clearTimeout(t)),this.dom.commandInput.addEventListener("keydown",e=>{e.key==="Enter"&&this.executeCommand(e.target.value)}),this.dom.modalOverlay.addEventListener("click",e=>{e.target===this.dom.modalOverlay&&this.hideModal()})},setupAuthListener(){const{auth:t,onAuthStateChanged:e}=window.firebaseServices;e(t,s=>{if(s)this.currentUser=s,this.dom.openSettingsBtn.innerHTML=`<img src="${s.photoURL}" style="width: 32px; height: 32px; border-radius: 50%;" alt="User avatar">`,this.loadState();else{this.currentUser=null,this.dom.openSettingsBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';const n=localStorage.getItem("hasSeenSplash")==="true";this.showScreen(n?"welcome-screen":"splash-screen")}})},async signInWithGoogle(){this.showNotification("–û—Ç–∫—Ä—ã–≤–∞—é –æ–∫–Ω–æ –≤—Ö–æ–¥–∞...","loading");const{auth:t,provider:e,signInWithPopup:s}=window.firebaseServices;try{await s(t,e),this.hideNotification()}catch(n){console.error("Google Sign-in failed:",n),this.showNotification(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${n.message}`,"error")}},async saveState(){try{await I(v(w,"user-data","main-config"),this.state)}catch(t){console.error("Error saving state to Firestore:",t),this.showNotification("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.","error")}},async loadState(){try{const t=v(w,"user-data","main-config"),e=await S(t);if(e.exists()){const s=e.data();s.settings&&(this.state=s,this.state.settings.family||(this.state.settings.family=[]),this.state.settings.menuDuration||(this.state.settings.menuDuration=7),this.state.cookedMeals||(this.state.cookedMeals={}),this.state.settings.cuisine||(this.state.settings.cuisine="–õ—é–±–∞—è"),this.state.settings.difficulty||(this.state.settings.difficulty="–õ—é–±–∞—è"),this.state.currentDayIndex===void 0&&(this.state.currentDayIndex=0),(this.state.shoppingList||[]).forEach(n=>{(n.items||[]).forEach(i=>{var a;i.purchases===void 0&&(i.purchases=i.completed?[{qty:((a=i.shoppingSuggestion)==null?void 0:a.qty)||1,price:i.price,date:new Date().toISOString()}]:[]),i.purchases.forEach(o=>{o.date||(o.date=new Date().toISOString())}),i.consumedQty===void 0&&(i.consumedQty=0)})}))}else console.log("No saved state found in Firestore.")}catch(t){console.error("Error loading state from Firestore:",t),this.showNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.","error")}this.hideNotification()},resetState(){const{signOut:t,auth:e}=window.firebaseServices;t(e).catch(s=>console.error("Sign out failed",s))},showScreen(t){this.dom.screens.forEach(e=>{const s=e.id===t;e.classList.toggle("hidden",!s),["recipe-screen","splash-screen","settings-screen"].includes(e.id)&&e.classList.toggle("active",s)}),t==="main-screen"?(document.getElementById("main-screen").classList.remove("hidden"),this.renderAll()):["setup-screen","welcome-screen","preview-screen"].includes(t)&&document.getElementById(t).classList.remove("hidden")},showWizard(){this.showScreen("setup-screen"),this.wizard.currentStep=1,this.updateWizardView()},updateWizardView(){const{currentStep:t,totalSteps:e}=this.wizard;this.dom.wizardDuration.value=this.state.settings.menuDuration,this.dom.wizardBudget.value=this.state.settings.totalBudget,this.dom.wizardPreferences.value=this.state.settings.preferences,this.dom.wizardCuisine.value=this.state.settings.cuisine,this.dom.wizardDifficulty.value=this.state.settings.difficulty,this.dom.wizardNav.classList.remove("hidden"),this.dom.generationProgress.classList.add("hidden"),this.dom.setupWizard.classList.remove("hidden"),this.dom.wizardStepCounter.classList.remove("hidden"),this.dom.wizardStepCounter.textContent=`–®–∞–≥ ${t} –∏–∑ ${e}`,this.dom.wizardSteps.forEach(n=>{n.classList.toggle("active",parseInt(n.dataset.step)===t)}),this.dom.wizardBackBtn.classList.toggle("hidden",t===1),this.dom.wizardNextBtn.textContent=t===e?"–ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é":"–î–∞–ª–µ–µ";let s=!1;switch(t){case 1:s=this.state.settings.family.length>0;break;default:s=!0}this.dom.wizardNextBtn.disabled=!s,t===1&&this.renderFamilyMembers(!0)},async navigateWizard(t){const{currentStep:e,totalSteps:s}=this.wizard;if(t>0){if(e===2)this.state.settings.menuDuration=parseInt(this.dom.wizardDuration.value)||7,this.state.settings.totalBudget=parseInt(this.dom.wizardBudget.value)||1e4,this.state.settings.preferences=this.dom.wizardPreferences.value,this.state.settings.cuisine=this.dom.wizardCuisine.value,this.state.settings.difficulty=this.dom.wizardDifficulty.value;else if(e===s){await this.saveState(),await this.startGenerationProcess();return}}this.wizard.currentStep+=t,this.updateWizardView()},async startGenerationProcess(t=!1,e="",s=""){if(!this.state.settings.apiKey){alert("API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω."),this.showWizard();return}this.dom.setupWizard.classList.add("hidden"),this.dom.wizardNav.classList.add("hidden"),this.dom.wizardStepCounter.classList.add("hidden"),this.dom.generationProgress.classList.remove("hidden"),this.showScreen("setup-screen");try{this.ai=new f({apiKey:this.state.settings.apiKey}),await this.updateProgress(1,2,"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Gemini‚Ä¶","–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞..."),await this.ai.models.generateContent({model:"gemini-2.5-flash",contents:"test"}),this.logToConsole("‚úÖ API KEY VALIDATED"),this.dom.progressDetails.innerHTML+="<br>‚úÖ –ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω. –î–æ—Å—Ç—É–ø –∫ Gemini –ø–æ–ª—É—á–µ–Ω.",await this.updateProgress(2,2,"–ú–∞–≥–∏—è –ò–ò –≤ –¥–µ–π—Å—Ç–≤–∏–∏‚Ä¶","–°–æ–∑–¥–∞–µ–º –º–µ–Ω—é, —Ä–µ—Ü–µ–ø—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫...");const n=await this.generateComprehensiveData(e,s);if(!n||!n.menu||n.menu.length===0)throw new Error("Menu generation failed or returned empty data. Please check your prompt and settings.");this.tempState=n,this.renderPreview(),this.showScreen("preview-screen")}catch(n){console.error("Generation failed:",n),this.updateProgress(0,2,"–û—à–∏–±–∫–∞!",`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é. ${n.message}`),this.dom.generationProgress.innerHTML+='<button class="primary-button" onclick="window.location.reload()" style="margin-top: 20px;">–ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>',t||(this.state.settings.apiKey=null,this.saveState())}},async updateProgress(t,e,s,n){return new Promise(i=>{const a=t/e*100;this.dom.progressBar.style.width=`${a}%`,this.dom.progressStatus.textContent=`–®–∞–≥ ${t}/${e}: ${s}`,this.dom.progressDetails.innerHTML=n,setTimeout(i,300)})},async makeGeminiRequest(t,e){this.logToConsole(`üü° REQUEST: ${t.substring(0,50)}...`);let s=3;for(;s>0;)try{const i=(await this.ai.models.generateContent({model:"gemini-2.5-flash",contents:t,config:{responseMimeType:"application/json",responseSchema:e}})).text.trim(),a=JSON.parse(i);return this.logToConsole("‚úÖ RESPONSE RECEIVED"),a}catch(n){if(s--,this.logToConsole(`üî¥ ERROR: ${n}. Retrying... (${s} left)`),s===0)throw n;await new Promise(i=>setTimeout(i,1e3))}},async generateComprehensiveData(t="",e=""){const{family:s,menuDuration:n,preferences:i,cuisine:a,difficulty:o,totalBudget:r}=this.state.settings,d=s.map(g=>`- ${g.name}: –í–µ—Å ${g.weight}–∫–≥, –†–æ—Å—Ç ${g.height}—Å–º. –¶–µ–ª—å: ${{lose:"–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞",maintain:"–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–µ—Å–∞",gain:"–Ω–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã"}[g.goal]}.`).join(`
`);let l=`–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ–¥–Ω–∏–º JSON-–æ—Ç–≤–µ—Ç–æ–º –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç—Ä–∏ –∫–ª—é—á–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è: "menu", "recipes", "shoppingList".

1.  **menu**: –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –º–µ–Ω—é –Ω–∞ ${n} –¥–Ω–µ–π (—Å –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è –ø–æ —Å—É–±–±–æ—Ç—É) –¥–ª—è —Å–µ–º—å–∏:
${d}.
    *   –£—á—Ç–∏ –∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –∫–∞–ª–æ—Ä–∏—è—Ö.
    *   –û–±—â–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${i}.
    *   –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –∫—É—Ö–Ω—è: ${a}.
    *   –ñ–µ–ª–∞–µ–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –±–ª—é–¥: ${o}.
    *   –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å: –ó–∞–≤—Ç—Ä–∞–∫, –ü–µ—Ä–µ–∫—É—Å, –û–±–µ–¥, –ü–æ–ª–¥–Ω–∏–∫, –£–∂–∏–Ω.
    *   –ò–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç —É–∂–∏–Ω–∞ –Ω–∞ –æ–±–µ–¥ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è (–ø–æ–º–µ—á–∞–π –∏—Ö –∫–∞–∫ "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–æ—Å—Ç–∞—Ç–∫–∏)").

2.  **recipes**: –ú–∞—Å—Å–∏–≤ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –¥–ª—è –ö–ê–ñ–î–û–ì–û —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –±–ª—é–¥–∞ –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ–Ω—é (–∫—Ä–æ–º–µ –±–ª—é–¥ —Å –ø–æ–º–µ—Ç–∫–æ–π "–æ—Å—Ç–∞—Ç–∫–∏").
    *   –ö–∞–∂–¥—ã–π —Ä–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π 'id' (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'borsch-s-govyadinoy').
    *   –ù–∞–∑–≤–∞–Ω–∏–µ 'name' —Ä–µ—Ü–µ–ø—Ç–∞ –¥–æ–ª–∂–Ω–æ –¢–û–ß–ù–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –º–µ–Ω—é.
    *   –í–∫–ª—é—á–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–ª—è —Å–µ–º—å–∏ –∏–∑ ${s.length} —á–µ–ª–æ–≤–µ–∫.
    *   –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ 'steps'. –í –∫–∞–∂–¥–æ–º —à–∞–≥–µ —É–∫–∞–∂–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.

3.  **shoppingList**: –°–≤–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
    *   –°—É–º–º–∏—Ä—É–π –í–°–ï –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ –í–°–ï–• —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤.
    *   –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: "–ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞", "–ú–æ–ª–æ—á–Ω—ã–µ –∏ —è–π—Ü–∞", "–û–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å", "–§—Ä—É–∫—Ç—ã –∏ –æ—Ä–µ—Ö–∏", "–ë–∞–∫–∞–ª–µ—è", "–•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞", "–ù–∞–ø–∏—Ç–∫–∏", "–ü—Ä–æ—á–µ–µ".
    *   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —É–∫–∞–∂–∏ –æ–±—â–µ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 'totalNeeded', –∞ –∑–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ 'shoppingSuggestion' ‚Äî —Ä–∞–∑—É–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –æ–∫—Ä—É–≥–ª—è—è –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —É–ø–∞–∫–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è 750–≥ –º—É–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫—É–ø–∏—Ç—å 1–∫–≥).
    *   –£–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—É—é —Ü–µ–Ω—É 'price' –≤ —Ä—É–±–ª—è—Ö –¥–ª—è 'shoppingSuggestion'. –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å –±—é–¥–∂–µ—Ç ${r} —Ä—É–±–ª–µ–π.
`;t&&(l+=`
–í–ê–ñ–ù–û: –ü—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –º–µ–Ω—é –æ—Ç–¥–∞–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±–ª—é–¥–∞–º, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –°–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${t}.`),e&&(l+=`
–û–°–û–ë–û–ï –£–ö–ê–ó–ê–ù–ò–ï: ${e}`);const h={type:c.ARRAY,items:{type:c.OBJECT,properties:{name:{type:c.STRING},quantity:{type:c.STRING,description:"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä '200 –≥' –∏–ª–∏ '1 —à—Ç'"}},required:["name","quantity"]}},p={type:c.OBJECT,properties:{menu:{type:c.ARRAY,description:"–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é.",items:{type:c.OBJECT,properties:{day:{type:c.STRING},meals:{type:c.OBJECT,properties:{breakfast:{type:c.STRING},snack1:{type:c.STRING},lunch:{type:c.STRING},snack2:{type:c.STRING},dinner:{type:c.STRING}},required:["breakfast","snack1","lunch","snack2","dinner"]}},required:["day","meals"]}},recipes:{type:c.ARRAY,description:"–†–µ—Ü–µ–ø—Ç—ã –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –±–ª—é–¥ –∏–∑ –º–µ–Ω—é.",items:{type:c.OBJECT,properties:{id:{type:c.STRING,description:"–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞"},name:{type:c.STRING,description:"–ù–∞–∑–≤–∞–Ω–∏–µ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é"},ingredients:h,steps:{type:c.ARRAY,items:{type:c.OBJECT,properties:{description:{type:c.STRING},time:{type:c.NUMBER,description:"–í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö. 0 –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ –Ω—É–∂–µ–Ω."},ingredients:h},required:["description","time","ingredients"]}}},required:["id","name","ingredients","steps"]}},shoppingList:{type:c.ARRAY,description:"–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.",items:{type:c.OBJECT,properties:{category:{type:c.STRING},items:{type:c.ARRAY,items:{type:c.OBJECT,properties:{name:{type:c.STRING},totalNeeded:{type:c.OBJECT,properties:{qty:{type:c.NUMBER},unit:{type:c.STRING}}},shoppingSuggestion:{type:c.OBJECT,properties:{qty:{type:c.NUMBER},unit:{type:c.STRING}}},price:{type:c.NUMBER}},required:["name","totalNeeded","shoppingSuggestion","price"]}}},required:["category","items"]}}},required:["menu","recipes","shoppingList"]},m=await this.makeGeminiRequest(l,p),u={};return m.recipes&&m.recipes.forEach(g=>{u[g.id]=g}),m.shoppingList&&m.shoppingList.forEach(g=>{(g.items||[]).forEach(y=>{y.purchases=[],y.consumedQty=0})}),{menu:m.menu||[],recipes:u,shoppingList:m.shoppingList||[]}},renderAll(){this.renderMenu(),this.renderShoppingList(),this.renderBudget()},getRegenerateIcon(){return'<svg class="regenerate-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.681 4.06c.064.155.19.284.348.348l4.06 1.68c.772.321.772 1.415 0 1.736l-4.06 1.68a.5.5 0 00-.348.349l-1.68 4.06c-.321-.772-1.415-.772-1.736 0l-1.681-4.06a.5.5 0 00-.348-.348l-4.06-1.68c-.772-.321-.772-1.415 0-1.736l4.06-1.68a.5.5 0 00.348-.348l1.68-4.06z" clip-rule="evenodd" /></svg>'},getSortedMenu(){const t=["–í–û–°–ö–†–ï–°–ï–ù–¨–ï","–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö","–í–¢–û–†–ù–ò–ö","–°–†–ï–î–ê","–ß–ï–¢–í–ï–†–ì","–ü–Ø–¢–ù–ò–¶–ê","–°–£–ë–ë–û–¢–ê"];return JSON.parse(JSON.stringify(this.state.menu||[])).sort((s,n)=>t.indexOf(s.day.toUpperCase())-t.indexOf(n.day.toUpperCase()))},renderMenu(){if(!this.state.menu||this.state.menu.length===0){this.dom.dailyMenuContainer.innerHTML='<p style="text-align: center; color: var(--soft-text); margin-top: 30px;">–ú–µ–Ω—é –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</p>',this.dom.currentDateDisplay.textContent="–ù–µ—Ç –º–µ–Ω—é";return}const t=this.getSortedMenu();(this.state.currentDayIndex>=t.length||this.state.currentDayIndex<0)&&(this.state.currentDayIndex=0);const e=t[this.state.currentDayIndex];if(!e){console.error("No day data found for index:",this.state.currentDayIndex);return}this.dom.currentDateDisplay.textContent=e.day;const s=(n,i,a,o)=>{const r=(i||"–ù–µ —É–∫–∞–∑–∞–Ω–æ").replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i,""),d=(i||"").includes("(–æ—Å—Ç–∞—Ç–∫–∏)"),l=i&&i.trim()!==""&&i.trim()!=="–ù–µ —É–∫–∞–∑–∞–Ω–æ",h=!d&&l,p=this.state.cookedMeals[o]&&this.state.cookedMeals[o].includes(a);return`
            <div class="meal ${h?"clickable":""} ${p?"cooked":""}" data-meal-name="${i||""}" data-meal-key="${a}" data-day-name="${o}">
                <button class="cooked-toggle" data-day-name="${o}" data-meal-key="${a}" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </button>
                <span class="meal-icon">${n}</span>
                <span class="meal-name">${r}</span>
                ${d?'<span class="leftover-icon">üîÑ</span>':""}
                ${l?`<button class="regenerate-btn" title="–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ">${this.getRegenerateIcon()}</button>`:""}
            </div>`};this.dom.dailyMenuContainer.innerHTML=`
            ${s("‚òÄÔ∏è",e.meals.breakfast,"breakfast",e.day)}
            ${s("üçé",e.meals.snack1,"snack1",e.day)}
            ${s("üç≤",e.meals.lunch,"lunch",e.day)}
            ${s("ü•õ",e.meals.snack2,"snack2",e.day)}
            ${s("üåô",e.meals.dinner,"dinner",e.day)}
        `,this.dom.dailyMenuContainer.querySelectorAll(".meal.clickable").forEach(n=>{n.addEventListener("click",i=>{if(i.target.closest(".regenerate-btn")||i.target.closest(".cooked-toggle"))return;const a=i.currentTarget.dataset.mealName.replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i,"").trim(),o=Object.values(this.state.recipes).find(r=>r.name===a);o?this.checkIngredientsForRecipe(o.id):a&&this.showNotification(`–†–µ—Ü–µ–ø—Ç –¥–ª—è "${a}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`,"error")})}),this.dom.dailyMenuContainer.querySelectorAll(".cooked-toggle").forEach(n=>{n.addEventListener("click",i=>{i.stopPropagation();const{dayName:a,mealKey:o}=i.currentTarget.dataset;this.toggleCookedStatus(a,o)})}),this.dom.dailyMenuContainer.querySelectorAll(".regenerate-btn").forEach(n=>{n.addEventListener("click",i=>{i.stopPropagation();const o=i.currentTarget.closest(".meal"),{dayName:r,mealKey:d}=o.dataset;this.openRegenerateModal("meal",{dayName:r,mealKey:d})})})},navigateMenuDay(t){if(!this.state.menu||this.state.menu.length===0)return;const e=this.state.menu.length;let s=this.state.currentDayIndex+t;s<0?s=e-1:s>=e&&(s=0),this.state.currentDayIndex=s,this.saveState(),this.renderMenu()},toggleCookedStatus(t,e){var r;this.state.cookedMeals[t]||(this.state.cookedMeals[t]=[]);const s=!this.state.cookedMeals[t].includes(e),n=s?1:-1,i=(((r=this.state.menu.find(d=>d.day===t))==null?void 0:r.meals[e])||"").replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i,"").trim(),a=Object.values(this.state.recipes).find(d=>d.name===i);a&&a.ingredients&&a.ingredients.forEach(d=>{const l=this.findShopItemByName(d.name),h=this.parseQuantity(d.quantity);l&&h&&(l.consumedQty===void 0&&(l.consumedQty=0),l.consumedQty+=n*h.qty,l.consumedQty=Math.max(0,l.consumedQty))});const o=this.state.cookedMeals[t].indexOf(e);o>-1?this.state.cookedMeals[t].splice(o,1):this.state.cookedMeals[t].push(e),this.saveState(),this.renderMenu(),this.showNotification(s?"–ë–ª—é–¥–æ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ!":"–û—Ç–º–µ—Ç–∫–∞ –æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ —Å–Ω—è—Ç–∞.","success")},findShopItemByName(t){if(!t)return null;const e=t.toLowerCase().trim().replace(/—ë/g,"–µ");for(const s of this.state.shoppingList)for(const n of s.items){const i=n.name.toLowerCase().trim().replace(/—ë/g,"–µ");if(i.includes(e)||e.includes(i))return n}return null},parseQuantity(t){if(typeof t!="string")return null;const e=t.match(/(\d+[\.,]?\d*)\s*([–∞-—è–ê-–Øa-zA-Z]+)?/);return e?{qty:parseFloat(e[1].replace(",",".")),unit:(e[2]||"").toLowerCase()}:null},renderShoppingList(){if(!this.state.shoppingList)return;this.dom.shoppingListContainer.innerHTML="",this.state.shoppingList.forEach((e,s)=>{const n=document.createElement("div");n.className="category-group";const i=e.items.map((a,o)=>{const r=(a.purchases||[]).reduce((g,y)=>g+y.qty,0),d=Math.max(0,a.shoppingSuggestion.qty-r),l=d<=0,h=a.shoppingSuggestion.qty>0?Math.min(r/a.shoppingSuggestion.qty*100,100):0,p=10,m=2*Math.PI*p,u=m-h/100*m;return`
                <li class="shopping-item ${l?"completed":""}" data-cat-index="${s}" data-item-index="${o}">
                    <div class="item-checkbox-progress">
                        <svg viewBox="0 0 24 24">
                          <circle class="bg" cx="12" cy="12" r="${p}"></circle>
                          <circle class="progress" cx="12" cy="12" r="${p}" stroke-dasharray="${m}" stroke-dashoffset="${u}"></circle>
                        </svg>
                        <span class="checkmark">‚úî</span>
                    </div>
                    <div class="item-details">
                        <span class="item-name">${a.name}</span>
                        <div class="item-quantity">
                           –ù—É–∂–Ω–æ: ${a.shoppingSuggestion.qty.toLocaleString("ru-RU")} ${a.shoppingSuggestion.unit} <br>
                           <span style="font-weight: bold; color: ${d>0?"var(--warning-color)":"var(--success-color)"};">–û—Å—Ç–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å: ${d.toLocaleString("ru-RU")} ${a.shoppingSuggestion.unit}</span>
                        </div>
                    </div>
                    <span class="item-price">${a.price} ‚ÇΩ</span>
                </li>
            `}).join("");n.innerHTML=`
                <button class="category-toggle">${e.category} ‚ñº</button>
                <ul class="category-items">${i}</ul>
            `,this.dom.shoppingListContainer.appendChild(n)}),this.dom.shoppingListContainer.querySelectorAll(".shopping-item").forEach(e=>{e.addEventListener("click",s=>{const{catIndex:n,itemIndex:i}=s.currentTarget.dataset;this.openPurchaseModal(parseInt(n),parseInt(i))})}),this.dom.shoppingListContainer.querySelectorAll(".category-toggle").forEach(e=>{e.addEventListener("click",s=>{const n=s.target.nextElementSibling;n.classList.toggle("collapsed"),s.target.innerHTML=n.classList.contains("collapsed")?s.target.innerHTML.replace("‚ñº","‚ñ∂"):s.target.innerHTML.replace("‚ñ∂","‚ñº")})}),this.updateShoppingProgress();const t=this.state.shoppingList.flatMap(e=>e.items).reduce((e,s)=>e+(s.price||0),0);this.dom.shoppingListTotal.innerHTML=`<span>–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—É–º–º–∞:</span> ${t.toLocaleString("ru-RU")} ‚ÇΩ`},updateShoppingProgress(){if(!this.state.shoppingList)return;const t=this.state.shoppingList.flatMap(i=>i.items||[]);if(t.length===0)return;const e=t.length,s=t.filter(i=>(i.purchases||[]).reduce((o,r)=>o+r.qty,0)>=i.shoppingSuggestion.qty).length,n=e>0?s/e*100:0;this.dom.shoppingProgress.style.width=`${n}%`,this.dom.shoppingProgressText.textContent=`${s}/${e} –∫—É–ø–ª–µ–Ω–æ`},renderBudget(){const t=this.state.settings.totalBudget,e=this.state.shoppingList.flatMap(i=>i.items||[]).flatMap(i=>i.purchases||[]).reduce((i,a)=>i+a.price,0),s=t-e,n=t>0?Math.min(e/t*100,100):0;this.dom.budget.pieProducts.style.strokeDasharray=`${n} 100`,this.dom.budget.spentTotal.innerHTML=`${e.toLocaleString("ru-RU")} ‚ÇΩ <span>–ø–æ—Ç—Ä–∞—á–µ–Ω–æ</span>`,this.dom.budget.total.textContent=`${t.toLocaleString("ru-RU")} ‚ÇΩ`,this.dom.budget.remaining.textContent=`${s.toLocaleString("ru-RU")} ‚ÇΩ`,this.dom.budget.remaining.className=`amount ${s>=0?"ok":"warning"}`,this.renderBudgetChart()},renderBudgetChart(){const t=this.state.shoppingList.flatMap(i=>i.items||[]).flatMap(i=>i.purchases||[]),e={};for(let i=6;i>=0;i--){const a=new Date;a.setDate(a.getDate()-i);const o=a.toISOString().split("T")[0];e[o]={amount:0,label:a.toLocaleDateString("ru-RU",{weekday:"short"})}}t.forEach(i=>{const a=new Date(i.date).toISOString().split("T")[0];e[a]&&(e[a].amount+=i.price)});const s=Object.values(e).map(i=>i.amount),n=Math.max(...s,1);this.dom.budget.barChart.innerHTML=Object.values(e).map(i=>`
                <div class="bar-chart-item">
                    <div class="bar" style="height: ${i.amount/n*100}%;">
                        ${i.amount>0?`<div class="bar-value">${Math.round(i.amount)}</div>`:""}
                    </div>
                    <div class="bar-label">${i.label}</div>
                </div>
            `).join("")},checkIngredientsForRecipe(t){const e=this.state.recipes[t];if(!e||!e.ingredients){this.showRecipe(t);return}const s=[];e.ingredients.forEach(n=>{const i=this.findShopItemByName(n.name),a=this.parseQuantity(n.quantity);i&&a?(i.purchases||[]).reduce((d,l)=>d+l.qty,0)-(i.consumedQty||0)<a.qty&&s.push(i):s.push({name:n.name,shoppingSuggestion:{qty:(a==null?void 0:a.qty)||1,unit:(a==null?void 0:a.unit)||"—à—Ç"}})}),s.length>0?this.showMissingIngredientsWarning(s,t):this.showRecipe(t)},showRecipe(t){if(this.currentRecipe.id=t,this.currentRecipe.step=0,!this.state.recipes[t]){this.showNotification(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç —Å ID: ${t}.`,"error");return}this.showScreen("recipe-screen"),this.renderRecipeStep()},renderRecipeStep(){const{id:t,step:e}=this.currentRecipe,s=this.state.recipes[t];if(!s||!s.steps||!s.steps[e]){console.error("Invalid recipe or step:",t,e),this.showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ—Ü–µ–ø—Ç–∞.","error"),this.showScreen("main-screen");return}const n=s.steps[e];this.dom.recipeTitle.textContent=s.name,this.dom.stepIndicator.textContent=`–®–∞–≥ ${e+1}/${s.steps.length}`,this.dom.stepDescription.textContent=n.description,this.dom.stepImage.style.opacity="0.5",n.imageUrl?(this.dom.stepImage.src=n.imageUrl,this.dom.stepImage.alt=n.description,this.dom.stepImage.style.opacity="1"):(this.dom.stepImage.src="",this.dom.stepImage.alt="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...",this.generateStepImage(t,e)),this.stopTimer(),n.time&&n.time>0?(this.timer.initialTime=n.time*60,this.resetTimer(),this.dom.timerSection.classList.remove("hidden")):this.dom.timerSection.classList.add("hidden"),this.dom.stepIngredientsList.innerHTML="",n.ingredients&&n.ingredients.length>0?(this.dom.stepIngredientsTitle.classList.remove("hidden"),n.ingredients.forEach(i=>{const a=document.createElement("li"),o=this.findShopItemByName(i.name),r=this.parseQuantity(i.quantity);let d="unknown",l="‚ùî";o&&r&&((o.purchases||[]).reduce((m,u)=>m+u.qty,0)-(o.consumedQty||0)>=r.qty?(d="completed",l="‚úÖ"):(d="missing",l="‚ö†Ô∏è")),a.innerHTML=`<span><span class="ingredient-status ${d}">${l}</span> ${i.name}</span> <span class="ingredient-quantity">${i.quantity}</span>`,this.dom.stepIngredientsList.appendChild(a)})):this.dom.stepIngredientsTitle.classList.add("hidden"),this.dom.prevStepBtn.disabled=e===0,this.dom.nextStepBtn.textContent=e===s.steps.length-1?"–ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úÖ":"–î–∞–ª–µ–µ ‚Üí"},async generateStepImage(t,e){if(!this.ai)if(this.state.settings.apiKey)this.ai=new f({apiKey:this.state.settings.apiKey});else return;try{const i=`Food photography, realistic, high-detail photo of a cooking step: "${this.state.recipes[t].steps[e].description}"`,r=`data:image/jpeg;base64,${(await this.ai.models.generateImages({model:"imagen-4.0-generate-001",prompt:i,config:{numberOfImages:1,outputMimeType:"image/jpeg",aspectRatio:"4:3"}})).generatedImages[0].image.imageBytes}`;this.currentRecipe.id===t&&this.currentRecipe.step===e&&(this.dom.stepImage.src=r,this.dom.stepImage.style.opacity="1"),this.state.recipes[t].steps[e].imageUrl=r,this.saveState()}catch(s){console.error("Image generation failed:",s),this.currentRecipe.id===t&&this.currentRecipe.step===e&&(this.dom.stepImage.alt="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")}},navigateRecipeStep(t){const{id:e,step:s}=this.currentRecipe,n=this.state.recipes[e];if(t>0&&s===n.steps.length-1){this.finishCooking();return}const i=s+t;i>=0&&i<n.steps.length&&(this.currentRecipe.step=i,this.renderRecipeStep())},finishCooking(){const{id:t}=this.currentRecipe,e=this.state.recipes[t];let s=null;for(const n of this.state.menu){for(const i in n.meals)if((n.meals[i]||"").replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i,"").trim()===e.name){s={dayName:n.day,mealKey:i};break}if(s)break}s&&this.toggleCookedStatus(s.dayName,s.mealKey),this.showNotification(`"${e.name}" –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ!`,"success"),this.showScreen("main-screen")},startTimer(){this.timer.isRunning||this.timer.timeLeft<=0||(this.timer.isRunning=!0,this.timer.interval=setInterval(()=>{this.timer.timeLeft--,this.updateTimerDisplay(),this.timer.timeLeft<=0&&this.stopTimer(!0)},1e3))},pauseTimer(){this.timer.isRunning=!1,clearInterval(this.timer.interval)},stopTimer(t=!1){this.pauseTimer(),t&&(this.dom.timerDisplay.textContent="–ì–æ—Ç–æ–≤–æ!",this.showNotification("–¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!","success"),this.dom.notificationSound.play().catch(e=>console.log("Audio play failed",e)))},resetTimer(){this.stopTimer(),this.timer.timeLeft=this.timer.initialTime,this.updateTimerDisplay()},updateTimerDisplay(){const t=Math.floor(this.timer.timeLeft/60),e=this.timer.timeLeft%60;this.dom.timerDisplay.textContent=`${String(t).padStart(2,"0")}:${String(e).padStart(2,"0")}`},handleNav(t){const e=t.target.closest(".nav-button");if(!e)return;this.dom.bottomNav.querySelectorAll(".nav-button").forEach(n=>n.classList.remove("active")),e.classList.add("active");const s=e.dataset.content;this.dom.mainHeaderTitle.textContent=e.dataset.title,this.dom.mainContents.forEach(n=>{n.classList.toggle("active",n.id===s)}),s==="budget-content"&&this.renderBudget()},showNotification(t,e="success"){this.dom.notification.textContent=t,this.dom.notification.className=e,this.dom.notification.classList.add("show"),e!=="loading"&&setTimeout(()=>{this.dom.notification.classList.remove("show")},3e3)},hideNotification(){this.dom.notification.classList.remove("show")},showModal(t,e,s){this.dom.modalTitle.textContent=t,this.dom.modalBody.innerHTML=e,this.dom.modalButtons.innerHTML="",s.forEach(n=>{const i=document.createElement("button");i.textContent=n.text,i.className=`modal-button ${n.class}`,i.addEventListener("click",()=>{n.action(),n.closes!==!1&&this.hideModal()}),this.dom.modalButtons.appendChild(i)}),this.dom.modalOverlay.classList.add("visible")},hideModal(){this.dom.modalOverlay.classList.remove("visible")},showApiKeyHelpModal(){this.showModal("–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á?",`
            <style>
                .help-step { margin-bottom: 20px; }
                .help-step h5 { font-family: var(--font-nunito); font-weight: 700; color: var(--accent-color); margin: 0 0 8px 0; font-size: 18px; }
                .help-step p { margin: 0 0 10px 0; line-height: 1.5; font-size: 15px; }
                .help-step a { color: var(--accent-color); font-weight: 600; }
                .connection-check { background-color: var(--card-accent-bg); padding: 15px; border-radius: 12px; text-align: center; }
                #connection-status { font-weight: 600; margin-top: 10px; min-height: 20px; }
            </style>
            <div class="help-step">
                <h5>–®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞</h5>
                <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–µ–Ω –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á (API Key) –æ—Ç Google Gemini.</p>
                <p>1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>
                <p>2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É <strong>"Create API key in new project"</strong>.</p>
                <p>3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —ç–∫—Ä–∞–Ω–µ.</p>
            </div>
            <div class="help-step">
                <h5>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h5>
                <p>–ò–Ω–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å—ã Google –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –≤–∞—à –¥–æ—Å—Ç—É–ø.</p>
                <div class="connection-check">
                    <button class="secondary-button" id="check-connection-btn" style="height: 45px; font-size: 16px;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
                    <div id="connection-status"></div>
                </div>
            </div>
            <div class="help-step" id="troubleshooting-step" style="display: none;">
                <h5>–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ—Ç?</h5>
                <p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É –∏–ª–∏ —Å–∞–π—Ç –∏–∑ –®–∞–≥–∞ 1 –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã Google AI –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ.</p>
                <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–∫–∏–º —Å–µ—Ä–≤–∏—Å–∞–º –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN. VPN –∏–∑–º–µ–Ω—è–µ—Ç –≤–∞—à–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
                <p>1. –í–∫–ª—é—á–∏—Ç–µ –ª—é–±–æ–π VPN-—Å–µ—Ä–≤–∏—Å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É, –≥–¥–µ Gemini –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–®–ê, –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è).</p>
                <p>2. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ <strong>–®–∞–≥ 1</strong> –∏ <strong>–®–∞–≥ 2</strong> —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º VPN.</p>
                <p>–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞, VPN –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.</p>
            </div>
        `,[{text:"–ü–æ–Ω—è—Ç–Ω–æ",class:"primary",action:()=>{}}]),document.getElementById("check-connection-btn").addEventListener("click",async e=>{const s=e.target,n=document.getElementById("connection-status"),i=document.getElementById("troubleshooting-step");s.disabled=!0,n.textContent="–ü—Ä–æ–≤–µ—Ä—è–µ–º...",n.style.color="var(--soft-text)";try{await fetch("https://generativelanguage.googleapis.com/$rpc/google.ai.generativelanguage.v1beta.ModelService/ListModels",{method:"GET",mode:"cors"}),n.textContent="‚úÖ –û—Ç–ª–∏—á–Ω–æ! –î–æ—Å—Ç—É–ø –µ—Å—Ç—å.",n.style.color="var(--success-color)",i.style.display="none"}catch(a){console.error("Connection check failed:",a),n.textContent="‚ö†Ô∏è –û—à–∏–±–∫–∞! –î–æ—Å—Ç—É–ø, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.",n.style.color="var(--danger-color)",i.style.display="block"}finally{s.disabled=!1}})},openPurchaseModal(t,e){const s=this.state.shoppingList[t].items[e],n=(s.purchases||[]).reduce((r,d)=>r+d.qty,0),i=Math.max(0,s.shoppingSuggestion.qty-n),a=`
            <p>–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å: ${s.shoppingSuggestion.qty} ${s.shoppingSuggestion.unit}. –û—Å—Ç–∞–ª–æ—Å—å: ${i} ${s.shoppingSuggestion.unit}</p>
            <div class="modal-form-group">
                <label for="purchase-qty">–°–∫–æ–ª—å–∫–æ –∫—É–ø–∏–ª–∏ (${s.shoppingSuggestion.unit})</label>
                <input type="number" id="purchase-qty" class="modal-input" value="${i>0?i:""}" placeholder="0">
            </div>
            <div class="modal-form-group">
                <label for="purchase-price">–¶–µ–Ω–∞ –∑–∞ —ç—Ç—É –ø–æ–∫—É–ø–∫—É (‚ÇΩ)</label>
                <input type="number" id="purchase-price" class="modal-input" placeholder="0">
            </div>
        `,o=[{text:"–û—Ç–º–µ–Ω–∞",class:"secondary",action:()=>{}},{text:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",class:"primary",action:()=>{const r=parseFloat(document.getElementById("purchase-qty").value)||0,d=parseFloat(document.getElementById("purchase-price").value)||0;r>0&&(s.purchases||(s.purchases=[]),s.purchases.push({qty:r,price:d,date:new Date().toISOString()}),this.saveState(),this.renderShoppingList(),this.renderBudget())}}];this.showModal(`–ü–æ–∫—É–ø–∫–∞: ${s.name}`,a,o)},async shareMissingItems(t){const e=`–ü—Ä–∏–≤–µ—Ç! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫—É–ø–∏ –¥–ª—è —É–∂–∏–Ω–∞:
`+t.map(s=>`- ${s.name} (${s.shoppingSuggestion.qty} ${s.shoppingSuggestion.unit})`).join(`
`);try{navigator.share?await navigator.share({title:"–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫",text:e}):(await navigator.clipboard.writeText(e),this.showNotification("–°–ø–∏—Å–æ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"))}catch(s){console.error("Share/Copy failed:",s),this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è/—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.","error")}},showMissingIngredientsWarning(t,e){const s=`
            <p>–î–ª—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –±–ª—é–¥–∞ –≤–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:</p>
            <ul>${t.map(i=>`<li>${i.name}</li>`).join("")}</ul>
            <p>–•–æ—Ç–∏—Ç–µ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∫–æ–≥–æ-—Ç–æ —Å—Ö–æ–¥–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω?</p>
        `,n=[{text:"–í—Å–µ —Ä–∞–≤–Ω–æ –≥–æ—Ç–æ–≤–∏—Ç—å",class:"primary",action:()=>this.showRecipe(e)},{text:"üõí –ü–æ–ø—Ä–æ—Å–∏—Ç—å –∫—É–ø–∏—Ç—å",class:"secondary",action:()=>this.shareMissingItems(t)},{text:"–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é",class:"secondary",action:()=>{}}];this.showModal("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤",s,n)},showSettingsPanel(){this.renderSettings(),this.dom.settingsScreen.classList.remove("hidden"),setTimeout(()=>this.dom.settingsScreen.classList.add("active"),10)},hideSettingsPanel(){this.dom.settingsScreen.classList.remove("active"),setTimeout(()=>{this.dom.settingsScreen.classList.add("hidden")},500)},renderSettings(){const t=this.state.settings;this.dom.settings.duration.value=t.menuDuration,this.dom.settings.budget.value=t.totalBudget,this.dom.settings.preferences.value=t.preferences,this.dom.settings.cuisine.value=t.cuisine,this.dom.settings.difficulty.value=t.difficulty,this.dom.settings.apiKeyInput.value=t.apiKey||"",this.dom.settings.appVersionInfo.textContent=`–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${this.version}`,this.renderFamilyMembers()},saveSettings(){const t=this.state.settings;t.menuDuration=parseInt(this.dom.settings.duration.value)||7,t.totalBudget=parseInt(this.dom.settings.budget.value)||1e4,t.preferences=this.dom.settings.preferences.value,t.cuisine=this.dom.settings.cuisine.value,t.difficulty=this.dom.settings.difficulty.value,this.saveState(),this.renderBudget(),this.showNotification("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ß—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–µ–Ω—é.")},async saveApiKey(){const t=this.dom.settings.apiKeyInput.value.trim();if(!t){this.showNotification("API –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º","error");return}this.showNotification("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞...","loading");try{const e=new f({apiKey:t});await e.models.generateContent({model:"gemini-2.5-flash",contents:"test"}),this.state.settings.apiKey=t,this.ai=e,this.saveState(),this.showNotification("API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω!")}catch(e){console.error("API Key validation failed:",e),this.showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.","error")}},renderFamilyMembers(t=!1){const e=t?this.dom.wizardFamilyContainer:this.dom.settings.familyContainer;if(e.innerHTML="",this.state.settings.family.length===0&&!t){e.innerHTML='<p style="color: var(--soft-text); text-align: center;">–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏.</p>';return}this.state.settings.family.forEach((s,n)=>{const i=document.createElement("div");i.className="family-member-card",i.innerHTML=`
                <div>
                    <strong>${s.name}</strong>
                    <div style="font-size: 12px; color: var(--soft-text);">
                        ${s.weight}–∫–≥, ${s.height}—Å–º, –¶–µ–ª—å: ${{lose:"–°–Ω–∏–∂–µ–Ω–∏–µ",maintain:"–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ",gain:"–ù–∞–±–æ—Ä"}[s.goal]}
                    </div>
                </div>
                <button class="edit-member-btn" data-index="${n}">‚úèÔ∏è</button>
            `,e.appendChild(i)}),e.querySelectorAll(".edit-member-btn").forEach(s=>{s.addEventListener("click",n=>{const i=parseInt(n.currentTarget.dataset.index),a=this.state.settings.family[i];this.openFamilyMemberModal(t,a,i)})})},openFamilyMemberModal(t=!1,e=null,s=-1){const n=e?"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ":"–î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏",i=e?"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å":"–î–æ–±–∞–≤–∏—Ç—å",a=`
            <div class="modal-form-group">
                <label for="modal-member-name">–ò–º—è</label>
                <input type="text" id="modal-member-name" class="modal-input" value="${(e==null?void 0:e.name)||""}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ü–∞–ø–∞">
            </div>
            <div class="modal-form-group">
                <label for="modal-member-weight">–í–µ—Å (–∫–≥)</label>
                <input type="number" id="modal-member-weight" class="modal-input" value="${(e==null?void 0:e.weight)||70}" placeholder="70">
            </div>
            <div class="modal-form-group">
                <label for="modal-member-height">–†–æ—Å—Ç (—Å–º)</label>
                <input type="number" id="modal-member-height" class="modal-input" value="${(e==null?void 0:e.height)||175}" placeholder="175">
            </div>
            <div class="modal-form-group">
                <label for="modal-member-goal">–¶–µ–ª—å</label>
                <select id="modal-member-goal" class="settings-select" style="height: 45px;">
                    <option value="lose" ${(e==null?void 0:e.goal)==="lose"?"selected":""}>–°–Ω–∏–∂–µ–Ω–∏–µ –≤–µ—Å–∞</option>
                    <option value="maintain" ${!e||(e==null?void 0:e.goal)==="maintain"?"selected":""}>–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞</option>
                    <option value="gain" ${(e==null?void 0:e.goal)==="gain"?"selected":""}>–ù–∞–±–æ—Ä –º–∞—Å—Å—ã</option>
                </select>
            </div>
        `,o=[{text:"–û—Ç–º–µ–Ω–∞",class:"secondary",action:()=>{}},e?{text:"–£–¥–∞–ª–∏—Ç—å",class:"secondary",action:()=>{this.state.settings.family.splice(s,1),this.saveState(),this.renderFamilyMembers(t),t||this.renderFamilyMembers(!1),this.updateWizardView()}}:null,{text:i,class:"primary",action:()=>{const r={name:document.getElementById("modal-member-name").value.trim()||"–ß–ª–µ–Ω —Å–µ–º—å–∏",weight:parseInt(document.getElementById("modal-member-weight").value)||70,height:parseInt(document.getElementById("modal-member-height").value)||175,goal:document.getElementById("modal-member-goal").value};s>-1?this.state.settings.family[s]=r:this.state.settings.family.push(r),this.saveState(),this.renderFamilyMembers(t),t||this.renderFamilyMembers(!1),this.updateWizardView()}}].filter(Boolean);this.showModal(n,a,o)},confirmRegenerateAll(){this.showModal("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ","<p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –ò–ò –ø–æ—Å—Ç–∞—Ä–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.</p>",[{text:"–û—Ç–º–µ–Ω–∞",class:"secondary",action:()=>{}},{text:"–î–∞, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å",class:"primary",action:()=>{const t=(this.state.shoppingList||[]).flatMap(e=>e.items||[]).filter(e=>(e.purchases||[]).length>0).map(e=>`${e.name} (${e.purchases.reduce((s,n)=>s+n.qty,0)} ${e.shoppingSuggestion.unit})`).join(", ");this.hideSettingsPanel(),this.startGenerationProcess(!0,t)}}])},showChangelogModal(){const e=Object.keys(this.changelog).sort((s,n)=>n.localeCompare(s,void 0,{numeric:!0})).map(s=>`
            <h4>–í–µ—Ä—Å–∏—è ${s}</h4>
            <ul>
                ${this.changelog[s].map(n=>`<li>${n}</li>`).join("")}
            </ul>
        `).join("");this.showModal("–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π",e,[{text:"–ó–∞–∫—Ä—ã—Ç—å",class:"primary",action:()=>{}}])},openRegenerateModal(t,e){const s=t==="meal"?"–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ":"–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å",n=`
            <p>–í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.</p>
            <div class="modal-form-group">
                <label for="regen-prompt">–ü–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="regen-prompt" class="modal-textarea" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ –ª–µ–≥–∫–æ–µ"></textarea>
            </div>
        `,i=[{text:"–û—Ç–º–µ–Ω–∞",class:"secondary",action:()=>{}},{text:"–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å",class:"primary",action:()=>{var o;const a=((o=document.getElementById("regen-prompt"))==null?void 0:o.value)||"";this.handleRegeneration(t,e,!1,a)}}];this.showModal(s,n,i)},async handleRegeneration(t,e,s=!1,n=""){var a;this.showNotification("–û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é...","loading");const i=s?this.tempState:this.state;if(i){if(!this.ai)if(this.state.settings.apiKey)this.ai=new f({apiKey:this.state.settings.apiKey});else{this.showNotification("API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.","error");return}try{let o="";const r=JSON.stringify(i.menu.map(h=>({day:h.day,meals:h.meals})));if(t==="meal"){const{dayName:h,mealKey:p}=e,m=(a=i.menu.find(u=>u.day===h))==null?void 0:a.meals[p];o=`–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –º–µ–Ω—é: ${r}. –°–î–ï–õ–ê–ô –¢–û–õ–¨–ö–û –û–î–ù–û –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¥–ª—è –¥–Ω—è "${h}" –∑–∞–º–µ–Ω–∏ –±–ª—é–¥–æ "${p}" ("${m}") –Ω–∞ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ. –ü–æ–∂–µ–ª–∞–Ω–∏–µ: ${n||"—Å–¥–µ–ª–∞–π —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ"}. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª—é–¥–∞ –≤ –º–µ–Ω—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏ —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –ø–æ–∫—É–ø–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —ç—Ç–∏–º –æ–¥–Ω–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º.`}else{const{dayName:h}=e;o=`–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –º–µ–Ω—é: ${r}. –°–î–ï–õ–ê–ô –ò–ó–ú–ï–ù–ï–ù–ò–Ø –¢–û–õ–¨–ö–û –î–õ–Ø –û–î–ù–û–ì–û –î–ù–Ø: –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–∏ –º–µ–Ω—é –¥–ª—è –¥–Ω—è "${h}". –ü–æ–∂–µ–ª–∞–Ω–∏–µ: ${n||"—Å–¥–µ–ª–∞–π —ç—Ç–æ—Ç –¥–µ–Ω—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–µ–µ"}. –°–æ—Ö—Ä–∞–Ω–∏ –º–µ–Ω—é –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏ —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –ø–æ–∫—É–ø–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —ç—Ç–æ–≥–æ –¥–Ω—è.`}const d=(this.state.shoppingList||[]).flatMap(h=>h.items||[]).filter(h=>(h.purchases||[]).length>0).map(h=>h.name).join(", "),l=await this.generateComprehensiveData(d,o);s?(this.tempState=l,this.renderPreview(),this.showNotification("–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!")):(Object.assign(this.state,l),this.saveState(),this.renderAll(),this.showNotification("–ú–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!"))}catch(o){this.showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.","error"),console.error(o)}}},renderPreview(){const t=this.dom.previewMenuContainer;t.innerHTML="",!(!this.tempState||!this.tempState.menu)&&(this.tempState.menu.forEach(e=>{const s=document.createElement("div");s.className="preview-day";const n=Object.entries(e.meals).map(([i,a])=>`
                <div class="preview-meal" data-day-name="${e.day}" data-meal-key="${i}">
                    <span class="preview-meal-name">${a||"..."}</span>
                    <button class="regenerate-btn" title="–ò–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ">${this.getRegenerateIcon()}</button>
                </div>
            `).join("");s.innerHTML=`<h4 class="preview-day-title">${e.day}</h4>${n}`,t.appendChild(s)}),t.querySelectorAll(".regenerate-btn").forEach(e=>{e.addEventListener("click",s=>{const n=s.target.closest(".preview-meal"),{dayName:i,mealKey:a}=n.dataset,o=this.tempState.menu.find(r=>r.day===i).meals[a];this.showModal("–ò–∑–º–µ–Ω–∏—Ç—å –±–ª—é–¥–æ",`<p>–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –≤–∏–¥–µ—Ç—å –≤–º–µ—Å—Ç–æ "${o}"?</p>
                     <textarea id="regen-prompt" class="modal-textarea" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —á—Ç–æ-—Ç–æ –∏–∑ –∫—É—Ä–∏—Ü—ã"></textarea>`,[{text:"–û—Ç–º–µ–Ω–∞",class:"secondary",action:()=>{}},{text:"–ò–∑–º–µ–Ω–∏—Ç—å",class:"primary",action:()=>{var d;const r=((d=document.getElementById("regen-prompt"))==null?void 0:d.value)||"";this.handleRegeneration("meal",{dayName:i,mealKey:a},!0,r)}}])})}))},acceptPreview(){this.tempState&&(Object.assign(this.state,this.tempState),this.state.timestamp=new Date().toISOString(),this.state.currentDayIndex=0,this.saveState(),this.tempState=null,this.showScreen("main-screen"),this.renderAll(),this.showNotification("–ú–µ–Ω—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"))},async exportData(){const t=`family_menu_backup_${new Date().toISOString().split("T")[0]}.json`,e=new Blob([JSON.stringify(this.state)],{type:"application/json"});try{const s=new File([e],t,{type:"application/json"});if(navigator.share&&navigator.canShare({files:[s]})){await navigator.share({files:[s],title:"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –°–µ–º–µ–π–Ω–æ–≥–æ –ú–µ–Ω—é",text:'–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –º–µ–Ω—é. –ó–∞–≥—Ä—É–∑–∏ –µ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "–°–µ–º–µ–π–Ω–æ–µ –º–µ–Ω—é+".'}),this.showNotification("–î–∞–Ω–Ω—ã–º–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å!");return}}catch(s){s.name!=="AbortError"&&console.error("Share failed:",s)}try{const s=URL.createObjectURL(e),n=document.createElement("a");n.href=s,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),this.showNotification("–§–∞–π–ª –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–∫–∞—á–∞–Ω!")}catch(s){console.error("Fallback download failed:",s),this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª.","error")}},importData(t){const e=t.target.files[0];if(!e)return;const s=new FileReader;s.onload=n=>{try{const i=JSON.parse(n.target.result);if(i.settings)this.state=i,this.saveState(),this.showNotification("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!"),this.handleStartSetup();else throw new Error("Invalid file format")}catch{this.showNotification("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.","error")}},s.readAsText(e),t.target.value=""},toggleDevConsole(){this.dom.devConsole.classList.toggle("visible")},logToConsole(t){const e=document.createElement("p");e.textContent=`[${new Date().toLocaleTimeString()}] ${t}`,this.dom.logOutput.appendChild(e),this.dom.logOutput.scrollTop=this.dom.logOutput.scrollHeight},executeCommand(t){this.logToConsole(`> ${t}`);try{switch(t.toLowerCase()){case"clear":this.dom.logOutput.innerHTML="";break;case"state":console.log(this.state),this.logToConsole("State logged to browser console.");break;case"reset":this.resetState();break;default:this.logToConsole("Unknown command. Available: clear, state, reset")}}catch(e){this.logToConsole(`Error: ${e.message}`)}this.dom.commandInput.value=""}};document.addEventListener("DOMContentLoaded",()=>N.init());
