<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>СЕМЕЙНОЕ МЕНЮ</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F9F7F4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="СЕМЕЙНОЕ МЕНЮ">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiByeD0iNTgiIGZpbGw9IiNGOUY3RjQiLz4KPHBhdGggZD0iTTg3LjM0NzIgMTE4LjY2QzgwLjQxNjEgMTE3LjU3NyA3NC4xMTE4IDEyMy43MDQgNzQuMTExOCAxMzAuOEM3NC4xMTE4IDEzNy41MjggNzkuNTg5OCAxNDMuMTExIDg2LjY0MDcgMTQzLjExMUM5My44NDAyIDE0My4xMTEgOTkuNjA4NiAxMzcuMzQzIDk5LjYwODYgMTMwLjE0MkM5OS42MDg2IDEyNC4wNSA5NC45MDk3IDExOS4zNjYgODguODIzNSAxMTguNzgyTDg3LjM0NzIgMTE4LjY2WiIgZmlsbD0iI0Q0QTM3MyIvPgo8cGF0aCBkPSJNMTE5LjMyMiAxNTkuMDQ5QzExOS4zMjIgMTY5LjY1MSAxMjQuODExIDE3NS4xMzkgMTM1LjQxOCAxNzUuMTM5QzE0Ni4wMjUgMTc1LjEzOSAxNTEuNTEzIDE2OS42NTEgMTUxLjUxMyAxNTkuMDQ5QzE1MS41MTMgMTQ4LjQ0MiAxNDYuMDI1IDE0Mi45NTQgMTM1LjQxOCAxNDIuOTU0QzEyNC44MTEgMTQyLjk1NCAxMTkuMzIyIDE0OC40NDIgMTE5LjMyMiAxNTkuMDQ5WiIgZmlsbD0iIzhCNUUzQyIvPgo8cGF0aCBkPSJNMTY3LjUxNCAxMTguNjZDMTczLjAxOCAxMTkuNDAyIDE3Ny44MTcgMTI0LjA5MSAxNzcuODE3IDEzMC4xNDJDMTc3LjgxNyAxMzcuMzQzIDE4My41ODYgMTQzLjExMSAxOTAuNzgzIDE0My4xMTFDMTk3Ljc4OSAxNDMuMTExIDIwMy4yNjcgMTM3LjUyOCAyMDMyNjcgMTMwLjhDMjAzLjI2NyAxMjMuNzA0IDE5Ni45NjMgMTE3LjU3NyAxOTAuMDI2IDExOC42NkwxODguNTU5IDExOC43ODJDMTc5LjM0MiAxMTYuNzk2IDE3MS4yMTMgMTE3LjAxMSAxNjcuNTE0IDExOC42NloiIGZpbGw9IiNENEEzNzMiLz4KPHBhdGggZD0iTTk3LjM4MjYgODVDOTIuODg2MiA4NS4zMjY0IDg5IDEwMC40OTEgODkgMTAzLjM5MUM4OSAxMDYuMjkyIDkyLjg4NjIgMTE4IDk3LjM4MjYgMTE4QzEwMS44NzkgMTE4IDEwNS43NjUgMTA2LjI5MiAxMDUuNzY1IDEwMy4zOTFDMTExLjMyNCA5NC45MTM3IDEwMy41MDcgODQuNTM1MiA5Ny4zODI2IDg1WiIgZmlsbD0id2hpdGUiIHN0cm9rZT0iI0Q0QTM3MyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xNTguNjE3IDg1QzE2My4xMTQgODUuMzI2NCAxNjcgMTAwLjQ5MSAxNjcgMTAzLjM5MUMxNjcgMTA2LjI5MiAxNjMuMTE0IDExOCAxNTguNjE3IDExOEMxNTQuMTIxIDExOCAxNTAuMjM1IDEwNi4yOTIgMTUwLjIzNSAxMDMuMzkxQzE0NC42NzYgOTQuOTEzNyAxNTIuNDkzIDg0LjUzNTIgMTU4LjYxNyA4NVoiIGZpbGw9IndoaXRlIiBzdHJva2U9IiNENEEzNzMiIHN0cm9rZS1widthPSI1IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xMjggODVDMTMyLjQ5NyA4NS4zMjY0IDEzNi4zODIgMTAwLjQ5MSAxMzYuMzgyIDEwMy4zOTFDMTM2LjM4MiAxMDYuMjkyIDEzMi40OTcgMTE4IDEyOCAxMThDMTIzLjUwNCAxMTggMTE5LjYxOCAxMDYuMjkyIDExOS42MTggMTAzLjM5MUMxMTQuMDU5IDk0LjkxMzcgMTIxLjg4IDg0LjUzNTIgMTI4IDg1WiIgZmlsbD0id2hpdGUiIHN0cm9rZT0iI0Q0QTM3MyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiByeD0iNTgiIGZpbGw9IiNGOUY3RjQiLz4KPHBhdGggZD0iTTg3LjM0NzIgMTE4LjY2QzgwLjQxNjEgMTE3LjU3NyA3NC4xMTE4IDEyMy43MDQgNzQuMTExOCAxMzAuOEM3NC4xMTE4IDEzNy41MjggNzkuNTg5OCAxNDMuMTExIDg2LjY0MDcgMTQzLjExMUM5My44NDAyIDE0My4xMTEgOTkuNjA4NiAxMzcuMzQzIDk5LjYwODYgMTMwLjE0MkM5OS42MDg2IDEyNC4wNSA5NC45MDk3IDExOS4zNjYgODguODIzNSAxMTguNzgyTDg3LjM0NzIgMTE4LjY2WiIgZmlsbD0iI0Q0QTM3MyIvPgo8cGF0aCBkPSJNMTE5LjMyMiAxNTkuMDQ5QzExOS4zMjIgMTY5LjY1MSAxMjQuODExIDE3NS4xMzkgMTM1LjQxOCAxNzUuMTM5QzE0Ni4wMjUgMTc1LjEzOSAxNTEuNTEzIDE2OS42NTEgMTUxLjUxMyAxNTkuMDQ5QzE1MS41MTMgMTQ4LjQ0MiAxNDYuMDI1IDE0Mi45NTQgMTM1LjQxOCAxNDIuOTU0QzEyNC44MTEgMTQyLjk1NCAxMTkuMzIyIDE0OC40NDIgMTE5LjMyMiAxNTkuMDQ5WiIgZmlsbD0iIzhCNUUzQyIvPgo8cGF0aCBkPSJNMTY3LjUxNCAxMTguNjZDMTczLjAxOCAxMTkuNDAyIDE3Ny44MTcgMTI0LjA5MSAxNzcuODE3IDEzMC4xNDJDMTc3LjgxNyAxMzcuMzQzIDE4My41ODYgMTQzLjExMSAxOTAuNzgzIDE0My4xMTFDMTk3Ljc4OSAxNDMuMTExIDIwMy4yNjcgMTM3LjUyOCAyMDMyNjcgMTMwLjhDMjAzLjI2NyAxMjMuNzA0IDE5Ni45NjMgMTE3LjU3NyAxOTAuMDI2IDExOC42NkwxODguNTU5IDExOC43ODJDMTc5LjM0MiAxMTYuNzk2IDE3MS4yMTMgMTE3LjAxMSAxNjcuNTE0IDExOC42NloiIGZpbGw9IiNENEEzNzMiLz4KPHBhdGggZD0iTTk3LjM4MjYgODVDOTIuODg2MiA4NS4zMjY0IDg5IDEwMC40OTEgODkgMTAzLjM5MUM4OSAxMDYuMjkyIDkyLjg4NjIgMTE4IDk3LjM4MjYgMTE4QzEwMS44NzkgMTE4IDEwNS43NjUgMTA2LjI5MiAxMDUuNzY1IDEwMy4zOTFDMTExLjMyNCA5NC45MTM3IDEwMy41MDcgODQuNTM1MiA5Ny4zODI2IDg1WiIgZmlsbD0id2hpdGUiIHN0cm9rZT0iI0Q0QTM3MyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xNTguNjE3IDg1QzE2My4xMTQgODUuMzI2NCAxNjcgMTAwLjQ5MSAxNjcgMTAzLjM5MUMxNjcgMTA2LjI5MiAxNjMuMTE0IDExOCAxNTguNjE3IDExOEMxNTQuMTIxIDExOCAxNTAuMjM1IDEwNi4yOTIgMTUwLjIzNSAxMDMuMzkxQzE0NC42NzYgOTQuOTEzNyAxNTIuNDkzIDg0LjUzNTIgMTU4LjYxNyA4NVoiIGZpbGw9IndoaXRlIiBzdHJva2U9IiNENEEzNzMiIHN0cm9rZS1widthPSI1IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CjxwYXRoIGQ9Ik0xMjggODVDMTMyLjQ5NyA4NS4zMjY0IDEzNi4zODIgMTAwLjQ5MSAxMzYuMzgyIDEwMy4zOTFDMTM2LjM4MiAxMDYuMjkyIDEzMi40OTcgMTE4IDEyOCAxMThDMTIzLjUwNCAxMTggMTE5LjYxOCAxMDYuMjkyIDExOS42MTggMTAzLjM5MUMxMTQuMDU5IDk0LjkxMzcgMTIxLjg4IDg0LjUzNTIgMTI4IDg1WiIgZmlsbD0id2hpdGUiIHN0cm9rZT0iI0Q0QTM3MyIgc3Ryb2tlLXdpZHRoPSI1IiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>


<style>
:root {
    --font-nunito: 'Nunito', sans-serif;
    --font-lato: 'Lato', sans-serif;
    --bg-color: #F9F7F4;
    --accent-color: #8B5E3C;
    --secondary-color: #D4A373;
    --success-color: #5E7A6E;
    --warning-color: #E07A5F;
    --danger-color: #D9534F;
    --text-color: #333;
    --soft-text: #7D7D7D;
    --card-bg: #FFFFFF;
    --card-accent-bg: #F0E7DD;
    --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

::placeholder { color: #888; opacity: 1; }
:-ms-input-placeholder { color: #888; }
::-ms-input-placeholder { color: #888; }

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: var(--font-lato);
    background-color: var(--bg-color);
    color: var(--text-color);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B5E3C' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.1;
    z-index: -1;
}

#app {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* --- Splash Screen --- */
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-color);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
}
.splash-logo {
    width: 100px;
    height: 100px;
}
.splash-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 28px;
    color: var(--accent-color);
    margin: 20px 0;
}
.splash-animation-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 30px 0;
    opacity: 0;
    animation: fadeIn 1s 0.5s forwards;
}
.splash-icon {
    font-size: 32px;
    margin: 0 15px;
    animation: pop-in 0.6s var(--ease-out) forwards;
    opacity: 0;
}
.splash-icon:nth-child(1) { animation-delay: 1s; }
.splash-icon:nth-child(2) { animation-delay: 1.2s; }
.splash-icon:nth-child(3) { animation-delay: 1.4s; }
.splash-arrow {
    font-size: 24px;
    color: var(--secondary-color);
    opacity: 0;
    animation: pop-in 0.5s var(--ease-out) forwards;
}
.splash-arrow:nth-child(2) { animation-delay: 1.1s; }
.splash-arrow:nth-child(4) { animation-delay: 1.3s; }

#start-app-btn {
    margin-top: 30px;
    opacity: 0;
    animation: fadeIn 1s 2.5s forwards;
}

@keyframes pop-in {
    0% { transform: scale(0.5); opacity: 0; }
    80% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    transition: transform 0.5s var(--ease-out), opacity 0.5s var(--ease-out);
    opacity: 1;
    transform: scale(1);
    overflow-y: auto;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
}

.screen.hidden {
    transform: scale(1.05);
    opacity: 0;
    pointer-events: none;
}
.hidden { display: none !important; }

/* --- Welcome Screen --- */
#welcome-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    background: linear-gradient(160deg, #F9F7F4, #EDE0D4);
}
.welcome-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    margin-top: 30px;
    margin-bottom: 30px;
}
.welcome-info {
    font-size: 14px;
    color: var(--soft-text);
    line-height: 1.5;
    max-width: 300px;
    margin: 0 auto;
}

/* --- Setup Screen --- */
#setup-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    background: linear-gradient(160deg, #F9F7F4, #EDE0D4);
}

.setup-container {
    max-width: 400px;
    width: 90%;
}

.setup-logo {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
    animation: spin 10s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.setup-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 24px;
    color: var(--accent-color);
    margin: 0 0 10px;
}

.setup-subtitle {
    font-size: 16px;
    color: var(--soft-text);
    margin-bottom: 30px;
    line-height: 1.5;
}
/* Setup Wizard */
#setup-wizard {
    position: relative;
    min-height: 250px; /* Adjust as needed */
}
.wizard-step {
    opacity: 0;
    visibility: hidden;
    position: absolute;
    top:0; left:0; right: 0;
    transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    transform: translateX(20px);
}
.wizard-step.active {
    opacity: 1;
    visibility: visible;
    position: static;
    transform: translateX(0);
}
.wizard-step-title {
    font-family: var(--font-nunito);
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 10px;
}
.wizard-step-description {
    font-size: 14px;
    color: var(--soft-text);
    line-height: 1.5;
    margin-bottom: 20px;
}

#wizard-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    gap: 10px;
}
#wizard-nav button { flex-grow: 1; }
.wizard-step-counter {
    font-size: 14px;
    color: var(--soft-text);
    margin-bottom: 15px;
}

.input-group {
    position: relative;
    margin-bottom: 20px;
}

.api-key-help-link {
    display: inline-block;
    margin-bottom: 15px;
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px dashed var(--accent-color);
}
.api-key-help-link:not([href="#"]) { /* Style for real links */
    border-bottom: 1px solid var(--accent-color);
}


#api-key-input {
    width: 100%;
    height: 50px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 0 20px;
    font-size: 16px;
    font-family: var(--font-lato);
    outline: none;
    transition: border-color 0.3s;
    color: var(--text-color);
    background-color: var(--card-bg);
}
#api-key-input:focus {
    border-color: var(--accent-color);
}

.primary-button {
    width: 100%;
    height: 50px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
    -webkit-appearance: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.primary-button:active {
    transform: scale(0.98);
}
.primary-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}
.primary-button.reveal {
    animation: reveal 0.5s var(--ease-out) forwards;
    opacity: 0;
    transform: translateY(20px);
}
@keyframes reveal {
    to { opacity: 1; transform: translateY(0); }
}
.danger-button {
    background-color: var(--danger-color);
}
.secondary-button {
    width: 100%;
    height: 50px;
    background: var(--card-accent-bg);
    color: var(--accent-color);
    border: none;
    border-radius: 12px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.secondary-button:active {
    transform: scale(0.98);
}
/* Generation Progress */
#generation-progress {
    width: 100%;
}
.progress-bar-container {
    width: 100%;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 20px 0;
}
#progress-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    transition: width 0.5s var(--ease-out);
}
#progress-status {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    color: var(--accent-color);
    margin-bottom: 5px;
    min-height: 25px;
}
#progress-details {
    font-size: 14px;
    color: var(--soft-text);
    min-height: 40px;
    line-height: 1.4;
}

/* --- Main Screen --- */
#main-screen {
    padding: 0;
    padding-top: env(safe-area-inset-top);
    display: flex;
    flex-direction: column;
}
.main-header {
    padding: 15px 20px;
    font-family: var(--font-nunito);
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-color);
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#sync-status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #ccc; /* grey for idle */
    transition: background-color 0.5s;
    margin-left: 10px;
}
#sync-status-indicator.syncing { background-color: #f3ca52; } /* yellow */
#sync-status-indicator.synced { background-color: var(--success-color); } /* green */
#sync-status-indicator.error { background-color: var(--danger-color); } /* red */

.content-area {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
}
.bottom-nav {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: #fff;
    border-top: 1px solid #eee;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    flex-shrink: 0;
}
.nav-button {
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
    font-size: 12px;
    color: var(--soft-text);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: color 0.2s;
    width: 20%;
}
.nav-button svg {
    width: 24px;
    height: 24px;
    fill: none;
    stroke: var(--soft-text);
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: all 0.2s;
}
.nav-button.active, .nav-button:active {
    color: var(--accent-color);
}
.nav-button.active svg, .nav-button:active svg {
    stroke: var(--accent-color);
    transform: scale(1.1);
}
.main-content {
    display: none;
}
.main-content.active {
    display: block;
    animation: fadeIn 0.5s var(--ease-out);
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Menu Screen --- */
.day-scroller {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding: 10px 0 20px;
    -webkit-overflow-scrolling: touch;
}
.day-scroller::-webkit-scrollbar { display: none; }

.day-card {
    flex: 0 0 90%;
    width: 90%;
    margin-right: 15px;
    scroll-snap-align: center;
    background-color: var(--card-bg);
    border-radius: 24px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.04);
    padding: 20px;
    display: flex;
    flex-direction: column;
}
.day-card:last-child { margin-right: 0; }
.day-title-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}
.day-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-align: center;
    text-transform: uppercase;
    margin: 0 10px;
}
.regenerate-btn {
    background: none; border: none; cursor: pointer; font-size: 20px; opacity: 0.5; transition: opacity 0.2s; padding: 5px;
}
.regenerate-btn:hover { opacity: 1; }
.meal {
    display: flex;
    align-items: center;
    padding: 10px 0;
    font-size: 18px;
    position: relative;
    background-color: var(--card-accent-bg);
    border-radius: 12px;
    padding: 12px 10px;
    margin: 5px 0;
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--accent-color);
}
.meal-icon {
    margin-right: 15px;
    font-size: 20px;
    transition: opacity 0.3s;
}
.meal-name {
    flex-grow: 1;
    transition: opacity 0.3s;
    padding-right: 30px; /* Space for regenerate button */
}
.meal.placeholder {
    color: #ccc;
}
.meal.clickable {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.meal .regenerate-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
}
.meal.clickable:active {
    transform: scale(0.99);
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.leftover-icon {
    font-size: 16px;
    opacity: 0.5;
    margin-left: 8px;
    color: var(--secondary-color);
}
.cooked-toggle {
    background: none; border: none; cursor: pointer;
    width: 28px; height: 28px;
    margin-right: 10px;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    border: 2px solid #ccc;
    color: #ccc;
    transition: all 0.3s var(--ease-out);
}
.cooked-toggle svg {
    width: 18px; height: 18px;
    fill: currentColor;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s var(--ease-out);
}
.meal.cooked .cooked-toggle {
    border-color: var(--success-color);
    background-color: var(--success-color);
    color: white;
}
.meal.cooked .cooked-toggle svg {
    opacity: 1;
    transform: scale(1);
}
.meal.cooked .meal-name, .meal.cooked .meal-icon {
    opacity: 0.6;
    text-decoration: line-through;
}
.meal.cooked.clickable {
    color: var(--soft-text);
}


/* --- Recipe Screen --- */
#recipe-screen {
    background-color: #fff;
    transform: translateX(100%);
    z-index: 10;
}
#recipe-screen.active {
    transform: translateX(0);
}
.recipe-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 15px 0;
}
.back-button {
    background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: var(--accent-color); font-weight: 600; display: flex; align-items: center;
}
#recipe-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-align: center;
    flex-grow: 1;
}
#step-indicator {
    font-size: 18px;
    color: var(--secondary-color);
    font-family: var(--font-nunito);
    font-weight: 600;
}
#step-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    background-color: #eee;
    transition: opacity 0.3s;
}
#step-description {
    font-size: 18px;
    line-height: 1.6;
    margin: 20px 0;
}
.timer-container {
    background-color: var(--card-accent-bg);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
}
#timer-display {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 48px;
    color: var(--accent-color);
    letter-spacing: 2px;
}
.timer-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}
.timer-button {
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s;
}
.timer-button:active { transform: scale(0.95); }
#start-timer-btn { background-color: var(--success-color); color: white; }
#pause-timer-btn { background-color: var(--warning-color); color: white; }
#reset-timer-btn { background-color: #ccc; color: #333; }

#step-ingredients-title {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    margin-top: 20px;
}
#step-ingredients {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}
#step-ingredients li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 16px;
}
.ingredient-status {
    margin-right: 12px;
    font-size: 20px;
}
.ingredient-status.completed { color: var(--success-color); }
.ingredient-status.missing { color: var(--warning-color); }
.ingredient-status.unknown { color: #ccc; }
.ingredient-quantity {
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--soft-text);
}

.recipe-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}
.nav-btn-recipe {
    background: var(--card-accent-bg);
    color: var(--accent-color);
    border: none;
    border-radius: 12px;
    padding: 15px 30px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
}
.nav-btn-recipe:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
#step-ingredients-title.hidden {
    display: none;
}


/* --- Shopping List --- */
#shopping-list-content { padding-bottom: 50px; }
.progress-bar-shopping {
    width: 100%;
    height: 8px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0 20px;
}
#shopping-progress {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    transition: width 0.5s var(--ease-out);
}
#shopping-progress-text {
    font-size: 14px;
    color: var(--soft-text);
    margin-bottom: 10px;
}
.category-toggle {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    padding: 15px 0;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    color: var(--accent-color);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}
.category-items {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.5s var(--ease-out), padding 0.5s var(--ease-out);
}
.category-items.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
}
.shopping-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
}

.item-checkbox-progress {
    width: 24px; height: 24px;
    position: relative;
    margin-right: 15px;
    flex-shrink: 0;
}
.item-checkbox-progress svg {
    width: 100%; height: 100%;
    transform: rotate(-90deg);
}
.item-checkbox-progress circle {
    fill: none;
    stroke-width: 2.5;
}
.item-checkbox-progress .bg { stroke: #ccc; }
.item-checkbox-progress .progress { stroke: var(--success-color); transition: stroke-dasharray 0.3s linear; }
.item-checkbox-progress .checkmark {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    color: var(--success-color);
    font-size: 16px;
    transition: transform 0.2s var(--ease-out);
}
.shopping-item.completed .item-checkbox-progress .checkmark {
    transform: translate(-50%, -50%) scale(1);
}

.item-details {
    flex-grow: 1;
    transition: color 0.3s;
}
.item-name {
    font-size: 16px;
    font-weight: 600;
}
.item-quantity {
    font-size: 14px;
    color: var(--soft-text);
}
.item-price {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    color: var(--accent-color);
}
.shopping-item.completed .item-details { color: #aaa; }
.shopping-item.completed .item-name { text-decoration: line-through; }


#shopping-list-total {
    margin-top: 20px;
    padding: 20px;
    background-color: var(--card-accent-bg);
    border-radius: 16px;
    text-align: center;
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 20px;
    color: var(--accent-color);
}
#shopping-list-total span { font-weight: 400; font-size: 16px; }

/* --- Budget Screen --- */
.budget-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
}
.pie-chart-container {
    position: relative;
    width: 250px;
    height: 250px;
    margin-bottom: 30px;
}
.pie-chart {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}
.pie-chart circle {
    fill: none;
    stroke-width: 32;
    transition: stroke-dasharray 0.8s var(--ease-out);
}
.chart-center-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 32px;
    color: var(--accent-color);
}
.chart-center-text span {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--soft-text);
}
.budget-summary {
    width: 100%;
    text-align: center;
}
.budget-summary p {
    margin: 8px 0;
    font-size: 18px;
}
.budget-summary .amount {
    font-family: var(--font-nunito);
    font-weight: 700;
}
.budget-summary #budget-remaining.ok {
    color: var(--success-color);
}
.budget-summary #budget-remaining.warning {
    color: var(--warning-color);
}

/* --- Settings Screen --- */
#settings-content {
    padding-bottom: 50px;
}
.settings-section {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.settings-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 20px;
    color: var(--accent-color);
    margin: 0 0 20px 0;
}
.settings-form-group {
    margin-bottom: 15px;
}
.settings-form-group label {
    display: block;
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 8px;
    text-align: left;
}
.settings-input, .settings-textarea, .settings-select {
    width: 100%;
    height: 45px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0 15px;
    font-size: 16px;
    font-family: var(--font-lato);
    background: #fff;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    color: var(--text-color);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}
.settings-textarea {
    height: auto;
    padding-top: 10px;
    padding-bottom: 10px;
    resize: vertical;
    background-image: none;
}
.wizard-step .settings-select {
    height: 50px;
}
.wizard-step .settings-input {
    height: 50px;
}
.wizard-step .settings-textarea {
     height: 60px;
}

.family-member-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--card-accent-bg);
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
}
.family-member-card button {
    background: none; border: none; font-size: 20px; cursor: pointer; color: var(--danger-color); opacity: 0.7;
}

.install-instructions {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--card-accent-bg);
    padding: 15px;
    border-radius: 12px;
}
.install-icon {
    font-size: 24px;
}
.install-text {
    font-size: 14px;
    line-height: 1.5;
}
.sync-info {
    font-size: 14px;
    line-height: 1.5;
    background-color: var(--card-accent-bg);
    padding: 15px;
    border-radius: 12px;
    color: var(--soft-text);
}
.sync-info strong {
    color: var(--accent-color);
}
.sync-info a {
    color: var(--accent-color);
    font-weight: 600;
    text-decoration: none;
}

/* --- QR Code Scanner --- */
#qr-scanner-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
}
#qr-video {
    width: 100%;
    max-width: 600px;
    height: auto;
}
#qr-canvas {
    display: none;
}

/* --- Dev Console --- */
#dev-console {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 30vh;
    background-color: rgba(0,0,0,0.9);
    color: #e0e0e0;
    border-top: 1px solid var(--secondary-color);
    transform: translateY(100%);
    transition: transform 0.4s var(--ease-out);
    z-index: 100;
    display: flex;
    flex-direction: column;
}
#dev-console.visible {
    transform: translateY(0);
}
#log-output {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px;
}
#log-output p { margin: 2px 0; }
#command-input {
    width: 100%;
    background: #333;
    border: none;
    border-top: 1px solid #555;
    color: #e0e0e0;
    padding: 10px;
    font-family: 'Courier New', Courier, monospace;
    outline: none;
}

/* --- Notification --- */
#notification {
    position: fixed;
    top: env(safe-area-inset-top, 0);
    left: 50%;
    transform: translate(-50%, -150%);
    background-color: var(--success-color);
    color: white;
    padding: 12px 25px;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-family: var(--font-nunito);
    font-weight: 700;
    z-index: 200;
    transition: transform 0.5s var(--ease-out);
}
#notification.show {
    transform: translate(-50%, 20px);
}
#notification.loading {
    background-color: var(--secondary-color);
}
#notification.error {
    background-color: var(--danger-color);
}

/* --- Modal --- */
#modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-out);
}
#modal-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
.modal-content {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 24px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transform: scale(0.95);
    transition: transform 0.3s var(--ease-out);
}
#modal-overlay.visible .modal-content {
    transform: scale(1);
}
.modal-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    margin: 0 0 20px;
    text-align: center;
}
.modal-body {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-color);
    margin-bottom: 25px;
    text-align: left;
    max-height: 60vh;
    overflow-y: auto;
    word-wrap: break-word;
}
.modal-body ul {
    padding-left: 20px;
}
.modal-body ul li {
    margin-bottom: 8px;
}
#qr-code-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    background: white;
    border-radius: 8px;
    margin-bottom: 15px;
}
#qr-code-container img {
    max-width: 100%;
    height: auto;
}
.modal-form-group {
    margin-bottom: 15px;
}
.modal-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--soft-text);
}
.modal-input, .modal-textarea {
    width: 100%;
    height: 45px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0 15px;
    font-size: 16px;
    font-family: var(--font-lato);
    color: var(--text-color);
    background-color: var(--card-bg);
}
.modal-textarea {
    height: auto;
    padding-top: 10px;
    padding-bottom: 10px;
    resize: vertical;
}
.modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.modal-button {
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-family: var(--font-nunito);
    font-weight: 700;
    cursor: pointer;
    width: 100%;
}
.modal-button.secondary {
    background-color: #eee;
    color: #333;
}
.modal-button.primary {
    background-color: var(--accent-color);
    color: white;
}
</style>
</head>
<body>

<div id="app">
    <!-- Экран-заставка -->
    <div class="screen" id="splash-screen">
        <svg class="splash-logo" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="256" height="256" rx="58" fill="#F9F7F4"/><path d="M87.347 118.66C80.416 117.577 74.112 123.704 74.112 130.8c0 6.796 5.478 12.31 12.529 12.31 7.201 0 12.969-5.768 12.969-12.969 0-6.09-4.7-10.779-10.765-11.338l-1.476-.122z" fill="#D4A373"/><path d="M119.322 159.049c0 10.609 5.489 16.09 16.096 16.09s16.095-5.481 16.095-16.09-5.488-16.095-16.095-16.095-16.096 5.488-16.096 16.095z" fill="#8B5E3C"/><path d="M167.514 118.66c5.504.742 10.303 5.431 10.303 11.482 0 7.201 5.769 12.969 12.969 12.969 7.006 0 12.484-5.522 12.484-12.31 0-7.104-6.304-13.227-12.941-12.14l-1.467.122c-9.217-1.986-17.346-1.649-21.35-0z" fill="#D4A373"/><path d="M97.383 85c-4.496.326-8.383 15.49-8.383 18.39 0 2.9 3.887 14.609 8.383 14.609s8.382-11.709 8.382-14.609c5.559-8.477-1.628-18.855-8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/><path d="M158.617 85c4.497.326 8.383 15.49 8.383 18.39 0 2.9-3.886 14.609-8.383 14.609s-8.382-11.709-8.382-14.609c-5.559-8.477 1.628-18.855 8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/><path d="M128 85c4.497.326 8.382 15.49 8.382 18.39 0 2.9-3.885 14.609-8.382 14.609s-8.382-11.709-8.382-14.609c-5.559-8.477 1.621-18.855 8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/></svg>
        <h1 class="splash-title">СЕМЕЙНОЕ МЕНЮ</h1>
        <div class="splash-animation-container">
            <div class="splash-icon">🗓️</div>
            <div class="splash-arrow">→</div>
            <div class="splash-icon">🛒</div>
            <div class="splash-arrow">→</div>
            <div class="splash-icon">👩‍🍳</div>
        </div>
        <button class="primary-button" id="start-app-btn" style="width: 200px">Начать</button>
    </div>

    <!-- Экран приветствия -->
    <div class="screen hidden" id="welcome-screen">
        <div class="setup-container">
            <svg class="setup-logo" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="256" height="256" rx="58" fill="#F9F7F4"/><path d="M87.347 118.66C80.416 117.577 74.112 123.704 74.112 130.8c0 6.796 5.478 12.31 12.529 12.31 7.201 0 12.969-5.768 12.969-12.969 0-6.09-4.7-10.779-10.765-11.338l-1.476-.122z" fill="#D4A373"/><path d="M119.322 159.049c0 10.609 5.489 16.09 16.096 16.09s16.095-5.481 16.095-16.09-5.488-16.095-16.095-16.095-16.096 5.488-16.096 16.095z" fill="#8B5E3C"/><path d="M167.514 118.66c5.504.742 10.303 5.431 10.303 11.482 0 7.201 5.769 12.969 12.969 12.969 7.006 0 12.484-5.522 12.484-12.31 0-7.104-6.304-13.227-12.941-12.14l-1.467.122c-9.217-1.986-17.346-1.649-21.35-0z" fill="#D4A373"/><path d="M97.383 85c-4.496.326-8.383 15.49-8.383 18.39 0 2.9 3.887 14.609 8.383 14.609s8.382-11.709 8.382-14.609c5.559-8.477-1.628-18.855-8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/><path d="M158.617 85c4.497.326 8.383 15.49 8.383 18.39 0 2.9-3.886 14.609-8.383 14.609s-8.382-11.709-8.382-14.609c-5.559-8.477 1.628-18.855 8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/><path d="M128 85c4.497.326 8.382 15.49 8.382 18.39 0 2.9-3.885 14.609-8.382 14.609s-8.382-11.709-8.382-14.609c-5.559-8.477 1.621-18.855 8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/></svg>
            <h1 class="setup-title">Добро пожаловать!</h1>
            <p class="setup-subtitle">Как вы хотите начать?</p>
            <div class="welcome-buttons">
                <button class="primary-button" id="start-setup-wizard-btn">🚀 Начать настройку</button>
                <button class="secondary-button" id="load-from-file-btn">📥 Загрузить из файла</button>
                <button class="secondary-button" id="scan-qr-btn">📷 Сканировать QR</button>
            </div>
            <p class="welcome-info">Загрузите конфигурацию из файла или отсканируйте QR-код с другого устройства, чтобы пропустить настройку.</p>
        </div>
    </div>


    <!-- Экран первоначальной настройки и генерации -->
    <div class="screen hidden" id="setup-screen">
        <div class="setup-container">
             <svg class="setup-logo" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect width="256" height="256" rx="58" fill="#F9F7F4"/><path d="M87.347 118.66C80.416 117.577 74.112 123.704 74.112 130.8c0 6.796 5.478 12.31 12.529 12.31 7.201 0 12.969-5.768 12.969-12.969 0-6.09-4.7-10.779-10.765-11.338l-1.476-.122z" fill="#D4A373"/><path d="M119.322 159.049c0 10.609 5.489 16.09 16.096 16.09s16.095-5.481 16.095-16.09-5.488-16.095-16.095-16.095-16.096 5.488-16.096 16.095z" fill="#8B5E3C"/><path d="M167.514 118.66c5.504.742 10.303 5.431 10.303 11.482 0 7.201 5.769 12.969 12.969 12.969 7.006 0 12.484-5.522 12.484-12.31 0-7.104-6.304-13.227-12.941-12.14l-1.467.122c-9.217-1.986-17.346-1.649-21.35-0z" fill="#D4A373"/><path d="M97.383 85c-4.496.326-8.383 15.49-8.383 18.39 0 2.9 3.887 14.609 8.383 14.609s8.382-11.709 8.382-14.609c5.559-8.477-1.628-18.855-8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/><path d="M158.617 85c4.497.326 8.383 15.49 8.383 18.39 0 2.9-3.886 14.609-8.383 14.609s-8.382-11.709-8.382-14.609c-5.559-8.477 1.628-18.855 8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/><path d="M128 85c4.497.326 8.382 15.49 8.382 18.39 0 2.9-3.885 14.609-8.382 14.609s-8.382-11.709-8.382-14.609c-5.559-8.477 1.621-18.855 8.382-18.39z" fill="#fff" stroke="#D4A373" stroke-width="5" stroke-linejoin="round"/></svg>
            <h1 class="setup-title">СЕМЕЙНОЕ МЕНЮ</h1>
            <p class="setup-subtitle">Ваш ИИ-помощник для вкусных и простых семейных обедов.</p>
            <p class="wizard-step-counter" id="wizard-step-counter"></p>
            
            <div id="setup-wizard">
                <div class="wizard-step" data-step="1">
                    <h3 class="wizard-step-title">Шаг 1: Подключение к ИИ</h3>
                    <p class="wizard-step-description">Для начала работы укажите ваш API ключ для Google Gemini.</p>
                    <a href="#" id="api-key-help-link" class="api-key-help-link">Где взять ключ? Пошаговая инструкция</a>
                    <div class="input-group">
                        <input type="password" id="api-key-input" placeholder="Ваш Google Gemini API ключ">
                    </div>
                </div>

                <div class="wizard-step" data-step="2">
                    <h3 class="wizard-step-title">Шаг 2: Онлайн-синхронизация (Рекомендуется)</h3>
                    <p class="wizard-step-description">Введите ключи от JSONBin.io для хранения данных онлайн и синхронизации между устройствами в реальном времени. Этот шаг можно пропустить.</p>
                    <a href="#" id="jsonbin-help-link" class="api-key-help-link">Где взять ключи для JSONBin?</a>
                     <div class="settings-form-group">
                        <input type="text" id="wizard-jsonbin-bin-id" class="settings-input" placeholder="JSONBin.io Bin ID">
                    </div>
                    <div class="settings-form-group">
                       <input type="password" id="wizard-jsonbin-api-key" class="settings-input" placeholder="JSONBin.io X-Master-Key">
                    </div>
                </div>

                <div class="wizard-step" data-step="3">
                    <h3 class="wizard-step-title">Шаг 3: Расскажите о вашей семье</h3>
                    <p class="wizard-step-description">Эта информация поможет ИИ рассчитать калорийность и размер порций. Добавьте каждого члена семьи.</p>
                    <div id="wizard-family-members-container"></div>
                    <button class="secondary-button" id="wizard-add-family-member-btn" style="height: 45px; font-size: 16px;">+ Добавить члена семьи</button>
                </div>

                <div class="wizard-step" data-step="4">
                    <h3 class="wizard-step-title">Шаг 4: Настройте ваше меню</h3>
                    <p class="wizard-step-description">Укажите основные параметры для планирования.</p>
                    <div class="settings-form-group">
                        <label for="wizard-menu-duration">Количество дней меню</label>
                        <input type="number" id="wizard-menu-duration" class="settings-input" min="1" max="14">
                    </div>
                    <div class="settings-form-group">
                        <label for="wizard-total-budget">Общий бюджет, ₽</label>
                        <input type="number" id="wizard-total-budget" class="settings-input" step="500">
                    </div>
                    <div class="settings-form-group">
                        <label for="wizard-preferences">Предпочтения и аллергии</label>
                        <textarea id="wizard-preferences" class="settings-textarea" rows="2" placeholder="Например: без рыбы, меньше жареного"></textarea>
                    </div>
                    <div class="settings-form-group">
                        <label for="wizard-cuisine">Предпочитаемая кухня</label>
                        <select id="wizard-cuisine" class="settings-select">
                            <option value="Любая">Любая</option>
                            <option value="Русская">Русская</option>
                            <option value="Итальянская">Итальянская</option>
                            <option value="Азиатская">Азиатская</option>
                            <option value="Средиземноморская">Средиземноморская</option>
                            <option value="Кавказская">Кавказская</option>
                        </select>
                    </div>
                     <div class="settings-form-group">
                        <label for="wizard-difficulty">Сложность блюд</label>
                        <select id="wizard-difficulty" class="settings-select">
                            <option value="Любая">Любая</option>
                            <option value="Простая">Простая (быстро и легко)</option>
                            <option value="Средняя">Средняя (стандартные рецепты)</option>
                            <option value="Сложная">Сложная (для особых случаев)</option>
                        </select>
                    </div>
                </div>

                <div class="wizard-step" data-step="5">
                    <h3 class="wizard-step-title">Всё готово к магии!</h3>
                    <p class="wizard-step-description">Мы собрали все необходимые данные. Нажмите кнопку ниже, чтобы наш ИИ создал ваше идеальное семейное меню на неделю.</p>
                </div>
            </div>
            
            <div id="wizard-nav" class="hidden">
                 <button class="secondary-button" id="wizard-back-btn">Назад</button>
                 <button class="primary-button" id="wizard-next-btn">Далее</button>
            </div>

            <div id="generation-progress" class="hidden">
                <div id="progress-status"></div>
                <div class="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="progress-details"></div>
                <button class="primary-button hidden" id="finish-setup-btn">Открыть меню</button>
            </div>
        </div>
    </div>

    <!-- Основной экран приложения с навигацией -->
    <div class="screen hidden" id="main-screen">
        <header class="main-header">
            <span id="main-header-title">Меню на неделю</span>
            <div id="sync-status-indicator" title="Статус синхронизации"></div>
        </header>
        <div class="content-area">
            <div class="main-content active" id="menu-content">
                <div class="day-scroller" id="day-scroller-container"></div>
            </div>
            <div class="main-content" id="shopping-list-content">
                <p id="shopping-progress-text">0/0 куплено</p>
                <div class="progress-bar-shopping">
                    <div id="shopping-progress"></div>
                </div>
                <div id="shopping-list-container"></div>
                <div id="shopping-list-total"><span>Примерная сумма:</span> 0 ₽</div>
            </div>
            <div class="main-content" id="budget-content">
                <div class="budget-container">
                    <div class="pie-chart-container">
                        <svg class="pie-chart" viewBox="0 0 36 36">
                          <circle cx="18" cy="18" r="15.9155" stroke="#eee" stroke-width="32" fill="#fff"/>
                          <circle class="pie-slice" id="pie-products" cx="18" cy="18" r="15.9155" stroke="#8B5E3C" stroke-dasharray="0, 100"/>
                        </svg>
                        <div class="chart-center-text" id="budget-spent-total">0 ₽ <span>потрачено</span></div>
                    </div>
                    <div class="budget-summary">
                        <p>Бюджет: <span class="amount" id="budget-total">10000 ₽</span></p>
                        <p>Осталось: <span class="amount ok" id="budget-remaining">10000 ₽</span></p>
                    </div>
                </div>
            </div>
            <div class="main-content" id="settings-content">
                <div class="settings-section">
                    <h3 class="settings-title">Параметры меню</h3>
                    <div class="settings-form-group">
                        <label for="settings-menu-duration">Количество дней меню</label>
                        <input type="number" id="settings-menu-duration" class="settings-input" min="1" max="14">
                    </div>
                    <div class="settings-form-group">
                        <label for="settings-total-budget">Общий бюджет, ₽</label>
                        <input type="number" id="settings-total-budget" class="settings-input" step="500">
                    </div>
                    <div class="settings-form-group">
                        <label for="settings-cuisine">Предпочитаемая кухня</label>
                        <select id="settings-cuisine" class="settings-select">
                            <option value="Любая">Любая</option>
                            <option value="Русская">Русская</option>
                            <option value="Итальянская">Итальянская</option>
                            <option value="Азиатская">Азиатская</option>
                            <option value="Средиземноморская">Средиземноморская</option>
                            <option value="Кавказская">Кавказская</option>
                        </select>
                    </div>
                     <div class="settings-form-group">
                        <label for="settings-difficulty">Сложность блюд</label>
                        <select id="settings-difficulty" class="settings-select">
                            <option value="Любая">Любая</option>
                            <option value="Простая">Простая (быстро и легко)</option>
                            <option value="Средняя">Средняя (стандартные рецепты)</option>
                            <option value="Сложная">Сложная (для особых случаев)</option>
                        </select>
                    </div>
                    <div class="settings-form-group">
                        <label for="settings-preferences">Предпочтения и аллергии</label>
                        <textarea id="settings-preferences" class="settings-textarea" rows="3" placeholder="Например: без рыбы, меньше жареного"></textarea>
                    </div>
                    <button class="primary-button" id="save-settings-btn">Сохранить и применить</button>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Состав семьи</h3>
                    <div id="family-members-container"></div>
                    <button class="secondary-button" id="add-family-member-btn" style="height: 45px; font-size: 16px;">+ Добавить члена семьи</button>
                </div>
                
                 <div class="settings-section">
                    <h3 class="settings-title">Синхронизация</h3>
                    <div class="settings-form-group">
                        <label for="settings-jsonbin-bin-id">JSONBin.io Bin ID</label>
                        <input type="text" id="settings-jsonbin-bin-id" class="settings-input" placeholder="ID вашего хранилища">
                    </div>
                    <div class="settings-form-group">
                        <label for="settings-jsonbin-api-key">JSONBin.io X-Master-Key</label>
                        <input type="password" id="settings-jsonbin-api-key" class="settings-input" placeholder="Ключ доступа к хранилищу">
                    </div>
                    <button class="primary-button" id="save-sync-settings-btn">Проверить и сохранить</button>
                    <a href="#" id="jsonbin-help-link-settings" class="api-key-help-link" style="margin-top: 15px;">Где взять эти ключи?</a>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Управление данными</h3>
                    <button class="secondary-button" id="share-qr-btn">📲 Поделиться через QR</button>
                    <button class="primary-button" id="export-btn" style="margin-top: 10px;">📤 Экспортировать в файл</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                    <button class="primary-button" id="import-btn" style="margin-top: 10px;">📥 Импортировать из файла</button>
                     <button class="secondary-button" id="run-wizard-btn" style="margin-top: 20px; height: 45px; font-size: 16px;">Запустить мастер настройки</button>
                    <button class="primary-button" id="regenerate-all-btn" style="margin-top: 10px;">🔄 Перегенерировать всё меню</button>
                </div>
                
                 <div class="settings-section">
                    <h3 class="settings-title">API-ключ</h3>
                    <div class="settings-form-group">
                        <label for="settings-api-key">Google Gemini API Key</label>
                        <input type="password" id="settings-api-key" class="settings-input" placeholder="Введите ваш ключ">
                    </div>
                    <button class="primary-button" id="save-api-key-btn">Проверить и сохранить</button>
                </div>


                <div class="settings-section">
                    <h3 class="settings-title">Уведомления и PWA</h3>
                     <button class="secondary-button" id="enable-notifications-btn" style="margin-top: 10px;">🔔 Включить уведомления</button>
                    <div class="install-instructions" style="margin-top: 15px;">
                        <span class="install-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.5V3M7.5 7.5L12 3l4.5 4.5M18 13.5v5.25c0 .93-.75 1.68-1.68 1.68H7.68c-.93 0-1.68-.75-1.68-1.68v-5.25"/></svg>
                        </span>
                        <div class="install-text">Нажмите "Поделиться" в браузере, а затем выберите "На экран 'Домой'", чтобы использовать приложение как нативное.</div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">О приложении</h3>
                    <p id="app-version-info" style="color: var(--soft-text); font-size: 14px; margin-bottom: 15px;"></p>
                    <button class="secondary-button" id="show-changelog-btn" style="height: 45px; font-size: 16px;">История изменений</button>
                    <div class="sync-info" style="margin-top: 15px;">
                        Автор: Климов Евгений<br>
                        <a href="https://t.me/eklimov" target="_blank">Связаться в Telegram</a>
                    </div>
                </div>
            </div>
        </div>
        <nav class="bottom-nav">
            <button class="nav-button active" data-content="menu-content" data-title="Меню на неделю">
                <svg viewBox="0 0 24 24"><path d="M10.5 3.5L3 11c-1.3 1.3-1.3 3.4 0 4.7l7.5 7.5c1.3 1.3 3.4 1.3 4.7 0l7.5-7.5c1.3-1.3 1.3-3.4 0-4.7L15.2 3.5c-1.3-1.3-3.4-1.3-4.7 0zM14 19l-4-4 4-4"/></svg>
                Меню
            </button>
            <button class="nav-button" data-content="shopping-list-content" data-title="Список покупок">
                <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                Покупки
            </button>
            <button class="nav-button" data-content="budget-content" data-title="Бюджет">
                 <svg viewBox="0 0 24 24"><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>
                Бюджет
            </button>
            <button class="nav-button" data-content="settings-content" data-title="Настройки">
                <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                Настройки
            </button>
        </nav>
    </div>

    <!-- Экран рецепта -->
    <div class="screen hidden" id="recipe-screen">
        <header class="recipe-header">
            <button class="back-button" id="back-to-menu-btn">◀︎ Назад</button>
            <h2 id="recipe-title"></h2>
            <span id="step-indicator"></span>
        </header>
        <div id="recipe-content">
            <img id="step-image" src="" alt="Изображение шага">
            <p id="step-description"></p>
            <div class="timer-container hidden" id="timer-section">
                <div id="timer-display">00:00</div>
                <div class="timer-controls">
                    <button class="timer-button" id="start-timer-btn">▶️ Запустить</button>
                    <button class="timer-button" id="pause-timer-btn">⏸️ Пауза</button>
                    <button class="timer-button" id="reset-timer-btn">♻️ Сброс</button>
                </div>
            </div>
            <h3 id="step-ingredients-title">Ингредиенты на этом шаге:</h3>
            <ul id="step-ingredients"></ul>
            <div class="recipe-nav">
                <button class="nav-btn-recipe" id="prev-step-btn">← Назад</button>
                <button class="nav-btn-recipe" id="next-step-btn">Далее →</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно -->
    <div id="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title"></h3>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>

    <!-- QR Scanner -->
    <div id="qr-scanner-overlay" class="hidden">
        <video id="qr-video" playsinline></video>
        <canvas id="qr-canvas"></canvas>
        <p style="margin-top: 20px;">Наведите камеру на QR-код</p>
        <button id="cancel-scan-btn" class="secondary-button" style="width: 80%; max-width: 300px; margin-top: 20px;">Отмена</button>
    </div>
    
    <!-- Консоль разработчика -->
    <div id="dev-console">
        <div id="log-output"></div>
        <input type="text" id="command-input" placeholder="Введите команду...">
    </div>

    <!-- Уведомление -->
    <div id="notification"></div>
</div>

<audio id="notification-sound" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YU9vT18="></audio>

<script type="module">
import { GoogleGenAI, Type } from "https://esm.run/@google/genai";
import qrcode from 'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/+esm'


const app = {
    version: '1.4.0',
    changelog: {
        '1.4.0': [
            'Добавлена онлайн-синхронизация данных в реальном времени через JSONBin.',
            'Обновлен QR-код для передачи настроек синхронизации.',
            'Исправлена ошибка с отображением иконки PWA на iPhone.',
            'Переработан дизайн и анимация заставки, добавлена кнопка "Начать".',
            'Исправлена критическая ошибка, препятствовавшая запуску приложения.',
        ],
        '1.3.1': [
            'Восстановлена и автоматизирована анимированная заставка при запуске.',
            'Обновлены иконки "Меню" и "Настройки" на более стильные и интуитивные.',
            'Добавлена функция отмены покупки товара с диалогом подтверждения.',
            'Купленные товары теперь автоматически перемещаются в конец списка.',
        ],
        '1.3.0': [
            'Добавлена синхронизация настроек и данных через QR-код.',
            'Приложение теперь работает офлайн благодаря Service Worker.',
            'Реализованы системные уведомления для таймера.',
        ],
    },
    state: {
        settings: {
            geminiApiKey: null,
            jsonBin: {
                enabled: false,
                apiKey: null,
                binId: null,
            },
            family: [],
            preferences: "Без рыбы, без грибов",
            menuDuration: 7,
            totalBudget: 10000,
            cuisine: "Любая",
            difficulty: "Любая",
        },
        menu: [],
        recipes: {},
        shoppingList: [],
        cookedMeals: {},
        timestamp: null,
    },
    
    dom: {},
    wizard: {
        currentStep: 1,
        totalSteps: 5,
    },
    currentRecipe: {
        id: null,
        step: 0,
    },
    timer: {
        interval: null,
        timeLeft: 0,
        initialTime: 0,
        isRunning: false,
    },
    qrScanner: {
        stream: null,
        animationFrameId: null,
    },
    sync: {
        timeout: null,
        status: 'idle' // idle, syncing, synced, error
    },
    splashTimeout: null,

    async init() {
        this.cacheDom();
        this.addEventListeners();
        this.registerServiceWorker();
        this.showScreen('splash-screen');

        this.splashTimeout = setTimeout(this.continueInit.bind(this), 5000);
    },
    
    async continueInit() {
        clearTimeout(this.splashTimeout);
        await this.loadState();
        
        const isConfigured = this.state.settings.geminiApiKey && this.state.menu.length > 0;
        if (isConfigured) {
            this.showScreen('main-screen');
        } else if (this.state.settings.jsonBin.enabled) {
            this.showScreen('main-screen');
        }
        else {
            this.showScreen('welcome-screen');
        }
    },


    cacheDom() {
        this.dom = {
            splashScreen: document.getElementById('splash-screen'),
            startAppBtn: document.getElementById('start-app-btn'),
            screens: document.querySelectorAll('.screen'),
            welcomeScreen: document.getElementById('welcome-screen'),
            startSetupWizardBtn: document.getElementById('start-setup-wizard-btn'),
            loadFromFileBtn: document.getElementById('load-from-file-btn'),
            scanQrBtn: document.getElementById('scan-qr-btn'),
            setupScreen: document.getElementById('setup-screen'),
            mainScreen: document.getElementById('main-screen'),
            recipeScreen: document.getElementById('recipe-screen'),
            
            // Wizard
            setupWizard: document.getElementById('setup-wizard'),
            wizardSteps: document.querySelectorAll('.wizard-step'),
            wizardNav: document.getElementById('wizard-nav'),
            wizardBackBtn: document.getElementById('wizard-back-btn'),
            wizardNextBtn: document.getElementById('wizard-next-btn'),
            wizardStepCounter: document.getElementById('wizard-step-counter'),
            apiKeyInput: document.getElementById('api-key-input'),
            apiKeyHelpLink: document.getElementById('api-key-help-link'),
            wizardJsonBinBinId: document.getElementById('wizard-jsonbin-bin-id'),
            wizardJsonBinApiKey: document.getElementById('wizard-jsonbin-api-key'),
            jsonBinHelpLink: document.getElementById('jsonbin-help-link'),
            wizardFamilyContainer: document.getElementById('wizard-family-members-container'),
            wizardAddMemberBtn: document.getElementById('wizard-add-family-member-btn'),
            wizardDuration: document.getElementById('wizard-menu-duration'),
            wizardBudget: document.getElementById('wizard-total-budget'),
            wizardPreferences: document.getElementById('wizard-preferences'),
            wizardCuisine: document.getElementById('wizard-cuisine'),
            wizardDifficulty: document.getElementById('wizard-difficulty'),

            generationProgress: document.getElementById('generation-progress'),
            progressBar: document.getElementById('progress-bar'),
            progressStatus: document.getElementById('progress-status'),
            progressDetails: document.getElementById('progress-details'),
            finishSetupBtn: document.getElementById('finish-setup-btn'),
            
            bottomNav: document.querySelector('.bottom-nav'),
            mainContents: document.querySelectorAll('.main-content'),
            mainHeaderTitle: document.getElementById('main-header-title'),
            syncStatusIndicator: document.getElementById('sync-status-indicator'),
            
            dayScroller: document.getElementById('day-scroller-container'),
            shoppingListContainer: document.getElementById('shopping-list-container'),
            shoppingProgressText: document.getElementById('shopping-progress-text'),
            shoppingProgress: document.getElementById('shopping-progress'),
            shoppingListTotal: document.getElementById('shopping-list-total'),

            backToMenuBtn: document.getElementById('back-to-menu-btn'),
            recipeTitle: document.getElementById('recipe-title'),
            stepIndicator: document.getElementById('step-indicator'),
            stepImage: document.getElementById('step-image'),
            stepDescription: document.getElementById('step-description'),
            timerSection: document.getElementById('timer-section'),
            timerDisplay: document.getElementById('timer-display'),
            startTimerBtn: document.getElementById('start-timer-btn'),
            pauseTimerBtn: document.getElementById('pause-timer-btn'),
            resetTimerBtn: document.getElementById('reset-timer-btn'),
            stepIngredientsList: document.getElementById('step-ingredients'),
            stepIngredientsTitle: document.getElementById('step-ingredients-title'),
            prevStepBtn: document.getElementById('prev-step-btn'),
            nextStepBtn: document.getElementById('next-step-btn'),
            
            budget: {
                pieProducts: document.getElementById('pie-products'),
                spentTotal: document.getElementById('budget-spent-total'),
                total: document.getElementById('budget-total'),
                remaining: document.getElementById('budget-remaining'),
            },

            settings: {
                duration: document.getElementById('settings-menu-duration'),
                budget: document.getElementById('settings-total-budget'),
                preferences: document.getElementById('settings-preferences'),
                cuisine: document.getElementById('settings-cuisine'),
                difficulty: document.getElementById('settings-difficulty'),
                saveBtn: document.getElementById('save-settings-btn'),
                familyContainer: document.getElementById('family-members-container'),
                addMemberBtn: document.getElementById('add-family-member-btn'),
                regenerateAllBtn: document.getElementById('regenerate-all-btn'),
                geminiApiKeyInput: document.getElementById('settings-api-key'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                jsonBinBinId: document.getElementById('settings-jsonbin-bin-id'),
                jsonBinApiKey: document.getElementById('settings-jsonbin-api-key'),
                saveSyncSettingsBtn: document.getElementById('save-sync-settings-btn'),
                jsonBinHelpLinkSettings: document.getElementById('jsonbin-help-link-settings'),
                runWizardBtn: document.getElementById('run-wizard-btn'),
                appVersionInfo: document.getElementById('app-version-info'),
                showChangelogBtn: document.getElementById('show-changelog-btn'),
                enableNotificationsBtn: document.getElementById('enable-notifications-btn'),
            },
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importFileInput: document.getElementById('import-file-input'),
            shareQrBtn: document.getElementById('share-qr-btn'),

            qrScannerOverlay: document.getElementById('qr-scanner-overlay'),
            qrVideo: document.getElementById('qr-video'),
            qrCanvas: document.getElementById('qr-canvas'),
            cancelScanBtn: document.getElementById('cancel-scan-btn'),

            devConsole: document.getElementById('dev-console'),
            logOutput: document.getElementById('log-output'),
            commandInput: document.getElementById('command-input'),

            notification: document.getElementById('notification'),
            notificationSound: document.getElementById('notification-sound'),

            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalButtons: document.getElementById('modal-buttons'),
        };
    },
    
    addEventListeners() {
        this.dom.startAppBtn.addEventListener('click', () => this.continueInit());
        this.dom.startSetupWizardBtn.addEventListener('click', () => this.handleStartSetup());
        this.dom.loadFromFileBtn.addEventListener('click', () => this.dom.importFileInput.click());
        this.dom.scanQrBtn.addEventListener('click', () => this.startQrScanner());
        this.dom.cancelScanBtn.addEventListener('click', () => this.stopQrScanner());

        this.dom.wizardNextBtn.addEventListener('click', () => this.navigateWizard(1));
        this.dom.wizardBackBtn.addEventListener('click', () => this.navigateWizard(-1));
        this.dom.apiKeyHelpLink.addEventListener('click', (e) => {
            e.preventDefault();
            this.showApiKeyHelpModal();
        });
        this.dom.jsonBinHelpLink.addEventListener('click', (e) => {
            e.preventDefault();
            this.showJsonBinHelpModal();
        });
        this.dom.settings.jsonBinHelpLinkSettings.addEventListener('click', (e) => {
             e.preventDefault();
             this.showJsonBinHelpModal();
        });

        this.dom.finishSetupBtn.addEventListener('click', async () => {
            document.getElementById('generation-progress').classList.add('hidden');
            document.getElementById('finish-setup-btn').classList.add('hidden');
            await this.syncDataUp();
            this.showScreen('main-screen');
            this.renderAll();
        });
        this.dom.bottomNav.addEventListener('click', (e) => this.handleNav(e));
        this.dom.backToMenuBtn.addEventListener('click', () => this.showScreen('main-screen'));
        
        this.dom.prevStepBtn.addEventListener('click', () => this.navigateRecipeStep(-1));
        this.dom.nextStepBtn.addEventListener('click', () => this.navigateRecipeStep(1));

        this.dom.startTimerBtn.addEventListener('click', () => this.startTimer());
        this.dom.pauseTimerBtn.addEventListener('click', () => this.pauseTimer());
        this.dom.resetTimerBtn.addEventListener('click', () => this.resetTimer());

        // Settings Listeners
        this.dom.settings.saveBtn.addEventListener('click', () => this.saveSettings());
        this.dom.settings.addMemberBtn.addEventListener('click', () => this.openFamilyMemberModal());
        this.dom.settings.regenerateAllBtn.addEventListener('click', () => this.confirmRegenerateAll());
        this.dom.settings.saveApiKeyBtn.addEventListener('click', () => this.saveApiKey());
        this.dom.settings.saveSyncSettingsBtn.addEventListener('click', () => this.saveSyncSettings());
        this.dom.wizardAddMemberBtn.addEventListener('click', () => this.openFamilyMemberModal(true));
        this.dom.settings.runWizardBtn.addEventListener('click', () => this.showWizard());
        this.dom.settings.showChangelogBtn.addEventListener('click', () => this.showChangelogModal());
        this.dom.settings.enableNotificationsBtn.addEventListener('click', () => this.requestNotificationPermission());

        this.dom.exportBtn.addEventListener('click', () => this.exportData());
        this.dom.importBtn.addEventListener('click', () => this.dom.importFileInput.click());
        this.dom.importFileInput.addEventListener('change', (e) => this.importData(e));
        this.dom.shareQrBtn.addEventListener('click', () => this.showQrCode());

        let longPressTimer;
        document.body.addEventListener('touchstart', e => {
            if (e.touches.length === 3) {
                longPressTimer = setTimeout(() => this.toggleDevConsole(), 1000);
            }
        });
        document.body.addEventListener('touchend', () => clearTimeout(longPressTimer));
        this.dom.commandInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') this.executeCommand(e.target.value);
        });

        this.dom.modalOverlay.addEventListener('click', (e) => {
            if (e.target === this.dom.modalOverlay) {
                this.hideModal();
            }
        });
    },

    async handleStartSetup() {
        if (this.state.settings.geminiApiKey) {
            this.showNotification('Проверка API ключа...', 'loading');
            try {
                this.ai = new GoogleGenAI({ apiKey: this.state.settings.geminiApiKey });
                await this.ai.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
                this.hideNotification();
                if (this.state.menu && this.state.menu.length > 0) {
                     this.showScreen('main-screen');
                     this.renderAll();
                } else {
                    this.showWizard();
                    this.wizard.currentStep = 2; 
                    this.renderWizard();
                }
            } catch (e) {
                this.showNotification('API ключ недействителен. Введите новый.', 'error');
                this.state.settings.geminiApiKey = null; 
                this.saveStateToLocal();
                this.showWizard();
            }
        } else {
            this.showWizard();
        }
    },

    saveStateToLocal() {
        try {
            localStorage.setItem('familyMenuState', JSON.stringify(this.state));
        } catch (e) {
            console.error("Failed to save state to local storage:", e);
        }
    },
    
    async saveState() {
        this.saveStateToLocal();
        await this.syncDataUp();
    },

    async loadState() {
        const localState = localStorage.getItem('familyMenuState');
        if (localState) {
            try {
                this.state = JSON.parse(localState);
                if (!this.state.settings.jsonBin) {
                    this.state.settings.jsonBin = { enabled: false, apiKey: null, binId: null };
                }
            } catch (e) { this.resetState(); }
        }
        
        if (this.state.settings.jsonBin.enabled) {
            await this.syncDataDown();
        }
        
        // Ensure new properties exist for backward compatibility
        if (!this.state.settings.family) this.state.settings.family = [];
        if (!this.state.settings.menuDuration) this.state.settings.menuDuration = 7;
        if (!this.state.cookedMeals) this.state.cookedMeals = {};
        if (!this.state.settings.cuisine) this.state.settings.cuisine = "Любая";
        if (!this.state.settings.difficulty) this.state.settings.difficulty = "Любая";

         if (this.state.shoppingList) {
             this.state.shoppingList.forEach(cat => {
                (cat.items || []).forEach(item => {
                    if (!item.id) item.id = `item-${Date.now()}-${Math.random()}`;
                    if (item.purchases === undefined) item.purchases = item.completed ? [{ qty: item.shoppingSuggestion?.qty || 1, price: item.price }] : [];
                });
             });
         } else {
             this.state.shoppingList = [];
         }
    },

    resetState() {
        localStorage.clear();
        window.location.reload();
    },
    
    showScreen(screenId) {
        this.dom.screens.forEach(screen => {
            const isTarget = screen.id === screenId;
            screen.classList.toggle('hidden', !isTarget);
            if (screen.id === 'recipe-screen' || screen.id === 'splash-screen') {
                screen.classList.toggle('active', isTarget);
            }
        });
        if (screenId === 'main-screen') {
            document.getElementById('main-screen').classList.remove('hidden');
            this.renderAll();
        } else if (screenId === 'setup-screen' || screenId === 'welcome-screen') {
             document.getElementById(screenId).classList.remove('hidden');
        }
    },

    showWizard() {
        this.showScreen('setup-screen');
        this.wizard.currentStep = 1;
        this.renderWizard();
    },

    renderWizard() {
        const { currentStep, totalSteps } = this.wizard;
        
        this.dom.apiKeyInput.value = this.state.settings.geminiApiKey || '';
        this.dom.wizardJsonBinBinId.value = this.state.settings.jsonBin.binId || '';
        this.dom.wizardJsonBinApiKey.value = this.state.settings.jsonBin.apiKey || '';
        this.dom.wizardDuration.value = this.state.settings.menuDuration;
        this.dom.wizardBudget.value = this.state.settings.totalBudget;
        this.dom.wizardPreferences.value = this.state.settings.preferences;
        this.dom.wizardCuisine.value = this.state.settings.cuisine;
        this.dom.wizardDifficulty.value = this.state.settings.difficulty;
        
        this.dom.wizardNav.classList.remove('hidden');
        this.dom.generationProgress.classList.add('hidden');
        this.dom.setupWizard.classList.remove('hidden');
        this.dom.wizardStepCounter.classList.remove('hidden');

        this.dom.wizardStepCounter.textContent = `Шаг ${currentStep} из ${totalSteps}`;

        this.dom.wizardSteps.forEach(step => {
            step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
        });

        this.dom.wizardBackBtn.classList.toggle('hidden', currentStep === 1);
        this.dom.wizardNextBtn.textContent = currentStep === totalSteps ? 'Начать генерацию' : 'Далее';
        
        if (currentStep === 3) {
            this.renderFamilyMembers(true);
        }
    },

    async navigateWizard(direction) {
        const { currentStep, totalSteps } = this.wizard;
        if (direction > 0) {
            if (currentStep === 1) {
                const apiKey = this.dom.apiKeyInput.value.trim();
                if (!apiKey) { this.showNotification('Пожалуйста, введите Gemini API ключ.', 'error'); return; }
                this.state.settings.geminiApiKey = apiKey;
            } else if (currentStep === 2) {
                const binId = this.dom.wizardJsonBinBinId.value.trim();
                const apiKey = this.dom.wizardJsonBinApiKey.value.trim();
                if(binId && apiKey) {
                    this.state.settings.jsonBin = { enabled: true, binId, apiKey };
                }
            } else if (currentStep === 3) {
                if (this.state.settings.family.length === 0) { this.showNotification('Добавьте хотя бы одного члена семьи.', 'error'); return; }
            } else if (currentStep === 4) {
                this.state.settings.menuDuration = parseInt(this.dom.wizardDuration.value) || 7;
                this.state.settings.totalBudget = parseInt(this.dom.wizardBudget.value) || 10000;
                this.state.settings.preferences = this.dom.wizardPreferences.value;
                this.state.settings.cuisine = this.dom.wizardCuisine.value;
                this.state.settings.difficulty = this.dom.wizardDifficulty.value;
            } else if (currentStep === totalSteps) {
                this.saveStateToLocal();
                await this.startGenerationProcess();
                return;
            }
        }
        
        this.wizard.currentStep += direction;
        this.renderWizard();
    },

    async startGenerationProcess(isRegenerating = false, purchasedItems = '') {
        if (!this.state.settings.geminiApiKey) {
            alert('API ключ не найден.');
            this.showWizard();
            return;
        }
        
        this.dom.setupWizard.classList.add('hidden');
        this.dom.wizardNav.classList.add('hidden');
        this.dom.wizardStepCounter.classList.add('hidden');
        this.dom.generationProgress.classList.remove('hidden');
        if (isRegenerating) this.showScreen('setup-screen');
        
        try {
            this.ai = new GoogleGenAI({ apiKey: this.state.settings.geminiApiKey });
            await this.updateProgress(1, 5, "Подключение к Google Gemini…", "Проверка ключа...");
            await this.ai.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
            this.logToConsole('✅ API KEY VALIDATED');
            this.dom.progressDetails.innerHTML += '<br>✅ Ключ активен. Доступ к Gemini получен.';
            
            await this.generateMenu(purchasedItems);
            if (!this.state.menu || this.state.menu.length === 0) {
                throw new Error("Menu generation failed or returned empty data. Please check your prompt and settings.");
            }
            await this.generateRecipes();
            await this.generateShoppingList();
            
            await this.updateProgress(5, 5, "Готово!", "Добро пожаловать в 'СЕМЕЙНОЕ МЕНЮ'.");
            this.dom.finishSetupBtn.classList.remove('hidden');
            this.dom.finishSetupBtn.classList.add('reveal');
            
            this.state.timestamp = new Date().toISOString();
            await this.saveState();

        } catch (error) {
            console.error("Generation failed:", error);
            this.updateProgress(0, 5, "Ошибка!", `Не удалось сгенерировать меню. ${error.message}`);
            this.dom.finishSetupBtn.textContent = 'Назад к настройкам';
            this.dom.finishSetupBtn.classList.remove('hidden');
            this.dom.finishSetupBtn.onclick = () => window.location.reload();
            if(!isRegenerating) {
                this.state.settings.geminiApiKey = null;
                this.saveStateToLocal();
            }
        }
    },
    
    async updateProgress(step, totalSteps, status, details) {
        return new Promise(resolve => {
            const percent = (step / totalSteps) * 100;
            this.dom.progressBar.style.width = `${percent}%`;
            this.dom.progressStatus.textContent = `Шаг ${step}/${totalSteps}: ${status}`;
            this.dom.progressDetails.innerHTML = details;
            setTimeout(resolve, 300);
        });
    },

    async makeGeminiRequest(prompt, jsonSchema) {
        this.logToConsole(`🟡 REQUEST: ${prompt.substring(0, 50)}...`);
        let retries = 3;
        while (retries > 0) {
            try {
                const result = await this.ai.models.generateContent({
                  model: "gemini-2.5-flash",
                  contents: [{ parts: [{ text: prompt }] }],
                  config: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                  }
                });
                const jsonText = result.text.trim();
                const data = JSON.parse(jsonText);
                this.logToConsole(`✅ RESPONSE RECEIVED`);
                return data;
            } catch (error) {
                retries--;
                this.logToConsole(`🔴 ERROR: ${error}. Retrying... (${retries} left)`);
                if (retries === 0) throw error;
                await new Promise(res => setTimeout(res, 1000));
            }
        }
    },

    async generateMenu(purchasedItems = '') {
        const { family, menuDuration, preferences, cuisine, difficulty } = this.state.settings;
        await this.updateProgress(2, 5, "Генерация меню...", `Для вашей семьи на ${menuDuration} дней.`);
        const familyDescription = family.map(p => `${p.gender === 'male' ? 'Мужчина' : 'Женщина'}, ${p.age} лет, активность: ${p.activity}`).join('; ');
        
        let prompt = `Сгенерируй разнообразное и сбалансированное меню на ${menuDuration} дней (с воскресенья по субботу) для семьи: ${familyDescription}. 
        Учти их потребности в калориях.
        Общие предпочтения: ${preferences}.
        Предпочитаемая кухня: ${cuisine}.
        Желаемая сложность блюд: ${difficulty}.
        Каждый день должен включать: Завтрак, Перекус, Обед, Полдник, Ужин. Иногда используй остатки от ужина на обед следующего дня (помечай их как "Название блюда (остатки)").`;
        
        if (purchasedItems) {
            prompt += `\nВАЖНО: При составлении меню отдай приоритет блюдам, в которых используются уже купленные продукты. Список купленных продуктов: ${purchasedItems}.`;
        }

        const schema = {type: Type.ARRAY, items: {type: Type.OBJECT, properties: {day: {type: Type.STRING}, meals: {type: Type.OBJECT, properties: {breakfast: {type: Type.STRING}, snack1: {type: Type.STRING}, lunch: {type: Type.STRING}, snack2: {type: Type.STRING}, dinner: {type: Type.STRING}}, required: ["breakfast", "snack1", "lunch", "snack2", "dinner"]}}, required: ["day", "meals"]}};
        this.state.menu = await this.makeGeminiRequest(prompt, schema);
        this.dom.progressDetails.innerHTML += `<br>✅ Сгенерировано меню.`;
    },
    
    async generateRecipes() {
        await this.updateProgress(3, 5, "Генерация рецептов…", "Создаём пошаговые инструкции...");
        const uniqueMeals = [...new Set(this.state.menu.flatMap(d => Object.values(d.meals)))].filter(name => name && !name.includes("(остатки)"));
        if (uniqueMeals.length === 0) {
             this.dom.progressDetails.innerHTML += `<br>⚠️ Не найдено новых блюд для генерации рецептов.`;
             return;
        }
        const familySize = this.state.settings.family.length;
        const schema = {type: Type.OBJECT, properties: {id: {type: Type.STRING}, name: {type: Type.STRING}, ingredients: {type: Type.ARRAY, items: {type: Type.OBJECT, properties: {name: {type: Type.STRING}, quantity: {type: Type.STRING}}, required: ["name", "quantity"]}}, steps: {type: Type.ARRAY, items: {type: Type.OBJECT, properties: {description: {type: Type.STRING}, time: {type: Type.NUMBER, description: "Время в минутах. 0 если таймер не нужен."}, ingredients: {type: Type.ARRAY, items: {type: Type.OBJECT, properties: { name: {type: Type.STRING}, quantity: {type: Type.STRING, description: "Количество и единица измерения, например '200 г' или '1 шт'"} }, required: ["name", "quantity"] }}}, required: ["description", "time", "ingredients"]}}}, required: ["id", "name", "ingredients", "steps"]};
        
        this.state.recipes = {};
        for (const mealName of uniqueMeals) {
            this.dom.progressDetails.textContent = `Обрабатывается: "${mealName}"...`;
            const prompt = `Создай детальный рецепт для блюда "${mealName}" для семьи из ${familySize} человек (${this.state.settings.family.length} порции). В каждом шаге укажи конкретное количество ингредиентов, используемых на этом шаге.`;
            const recipeData = await this.makeGeminiRequest(prompt, schema);
            this.state.recipes[recipeData.id] = recipeData;
        }
        this.dom.progressDetails.innerHTML += `<br>✅ Все ${uniqueMeals.length} рецептов сгенерированы.`;
    },

    async generateShoppingList() {
        await this.updateProgress(4, 5, "Формирование списка покупок…", "Собираем все ингредиенты...");
        if (Object.keys(this.state.recipes).length === 0) {
            this.dom.progressDetails.innerHTML += `<br>⚠️ Нет рецептов для создания списка покупок.`;
            this.state.shoppingList = [];
            return;
        }
        const allIngredients = Object.values(this.state.recipes).flatMap(r => r.ingredients);
        const prompt = `Сгруппируй и суммируй этот список ингредиентов. Категории: "Мясо и птица", "Молочные и яйца", "Овощи и зелень", "Фрукты и орехи", "Бакалея", "Хлеб и выпечка", "Напитки", "Прочее". Для каждого ингредиента верни общее необходимое количество (totalNeeded). Затем предложи разумное количество для покупки в магазине (shoppingSuggestion), округляя в большую сторону до стандартной упаковки (например, для 750г муки предложи купить 1кг). Укажи примерную цену в рублях за предложенное количество для покупки. Ингредиенты: ${JSON.stringify(allIngredients)}`;
        const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { category: { type: Type.STRING }, items: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { name: { type: Type.STRING }, totalNeeded: { type: Type.OBJECT, properties: { qty: { type: Type.NUMBER }, unit: { type: Type.STRING }}}, shoppingSuggestion: { type: Type.OBJECT, properties: { qty: { type: Type.NUMBER }, unit: { type: Type.STRING }}}, price: { type: Type.NUMBER } }, required: ["name", "totalNeeded", "shoppingSuggestion", "price"] } } }, required: ["category", "items"] } };
        const shoppingListData = await this.makeGeminiRequest(prompt, schema);
        
        shoppingListData.forEach(category => {
            category.items.forEach(item => {
                item.id = `item-${Date.now()}-${Math.random()}`;
                item.purchases = [];
            });
        });
        
        this.state.shoppingList = shoppingListData;
        const totalCost = shoppingListData.flatMap(c => c.items).reduce((sum, item) => sum + item.price, 0);
        this.dom.progressDetails.innerHTML += `<br>✅ Список из ${shoppingListData.flatMap(c => c.items).length} продуктов сгруппирован. Итого: ${totalCost} ₽`;
    },
    
    renderAll() {
        this.renderSettings();
        this.renderMenu();
        this.renderShoppingList();
        this.renderBudget();
    },

    renderMenu() {
        if (!this.state.menu || this.state.menu.length === 0) return;
        this.dom.dayScroller.innerHTML = '';
        const daysOrder = ["ВОСКРЕСЕНЬЕ", "ПОНЕДЕЛЬНИК", "ВТОРНИК", "СРЕДА", "ЧЕТВЕРГ", "ПЯТНИЦА", "СУББОТА"];
        
        const validMenuData = this.state.menu.filter(day => day && day.day && day.meals);
        
        const sortedMenu = [...validMenuData].sort((a, b) => {
            return daysOrder.indexOf(a.day.toUpperCase()) - daysOrder.indexOf(b.day.toUpperCase());
        });
        
        sortedMenu.forEach((dayData) => {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            
            const mealHtml = (icon, mealName, mealKey, dayName) => {
                const cleanName = (mealName || 'Не указано').replace(/\s*\(остатки\)/i, '');
                const isLeftover = (mealName || '').includes('(остатки)');
                const hasContent = mealName && mealName.trim() !== '' && mealName.trim() !== 'Не указано';
                const hasRecipe = !isLeftover && hasContent;
                const isCooked = this.state.cookedMeals[dayName] && this.state.cookedMeals[dayName].includes(mealKey);
                
                return `
                <div class="meal ${hasRecipe ? 'clickable' : ''} ${isCooked ? 'cooked' : ''}" data-meal-name="${mealName || ''}" data-meal-key="${mealKey}" data-day-name="${dayName}">
                    <button class="cooked-toggle" data-day-name="${dayName}" data-meal-key="${mealKey}" aria-label="Отметить как приготовленное">
                        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </button>
                    <span class="meal-icon">${icon}</span>
                    <span class="meal-name">${cleanName}</span>
                    ${isLeftover ? '<span class="leftover-icon">🔄</span>' : ''}
                    ${hasContent ? `<button class="regenerate-btn" title="Перегенерировать блюдо">🔄</button>` : ''}
                </div>`;
            };

            dayCard.innerHTML = `
                <div class="day-title-container">
                    <h3 class="day-title">${dayData.day}</h3>
                    <button class="regenerate-btn" data-day-name="${dayData.day}" title="Перегенерировать день">🔄</button>
                </div>
                ${mealHtml('☀️', dayData.meals.breakfast, 'breakfast', dayData.day)}
                ${mealHtml('🍎', dayData.meals.snack1, 'snack1', dayData.day)}
                ${mealHtml('🍲', dayData.meals.lunch, 'lunch', dayData.day)}
                ${mealHtml('🥛', dayData.meals.snack2, 'snack2', dayData.day)}
                ${mealHtml('🌙', dayData.meals.dinner, 'dinner', dayData.day)}
            `;
            
            dayCard.querySelectorAll('.meal.clickable').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target.closest('.regenerate-btn') || e.target.closest('.cooked-toggle')) return;
                    const mealName = e.currentTarget.dataset.mealName.replace(/\s*\(остатки\)/i, '').trim();
                    const recipe = Object.values(this.state.recipes).find(r => r.name === mealName);
                    if (recipe) {
                        this.checkIngredientsForRecipe(recipe.id);
                    } else if (mealName) {
                        this.showNotification(`Рецепт для "${mealName}" не найден.`, 'error');
                    }
                });
            });

            dayCard.querySelectorAll('.cooked-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent opening recipe view
                    const { dayName, mealKey } = e.currentTarget.dataset;
                    this.toggleCookedStatus(dayName, mealKey);
                });
            });

            dayCard.querySelectorAll('.regenerate-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const el = e.currentTarget;
                    const dayName = el.dataset.dayName || el.closest('.meal')?.dataset.dayName;
                    const mealKey = el.closest('.meal')?.dataset.mealKey;
                    if (mealKey) {
                        this.openRegenerateModal('meal', { dayName, mealKey });
                    } else {
                        this.openRegenerateModal('day', { dayName });
                    }
                });
            });
            this.dom.dayScroller.appendChild(dayCard);
        });
    },

    toggleCookedStatus(dayName, mealKey) {
        if (!this.state.cookedMeals[dayName]) {
            this.state.cookedMeals[dayName] = [];
        }
        const mealIndex = this.state.cookedMeals[dayName].indexOf(mealKey);
        if (mealIndex > -1) {
            this.state.cookedMeals[dayName].splice(mealIndex, 1);
        } else {
            this.state.cookedMeals[dayName].push(mealKey);
        }
        this.saveState();
        this.renderMenu(); // Re-render to update the view
    },

    renderShoppingList() {
        if (!this.state.shoppingList) return;
        this.dom.shoppingListContainer.innerHTML = '';
        
        this.state.shoppingList.forEach((category) => {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category-group';

            const sortedItems = [...category.items].sort((a, b) => {
                const isACompleted = (a.purchases || []).reduce((s, p) => s + p.qty, 0) >= a.shoppingSuggestion.qty;
                const isBCompleted = (b.purchases || []).reduce((s, p) => s + p.qty, 0) >= b.shoppingSuggestion.qty;
                if (isACompleted === isBCompleted) return 0;
                return isACompleted ? 1 : -1;
            });
            
            const itemsHtml = sortedItems.map((item) => {
                const totalPurchased = (item.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                const isCompleted = totalPurchased >= item.shoppingSuggestion.qty;
                const progressPercent = Math.min((totalPurchased / item.shoppingSuggestion.qty) * 100, 100);

                const radius = 10;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (progressPercent / 100) * circumference;

                return `
                <li class="shopping-item ${isCompleted ? 'completed' : ''}" data-item-id="${item.id}">
                    <div class="item-checkbox-progress">
                        <svg viewBox="0 0 24 24">
                          <circle class="bg" cx="12" cy="12" r="${radius}"></circle>
                          <circle class="progress" cx="12" cy="12" r="${radius}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
                        </svg>
                        <span class="checkmark">✔</span>
                    </div>
                    <div class="item-details">
                        <span class="item-name">${item.name}</span>
                        <div class="item-quantity">Купить: ${item.shoppingSuggestion.qty.toLocaleString()} ${item.shoppingSuggestion.unit}</div>
                    </div>
                    <span class="item-price">${item.price} ₽</span>
                </li>
            `}).join('');
            
            categoryElement.innerHTML = `
                <button class="category-toggle">${category.category} ▼</button>
                <ul class="category-items">${itemsHtml}</ul>
            `;
            this.dom.shoppingListContainer.appendChild(categoryElement);
        });
        
        this.dom.shoppingListContainer.querySelectorAll('.shopping-item').forEach(itemEl => {
            itemEl.addEventListener('click', (e) => {
                const { itemId } = e.currentTarget.dataset;
                
                let foundItem, catIndex, itemIndex;
                for (let i = 0; i < this.state.shoppingList.length; i++) {
                    const foundIdx = this.state.shoppingList[i].items.findIndex(it => it.id === itemId);
                    if (foundIdx !== -1) {
                        foundItem = this.state.shoppingList[i].items[foundIdx];
                        catIndex = i;
                        itemIndex = foundIdx;
                        break;
                    }
                }

                if (foundItem) {
                    const totalPurchased = (foundItem.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                    const isCompleted = totalPurchased >= foundItem.shoppingSuggestion.qty;

                    if (isCompleted) {
                        this.openUndoPurchaseModal(catIndex, itemIndex);
                    } else {
                        this.openPurchaseModal(catIndex, itemIndex);
                    }
                }
            });
        });
        
        this.dom.shoppingListContainer.querySelectorAll('.category-toggle').forEach(button => {
            button.addEventListener('click', e => {
                const list = e.target.nextElementSibling;
                list.classList.toggle('collapsed');
                e.target.innerHTML = list.classList.contains('collapsed') ? e.target.innerHTML.replace('▼', '▶') : e.target.innerHTML.replace('▶', '▼');
            });
        });

        this.updateShoppingProgress();
        const estimatedCost = this.state.shoppingList.flatMap(c => c.items).reduce((sum, item) => sum + (item.price || 0), 0);
        this.dom.shoppingListTotal.innerHTML = `<span>Примерная сумма:</span> ${estimatedCost.toLocaleString('ru-RU')} ₽`;
    },

    updateShoppingProgress() {
        if (!this.state.shoppingList) return;
        const allItems = this.state.shoppingList.flatMap(c => c.items || []);
        if (allItems.length === 0) return;
        const totalItems = allItems.length;
        const completedItems = allItems.filter(i => {
            const totalPurchased = (i.purchases || []).reduce((sum, p) => sum + p.qty, 0);
            return totalPurchased >= i.shoppingSuggestion.qty;
        }).length;
        const percent = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
        this.dom.shoppingProgress.style.width = `${percent}%`;
        this.dom.shoppingProgressText.textContent = `${completedItems}/${totalItems} куплено`;
    },

    renderBudget() {
        const totalBudget = this.state.settings.totalBudget;
        const spentOnProducts = this.state.shoppingList
            .flatMap(c => c.items || [])
            .flatMap(item => item.purchases || [])
            .reduce((sum, purchase) => sum + purchase.price, 0);

        const remaining = totalBudget - spentOnProducts;
        const spentPercent = totalBudget > 0 ? (spentOnProducts / totalBudget) * 100 : 0;
        
        this.dom.budget.pieProducts.style.strokeDasharray = `${spentPercent} 100`;
        this.dom.budget.spentTotal.innerHTML = `${spentOnProducts.toLocaleString('ru-RU')} ₽ <span>потрачено</span>`;
        this.dom.budget.total.textContent = `${totalBudget.toLocaleString('ru-RU')} ₽`;
        this.dom.budget.remaining.textContent = `${remaining.toLocaleString('ru-RU')} ₽`;
        this.dom.budget.remaining.className = `amount ${remaining >= 0 ? 'ok' : 'warning'}`;
    },
    
    checkIngredientsForRecipe(recipeId) {
        const recipe = this.state.recipes[recipeId];
        if (!recipe || !recipe.ingredients) {
            this.showRecipe(recipeId);
            return;
        }

        const flatShoppingList = this.state.shoppingList.flatMap(c => c.items);
        const missingIngredients = [];

        recipe.ingredients.forEach(ing => {
            const shopItem = flatShoppingList.find(item => item.name.toLowerCase() === ing.name.toLowerCase());
            if (shopItem) {
                 const totalPurchased = (shopItem.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                 if (totalPurchased < shopItem.totalNeeded.qty) {
                     missingIngredients.push(shopItem);
                 }
            } else {
                missingIngredients.push({name: ing.name, shoppingSuggestion: {qty: 1, unit: 'шт'}});
            }
        });

        if (missingIngredients.length > 0) {
            this.showMissingIngredientsWarning(missingIngredients, recipeId);
        } else {
            this.showRecipe(recipeId);
        }
    },
    
    showRecipe(recipeId) {
        this.currentRecipe.id = recipeId;
        this.currentRecipe.step = 0;
        const recipe = this.state.recipes[recipeId];
        if (!recipe) {
            this.showNotification(`Не удалось найти рецепт с ID: ${recipeId}.`, 'error');
            return;
        }
        this.showScreen('recipe-screen');
        this.renderRecipeStep();
    },

    renderRecipeStep() {
        const { id, step } = this.currentRecipe;
        const recipe = this.state.recipes[id];
        if (!recipe || !recipe.steps || !recipe.steps[step]) {
            console.error('Invalid recipe or step:', id, step);
            this.showNotification('Ошибка при загрузке рецепта.', 'error');
            this.showScreen('main-screen');
            return;
        }

        const stepData = recipe.steps[step];

        this.dom.recipeTitle.textContent = recipe.name;
        this.dom.stepIndicator.textContent = `Шаг ${step + 1}/${recipe.steps.length}`;
        this.dom.stepDescription.textContent = stepData.description;

        this.dom.stepImage.style.opacity = '0.5';
        if (stepData.imageUrl) {
            this.dom.stepImage.src = stepData.imageUrl;
            this.dom.stepImage.alt = stepData.description;
            this.dom.stepImage.style.opacity = '1';
        } else {
            this.dom.stepImage.src = ''; 
            this.dom.stepImage.alt = 'Генерация изображения...';
            this.generateStepImage(id, step);
        }

        this.stopTimer();
        if (stepData.time && stepData.time > 0) {
            this.timer.initialTime = stepData.time * 60;
            this.resetTimer();
            this.dom.timerSection.classList.remove('hidden');
        } else {
            this.dom.timerSection.classList.add('hidden');
        }

        this.dom.stepIngredientsList.innerHTML = '';
        if (stepData.ingredients && stepData.ingredients.length > 0) {
            this.dom.stepIngredientsTitle.classList.remove('hidden');
            const flatShoppingList = this.state.shoppingList.flatMap(c => c.items);
            stepData.ingredients.forEach(ing => {
                const li = document.createElement('li');
                const shopItem = flatShoppingList.find(item => item.name.toLowerCase().includes(ing.name.toLowerCase()) || ing.name.toLowerCase().includes(item.name.toLowerCase()));
                let statusClass = 'unknown';
                let statusIcon = '❔';
                if (shopItem) {
                    const totalPurchased = (shopItem.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                    if (totalPurchased >= shopItem.totalNeeded.qty) {
                        statusClass = 'completed';
                        statusIcon = '✅';
                    } else {
                        statusClass = 'missing';
                        statusIcon = '⚠️';
                    }
                }
                li.innerHTML = `<span><span class="ingredient-status ${statusClass}">${statusIcon}</span> ${ing.name}</span> <span class="ingredient-quantity">${ing.quantity}</span>`;
                this.dom.stepIngredientsList.appendChild(li);
            });
        } else {
            this.dom.stepIngredientsTitle.classList.add('hidden');
        }

        this.dom.prevStepBtn.disabled = step === 0;
        this.dom.nextStepBtn.textContent = (step === recipe.steps.length - 1) ? 'Завершить ✅' : 'Далее →';
    },

    async generateStepImage(recipeId, stepIndex) {
        if (!this.ai) return;
        try {
            const recipe = this.state.recipes[recipeId];
            const stepDescription = recipe.steps[stepIndex].description;
            const prompt = `Food photography, realistic, high-detail photo of a cooking step: "${stepDescription}"`;
            
            const response = await this.ai.models.generateImages({
                model: 'imagen-4.0-generate-001',
                prompt: prompt,
                config: {
                  numberOfImages: 1,
                  outputMimeType: 'image/jpeg',
                  aspectRatio: '4:3',
                },
            });

            const base64ImageBytes = response.generatedImages[0].image.imageBytes;
            const imageUrl = `data:image/jpeg;base64,${base64ImageBytes}`;

            if (this.currentRecipe.id === recipeId && this.currentRecipe.step === stepIndex) {
                this.dom.stepImage.src = imageUrl;
                this.dom.stepImage.style.opacity = '1';
            }
            this.state.recipes[recipeId].steps[stepIndex].imageUrl = imageUrl;
            this.saveState();
        } catch (error) {
            console.error("Image generation failed:", error);
            if (this.currentRecipe.id === recipeId && this.currentRecipe.step === stepIndex) {
               this.dom.stepImage.alt = 'Не удалось загрузить изображение';
            }
        }
    },

    navigateRecipeStep(direction) {
        const { id, step } = this.currentRecipe;
        const recipe = this.state.recipes[id];
        
        if (direction > 0 && step === recipe.steps.length - 1) {
            this.finishCooking();
            return;
        }
        
        const newStep = step + direction;
        if (newStep >= 0 && newStep < recipe.steps.length) {
            this.currentRecipe.step = newStep;
            this.renderRecipeStep();
        }
    },

    finishCooking() {
        const { id } = this.currentRecipe;
        const recipe = this.state.recipes[id];

        let mealInfo = null;
        for (const day of this.state.menu) {
            for (const mealKey in day.meals) {
                const mealName = (day.meals[mealKey] || '').replace(/\s*\(остатки\)/i, '').trim();
                if (mealName === recipe.name) {
                    mealInfo = { dayName: day.day, mealKey: mealKey };
                    break;
                }
            }
            if (mealInfo) break;
        }

        if (mealInfo) {
            const { dayName, mealKey } = mealInfo;
            if (!this.state.cookedMeals[dayName]) {
                this.state.cookedMeals[dayName] = [];
            }
            if (!this.state.cookedMeals[dayName].includes(mealKey)) {
                this.state.cookedMeals[dayName].push(mealKey);
                this.saveState();
            }
        }
        
        this.showNotification(`"${recipe.name}" приготовлено!`, 'success');
        this.showScreen('main-screen');
    },

    startTimer() {
        if (this.timer.isRunning || this.timer.timeLeft <= 0) return;
        this.timer.isRunning = true;
        this.timer.interval = setInterval(() => {
            this.timer.timeLeft--;
            this.updateTimerDisplay();
            if (this.timer.timeLeft <= 0) {
                this.stopTimer(true); // finished
            }
        }, 1000);
    },

    pauseTimer() {
        this.timer.isRunning = false;
        clearInterval(this.timer.interval);
    },
    
    stopTimer(finished = false) {
        this.pauseTimer();
        if (finished) {
            this.dom.timerDisplay.textContent = "Готово!";
            this.showSystemNotification("Таймер завершен!", `Можно переходить к следующему шагу приготовления.`);
            this.dom.notificationSound.play().catch(e => console.log("Audio play failed", e));
        }
    },

    resetTimer() {
        this.stopTimer();
        this.timer.timeLeft = this.timer.initialTime;
        this.updateTimerDisplay();
    },

    updateTimerDisplay() {
        const minutes = Math.floor(this.timer.timeLeft / 60);
        const seconds = this.timer.timeLeft % 60;
        this.dom.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    },
    
    handleNav(e) {
        const button = e.target.closest('.nav-button');
        if (!button) return;
        
        this.dom.bottomNav.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        const contentId = button.dataset.content;
        this.dom.mainHeaderTitle.textContent = button.dataset.title;
        this.dom.mainContents.forEach(content => {
            content.classList.toggle('active', content.id === contentId);
        });
        if (contentId === 'settings-content') this.renderSettings();
    },

    showNotification(message, type = 'success') {
        this.dom.notification.textContent = message;
        this.dom.notification.className = type; // success, loading, error
        this.dom.notification.classList.add('show');

        if (type !== 'loading') {
            setTimeout(() => {
                this.dom.notification.classList.remove('show');
            }, 3000);
        }
    },

    hideNotification() {
        this.dom.notification.classList.remove('show');
    },

    showModal(title, bodyHtml, buttons) {
        this.dom.modalTitle.textContent = title;
        this.dom.modalBody.innerHTML = bodyHtml;
        this.dom.modalButtons.innerHTML = '';
        buttons.forEach(btn => {
            const buttonEl = document.createElement('button');
            buttonEl.textContent = btn.text;
            buttonEl.className = `modal-button ${btn.class}`;
            buttonEl.addEventListener('click', () => {
                btn.action();
                if (btn.closes !== false) this.hideModal();
            });
            this.dom.modalButtons.appendChild(buttonEl);
        });
        this.dom.modalOverlay.classList.add('visible');
    },

    hideModal() {
        this.dom.modalOverlay.classList.remove('visible');
    },

    showApiKeyHelpModal() {
        // ... (same as before)
    },

    openPurchaseModal(catIndex, itemIndex) {
        // ... (same as before)
    },

    openUndoPurchaseModal(catIndex, itemIndex) {
        // ... (same as before)
    },

    async shareMissingItems(missingItems) {
        // ... (same as before)
    },

    showMissingIngredientsWarning(missingItems, recipeId) {
        // ... (same as before)
    },

    // SETTINGS LOGIC
    renderSettings() {
        const s = this.state.settings;
        this.dom.settings.duration.value = s.menuDuration;
        this.dom.settings.budget.value = s.totalBudget;
        this.dom.settings.preferences.value = s.preferences;
        this.dom.settings.cuisine.value = s.cuisine;
        this.dom.settings.difficulty.value = s.difficulty;
        this.dom.settings.geminiApiKeyInput.value = s.geminiApiKey || '';
        this.dom.settings.jsonBinBinId.value = s.jsonBin.binId || '';
        this.dom.settings.jsonBinApiKey.value = s.jsonBin.apiKey || '';
        this.dom.settings.appVersionInfo.textContent = `Версия приложения: ${this.version}`;
        this.renderFamilyMembers();
    },
    saveSettings() {
        const s = this.state.settings;
        s.menuDuration = parseInt(this.dom.settings.duration.value) || 7;
        s.totalBudget = parseInt(this.dom.settings.budget.value) || 10000;
        s.preferences = this.dom.settings.preferences.value;
        s.cuisine = this.dom.settings.cuisine.value;
        s.difficulty = this.dom.settings.difficulty.value;
        this.saveState();
        this.renderBudget(); 
        this.showNotification("Настройки сохранены. Чтобы они применились, перегенерируйте меню.");
    },
    async saveApiKey() {
        const newApiKey = this.dom.settings.geminiApiKeyInput.value.trim();
        if (!newApiKey) { this.showNotification('API ключ не может быть пустым', 'error'); return; }
        this.showNotification('Проверка ключа...', 'loading');
        try {
            const testAI = new GoogleGenAI({ apiKey: newApiKey });
            await testAI.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
            
            this.state.settings.geminiApiKey = newApiKey;
            this.ai = testAI; 
            this.saveState();
            this.showNotification('API ключ успешно сохранен и проверен!');
        } catch (error) {
            console.error("API Key validation failed:", error);
            this.showNotification('Неверный API ключ. Проверьте его и попробуйте снова.', 'error');
        }
    },
    renderFamilyMembers(isWizard = false) {
        // ... (same as before)
    },
    openFamilyMemberModal(isWizard = false) {
       // ... (same as before)
    },
    confirmRegenerateAll() {
        // ... (same as before, but calls saveState at the end)
    },
    showChangelogModal() {
        // ... (same as before)
    },
    
    // REGENERATION
    openRegenerateModal(type, data) {
       // ... (same as before)
    },

    async handleRegeneration(type, data) {
        this.hideModal();
        this.showNotification("Обновляем меню...", 'loading');
        
        try {
            if (type === 'meal') {
                 // ... meal regen logic
            } else { // regenerate day
                await this.generateMenu();
            }
            
            await this.generateRecipes();
            await this.generateShoppingList();

            this.saveState();
            this.renderAll();
            this.showNotification("Меню успешно обновлено!");

        } catch(e) {
            this.showNotification("Ошибка при обновлении.", 'error');
            console.error(e);
        }
    },


    exportData() {
        const exportState = {...this.state};
        // Do not export sync credentials in file exports
        delete exportState.settings.jsonBin;
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportState));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `family_menu_backup_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        this.showNotification("Данные экспортированы!");
    },
    importData(event, isQr=false, qrData=null) {
        const importLogic = (dataString) => {
             try {
                const importedData = JSON.parse(dataString);

                // Check if it's a sync QR code
                if (importedData.syncCredentials) {
                    this.state.settings.jsonBin = {
                        enabled: true,
                        apiKey: importedData.syncCredentials.apiKey,
                        binId: importedData.syncCredentials.binId
                    };
                    this.showNotification("Настройки синхронизации получены!", "success");
                    this.saveStateToLocal();
                    this.continueInit(); // Reload data from new source
                    return;
                }

                // Standard file import
                if (importedData.settings && importedData.menu && importedData.recipes) {
                    this.showModal("Подтверждение импорта", 
                        "<p>Вы уверены, что хотите импортировать эти данные? Все текущие данные будут перезаписаны.</p>",
                        [
                            { text: "Отмена", class: "secondary", action: () => {} },
                            { text: "Импортировать", class: "primary", action: async () => {
                                this.state = importedData;
                                if (!this.state.settings.jsonBin) {
                                     this.state.settings.jsonBin = { enabled: false, apiKey: null, binId: null };
                                }
                                await this.saveState();
                                this.showNotification("Данные успешно импортированы!");
                                this.showScreen('main-screen');
                                this.renderAll();
                            }}
                        ]
                    );
                } else {
                    throw new Error("Invalid file format");
                }
            } catch (error) {
                this.showNotification("Ошибка импорта: неверный формат данных.", 'error');
            }
        };

        if (isQr) {
            importLogic(qrData);
        } else {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                importLogic(e.target.result);
                event.target.value = '';
            };
            reader.readAsText(file);
        }
    },

    showQrCode() {
        try {
            const { enabled, apiKey, binId } = this.state.settings.jsonBin;
            if (!enabled || !apiKey || !binId) {
                this.showNotification("Сначала настройте онлайн-синхронизацию.", "warning");
                return;
            }
            const dataToEncode = {
                syncCredentials: { apiKey, binId }
            };
            const dataString = btoa(JSON.stringify(dataToEncode));
            const qr = qrcode(0, 'L');
            qr.addData(dataString);
            qr.make();
            const qrImgTag = qr.createImgTag(4, 8);

            const body = `
                <p>Отсканируйте этот QR-код на другом устройстве, чтобы подключить его к этому же онлайн-хранилищу.</p>
                <div id="qr-code-container">${qrImgTag}</div>
                <p style="font-size: 12px; color: var(--warning-color);"><b>Внимание:</b> QR-код содержит ключи доступа к вашим данным. Не делитесь им с посторонними.</p>
            `;
            this.showModal("Синхронизация", body, [{ text: "Закрыть", class: "primary", action: () => {} }]);
        } catch(e) {
            this.showNotification("Ошибка при генерации QR-кода.", "error");
            console.error(e);
        }
    },
    
    async startQrScanner() {
        // ... (same as before)
    },

    stopQrScanner() {
        // ... (same as before)
    },

    scanTick() {
        // ... (same as before)
    },

    // PWA & NOTIFICATIONS
    registerServiceWorker() {
        // ... (same as before)
    },
    
    async requestNotificationPermission() {
        // ... (same as before)
    },

    showSystemNotification(title, body) {
        // ... (same as before)
    },

    // SYNC
    setSyncStatus(status) {
        this.sync.status = status;
        this.dom.syncStatusIndicator.className = status;
    },

    async syncDataUp() {
        const { enabled, apiKey, binId } = this.state.settings.jsonBin;
        if (!enabled || !apiKey || !binId) return;

        clearTimeout(this.sync.timeout);
        this.setSyncStatus('syncing');

        this.sync.timeout = setTimeout(async () => {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey,
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify(this.state)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                this.logToConsole('⬆️ Data synced up.');
                this.setSyncStatus('synced');
            } catch (e) {
                this.setSyncStatus('error');
                console.error('Sync Up failed', e);
            }
        }, 500); // Debounce saves
    },

    async syncDataDown() {
        const { enabled, apiKey, binId } = this.state.settings.jsonBin;
        if (!enabled || !apiKey || !binId) return;
        this.setSyncStatus('syncing');
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                headers: { 'X-Master-Key': apiKey }
            });
            if (!response.ok) {
                 if (response.status === 404) { // New Bin
                    this.logToConsole('ℹ️ Creating new Bin in JSONBin.io');
                    await this.syncDataUp(); // Initial push
                    return;
                }
                throw new Error('Failed to fetch from JSONBin');
            }
            const data = await response.json();
            if (data.record && data.record.timestamp) {
                // Only update if remote is newer
                if (!this.state.timestamp || new Date(data.record.timestamp) > new Date(this.state.timestamp)) {
                    this.state = data.record;
                    this.saveStateToLocal();
                    this.logToConsole('⬇️ Data synced down.');
                }
            }
            this.setSyncStatus('synced');
        } catch(e) {
            this.setSyncStatus('error');
            console.error('Sync Down failed', e);
        }
    },

    async saveSyncSettings() {
        const binId = this.dom.settings.jsonBinBinId.value.trim();
        const apiKey = this.dom.settings.jsonBinApiKey.value.trim();

        if (!binId || !apiKey) {
            this.state.settings.jsonBin = { enabled: false, apiKey: null, binId: null };
            await this.saveState();
            this.showNotification("Синхронизация отключена.");
            return;
        }

        this.showNotification("Проверка ключей JSONBin...", 'loading');
        try {
             const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                headers: { 'X-Master-Key': apiKey }
            });

            if (!response.ok && response.status !== 404) {
                 throw new Error(`Неверные ключи или проблема с доступом. Статус: ${response.status}`);
            }

            this.state.settings.jsonBin = { enabled: true, apiKey, binId };
            this.saveStateToLocal(); // Save creds locally first
            await this.syncDataDown(); // Then try to pull data
            await this.syncDataUp(); // And push current state if bin was new
            this.showNotification("Настройки синхронизации сохранены!", "success");
            this.renderAll();

        } catch (e) {
            this.showNotification(e.message, 'error');
            console.error(e);
        }
    },
    
    showJsonBinHelpModal() {
        const bodyHtml = `
            <p>JSONBin.io — это бесплатный сервис, который мы используем для безопасного хранения ваших данных онлайн.</p>
            <ol>
                <li>Перейдите на сайт <a href="https://jsonbin.io/" target="_blank">jsonbin.io</a> и зарегистрируйтесь.</li>
                <li>Нажмите на иконку аватара в правом верхнем углу и выберите <strong>API Keys</strong>.</li>
                <li>Скопируйте ваш <strong>X-Master-Key</strong> — это ваш ключ доступа.</li>
                <li>Вернитесь на главную страницу, нажмите <strong>Create Your First Bin</strong> (или New Collection -> New Bin). Bin станет вашим личным "файлом" в облаке.</li>
                <li>После создания Bin, скопируйте <strong>ID хранилища</strong> из адресной строки браузера. Это будет строка вида <code>/b/66a123...</code>. Нужна только сама строка, без <code>/b/</code>.</li>
            </ol>
            <p>Вставьте эти два значения в поля настроек.</p>
        `;
        this.showModal("Как настроить JSONBin.io?", bodyHtml, [{text: 'Понятно', class:'primary', action: ()=>{}}]);
    },
    
    toggleDevConsole() {
        // ... (same as before)
    },
    logToConsole(message) {
        // ... (same as before)
    },
    executeCommand(commandStr) {
        // ... (same as before)
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>