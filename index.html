
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>СЕМЕЙНОЕ МЕНЮ</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="СЕМЕЙНОЕ МЕНЮ">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiB2aWV3Qm94PSIwIDAgMTAyNCAxMDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiByeD0iMjMyIiBmaWxsPSIjRjlGN0Y0Ii8+CjxwYXRoIGQ9Ik01MTIgNzM5QzQ1Ni45MSA3MzkgNDE3IDcyMC4wOSA0MTcgNjY1QzQxNyA2MDkuOTEgNDU2LjkxIDU5MSA1MTIgNTkxQzU2Ny4wOSA1OTEgNjA3IDYwOS45MSA2MDcgNjY1QzYwNyA3MjAuMDkgNTY3LjA5IDczOSA1MTIgNzM5WiIgZmlsbD0iIzhCNUUzQyIvPgo8cGF0aCBkPSJNNTEyIDcxOEM0NjguNDMgNzE4IDQzMyA2OTYuNTcgNDMzIDY2NUM0MzMgNjMzLjQzIDQ2OC40MyA2MTIgNTEyIDYxMkM1NTUuNTcgNjEyIDU5MSA2MzMuNDMgNTkxIDY2NUM1OTEgNjk2LjU3IDU1NS41NyA3MTggNTEyIDcxOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik01MTIgMzQ0QzUxMiAzNDQgNTM2IDM4NSA1MTIgNDA5QzQ4OCAzODUgNTEyIDM0NCA1MTIgMzQ0WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+CjxwYXRoIGQ9Ik00ODQgMzI2QzQ4NCAzMjYgNTAzIDM1OC42IDQ4NCAzNzZDNA2NSAzNTguNiA0ODQgMzI2IDQ4NCAzMjZaIiBmaWxsPSIjRDRBMzcyIiBvcGFjaXR5PSIwLjUiLz4KPHBhdGggZD0iTTU0MCAzMjZDNTAxIDMyNiA1OTcgMzU4LjYgNTQwIDM3NkM1NzMgMzU4LjYgNTQwIDMyNiA1NDAgMzI2WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+Cjwvc3ZnPgo=">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiB2aWV3Qm94PSIwIDAgMTAyNCAxMDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiByeD0iMjMyIiBmaWxsPSIjRjlGN0Y0Ii8+CjxwYXRoIGQ9Ik01MTIgNzM5QzQ1Ni45MSA3MzkgNDE3IDcyMC4wOSA0MTcgNjY1QzQxNyA2MDkuOTEgNDU2LjkxIDU5MSA1MTIgNTkxQzU2Ny4wOSA1OTEgNjA3IDYwOS45MSA2MDcgNjY1QzYwNyA3MjAuMDkgNTY3LjA5IDczOSA1MTIgNzM5WiIgZmlsbD0iIzhCNUUzQyIvPgo8cGF0aCBkPSJNNTEyIDcxOEM0NjguNDMgNzE4IDQzMyA2OTYuNTcgNDMzIDY2NUM0MzMgNjMzLjQzIDQ2OC44MyA2MTIgNTEyIDYxMkM1NTUuNTcgNjEyIDU5MSA2MzMuNDMgNTkxIDY2NUM1OTEgNjk2LjU3IDU1NS41NyA3MTggNTEyIDcxOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik01MTIgMzQ0QzUxMiAzNDQgNTM2IDM4NSA1MTIgNDA5QzQ4OCAzODUgNTEyIDM0NCA1MTIgMzQ0WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+CjxwYXRoIGQ9Ik00ODQgMzI2QzQ4NCAzMjYgNTAzIDM1OC42IDQ4NCAzNzZDNA2NSAzNTguNiA0ODQgMzI2IDQ4NCAzMjZaIiBmaWxsPSIjRDRBMzcyIiBvcGFjaXR5PSIwLjUiLz4KPHBhdGggZD0iTTU0MCAzMjZDNTAxIDMyNiA1OTcgMzU4LjYgNTQwIDM3NkM1NzMgMzU4LjYgNTQwIDMyNiA1NDAgMzI2WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+Cjwvc3ZnPgo=">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
    --font-nunito: 'Nunito', sans-serif;
    --font-lato: 'Lato', sans-serif;
    --bg-color: #F9F7F4;
    --accent-color: #8B5E3C;
    --secondary-color: #D4A373;
    --success-color: #5E7A6E;
    --warning-color: #E07A5F;
    --danger-color: #D9534F;
    --text-color: #333;
    --soft-text: #7D7D7D;
    --card-bg: #FFFFFF;
    --card-accent-bg: #F0E7DD;
    --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: var(--font-lato);
    background-color: var(--bg-color);
    color: var(--text-color);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B5E3C' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.1;
    z-index: -1;
}

#app {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    transition: transform 0.5s var(--ease-out), opacity 0.5s var(--ease-out);
    opacity: 1;
    transform: scale(1);
    overflow-y: auto;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
}

.screen.hidden {
    transform: scale(1.05);
    opacity: 0;
    pointer-events: none;
}
.hidden { display: none !important; }

/* --- Setup Screen --- */
#setup-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    background: linear-gradient(160deg, #F9F7F4, #EDE0D4);
}

.setup-container {
    max-width: 350px;
    width: 90%;
}

.setup-logo {
    width: 100px;
    height: 100px;
    margin-bottom: 30px;
    animation: spin 10s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.setup-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 28px;
    color: var(--accent-color);
    margin: 0 0 10px;
}

.setup-subtitle {
    font-size: 16px;
    color: var(--soft-text);
    margin-bottom: 30px;
    line-height: 1.5;
}

.input-group {
    position: relative;
    margin-bottom: 20px;
}

#api-key-input {
    width: 100%;
    height: 50px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 0 20px;
    font-size: 16px;
    font-family: var(--font-lato);
    outline: none;
    transition: border-color 0.3s;
}
#api-key-input:focus {
    border-color: var(--accent-color);
}

.primary-button {
    width: 100%;
    height: 50px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
    -webkit-appearance: none;
}
.primary-button:active {
    transform: scale(0.98);
}
.primary-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}
.primary-button.reveal {
    animation: reveal 0.5s var(--ease-out) forwards;
    opacity: 0;
    transform: translateY(20px);
}
@keyframes reveal {
    to { opacity: 1; transform: translateY(0); }
}
.danger-button {
    background-color: var(--danger-color);
}
/* Generation Progress */
#generation-progress {
    width: 100%;
}
.progress-bar-container {
    width: 100%;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 20px 0;
}
#progress-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    transition: width 0.5s var(--ease-out);
}
#progress-status {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    color: var(--accent-color);
    margin-bottom: 5px;
    min-height: 25px;
}
#progress-details {
    font-size: 14px;
    color: var(--soft-text);
    min-height: 40px;
    line-height: 1.4;
}

/* --- Main Screen --- */
#main-screen {
    padding: 0;
    padding-top: env(safe-area-inset-top);
    display: flex;
    flex-direction: column;
}
.main-header {
    padding: 15px 20px;
    font-family: var(--font-nunito);
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-color);
    flex-shrink: 0;
}
.content-area {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
}
.bottom-nav {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: #fff;
    border-top: 1px solid #eee;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    flex-shrink: 0;
}
.nav-button {
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
    font-size: 12px;
    color: var(--soft-text);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: color 0.2s;
    width: 20%;
}
.nav-button svg {
    width: 24px;
    height: 24px;
    stroke: var(--soft-text);
    transition: stroke 0.2s;
}
.nav-button.active, .nav-button:active {
    color: var(--accent-color);
}
.nav-button.active svg, .nav-button:active svg {
    stroke: var(--accent-color);
}
.main-content {
    display: none;
}
.main-content.active {
    display: block;
    animation: fadeIn 0.5s var(--ease-out);
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Menu Screen --- */
.day-scroller {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding: 10px 0 20px;
    -webkit-overflow-scrolling: touch;
}
.day-scroller::-webkit-scrollbar { display: none; }

.day-card {
    flex: 0 0 90%;
    width: 90%;
    margin-right: 15px;
    scroll-snap-align: center;
    background-color: var(--card-bg);
    border-radius: 24px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.04);
    padding: 20px;
    display: flex;
    flex-direction: column;
}
.day-card:last-child { margin-right: 0; }
.day-title-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}
.day-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-align: center;
    text-transform: uppercase;
    margin: 0 10px;
}
.regenerate-btn {
    background: none; border: none; cursor: pointer; font-size: 20px; opacity: 0.5; transition: opacity 0.2s; padding: 5px;
}
.regenerate-btn:hover { opacity: 1; }
.meal {
    display: flex;
    align-items: center;
    padding: 10px 0;
    font-size: 18px;
}
.meal-icon {
    margin-right: 15px;
    font-size: 20px;
}
.meal-name {
    flex-grow: 1;
}
.meal.placeholder {
    color: #ccc;
}
.meal.clickable {
    background-color: var(--card-accent-bg);
    border-radius: 12px;
    padding: 12px 15px;
    margin: 5px 0;
    cursor: pointer;
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--accent-color);
    transition: transform 0.2s, box-shadow 0.2s;
}
.meal.clickable .regenerate-btn {
    margin-left: auto;
}
.meal.clickable:active {
    transform: scale(0.99);
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.leftover-icon {
    font-size: 16px;
    opacity: 0.5;
    margin-left: 8px;
    color: var(--secondary-color);
}

/* --- Recipe Screen --- */
#recipe-screen {
    background-color: #fff;
    transform: translateX(100%);
    z-index: 10;
}
#recipe-screen.active {
    transform: translateX(0);
}
.recipe-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 15px 0;
}
.back-button {
    background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: var(--accent-color); font-weight: 600; display: flex; align-items: center;
}
#recipe-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-align: center;
    flex-grow: 1;
}
#step-indicator {
    font-size: 18px;
    color: var(--secondary-color);
    font-family: var(--font-nunito);
    font-weight: 600;
}
#step-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    background-color: #eee;
}
#step-description {
    font-size: 18px;
    line-height: 1.6;
    margin: 20px 0;
}
.timer-container {
    background-color: var(--card-accent-bg);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
}
#timer-display {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 48px;
    color: var(--accent-color);
    letter-spacing: 2px;
}
.timer-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}
.timer-button {
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s;
}
.timer-button:active { transform: scale(0.95); }
#start-timer-btn { background-color: var(--success-color); color: white; }
#pause-timer-btn { background-color: var(--warning-color); color: white; }
#reset-timer-btn { background-color: #ccc; color: #333; }

#step-ingredients-title {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    margin-top: 20px;
}
#step-ingredients {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}
#step-ingredients li {
    display: flex;
    align-items: center;
    padding: 8px 0;
    font-size: 16px;
}
.ingredient-status {
    margin-right: 12px;
    font-size: 20px;
}
.ingredient-status.completed { color: var(--success-color); }
.ingredient-status.missing { color: var(--warning-color); }
.ingredient-status.unknown { color: #ccc; }

.recipe-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}
.nav-btn-recipe {
    background: var(--card-accent-bg);
    color: var(--accent-color);
    border: none;
    border-radius: 12px;
    padding: 15px 30px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
}
.nav-btn-recipe:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* --- Shopping List --- */
#shopping-list-content { padding-bottom: 50px; }
.progress-bar-shopping {
    width: 100%;
    height: 8px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0 20px;
}
#shopping-progress {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    transition: width 0.5s var(--ease-out);
}
#shopping-progress-text {
    font-size: 14px;
    color: var(--soft-text);
    margin-bottom: 10px;
}
.category-toggle {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    padding: 15px 0;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    color: var(--accent-color);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}
.category-items {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.5s var(--ease-out), padding 0.5s var(--ease-out);
}
.category-items.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
}
.shopping-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
}

.item-checkbox-progress {
    width: 24px; height: 24px;
    position: relative;
    margin-right: 15px;
    flex-shrink: 0;
}
.item-checkbox-progress svg {
    width: 100%; height: 100%;
    transform: rotate(-90deg);
}
.item-checkbox-progress circle {
    fill: none;
    stroke-width: 2.5;
}
.item-checkbox-progress .bg { stroke: #ccc; }
.item-checkbox-progress .progress { stroke: var(--success-color); transition: stroke-dasharray 0.3s linear; }
.item-checkbox-progress .checkmark {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    color: var(--success-color);
    font-size: 16px;
    transition: transform 0.2s var(--ease-out);
}
.shopping-item.completed .item-checkbox-progress .checkmark {
    transform: translate(-50%, -50%) scale(1);
}

.item-details {
    flex-grow: 1;
    transition: color 0.3s;
}
.item-name {
    font-size: 16px;
    font-weight: 600;
}
.item-quantity {
    font-size: 14px;
    color: var(--soft-text);
}
.item-price {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    color: var(--accent-color);
}
.shopping-item.completed .item-details { color: #aaa; }
.shopping-item.completed .item-name { text-decoration: line-through; }


#shopping-list-total {
    margin-top: 20px;
    padding: 20px;
    background-color: var(--card-accent-bg);
    border-radius: 16px;
    text-align: center;
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 20px;
    color: var(--accent-color);
}
#shopping-list-total span { font-weight: 400; font-size: 16px; }

/* --- Budget Screen --- */
.budget-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
}
.pie-chart-container {
    position: relative;
    width: 250px;
    height: 250px;
    margin-bottom: 30px;
}
.pie-chart {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}
.pie-chart circle {
    fill: none;
    stroke-width: 32;
    transition: stroke-dasharray 0.8s var(--ease-out);
}
.chart-center-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 32px;
    color: var(--accent-color);
}
.chart-center-text span {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--soft-text);
}
.budget-summary {
    width: 100%;
    text-align: center;
}
.budget-summary p {
    margin: 8px 0;
    font-size: 18px;
}
.budget-summary .amount {
    font-family: var(--font-nunito);
    font-weight: 700;
}
.budget-summary #budget-remaining.ok {
    color: var(--success-color);
}
.budget-summary #budget-remaining.warning {
    color: var(--warning-color);
}

/* --- Settings Screen --- */
#settings-content {
    padding-bottom: 50px;
}
.settings-section {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.settings-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 20px;
    color: var(--accent-color);
    margin: 0 0 20px 0;
}
.settings-form-group {
    margin-bottom: 15px;
}
.settings-form-group label {
    display: block;
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 8px;
}
.settings-input, .settings-textarea, .settings-select {
    width: 100%;
    height: 45px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0 15px;
    font-size: 16px;
    font-family: var(--font-lato);
    background: #fff;
    -webkit-appearance: none;
}
.settings-textarea {
    height: auto;
    padding-top: 10px;
    padding-bottom: 10px;
    resize: vertical;
}

.family-member-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--card-accent-bg);
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
}
.family-member-card button {
    background: none; border: none; font-size: 20px; cursor: pointer; color: var(--danger-color); opacity: 0.7;
}
.secondary-button {
    width: 100%;
    height: 45px;
    background: var(--card-accent-bg);
    color: var(--accent-color);
    border: none;
    border-radius: 12px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
}
.install-instructions {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--card-accent-bg);
    padding: 15px;
    border-radius: 12px;
}
.install-icon {
    font-size: 24px;
}
.install-text {
    font-size: 14px;
    line-height: 1.5;
}

/* --- Dev Console --- */
#dev-console {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 30vh;
    background-color: rgba(0,0,0,0.9);
    color: #e0e0e0;
    border-top: 1px solid var(--secondary-color);
    transform: translateY(100%);
    transition: transform 0.4s var(--ease-out);
    z-index: 100;
    display: flex;
    flex-direction: column;
}
#dev-console.visible {
    transform: translateY(0);
}
#log-output {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px;
}
#log-output p { margin: 2px 0; }
#command-input {
    width: 100%;
    background: #333;
    border: none;
    border-top: 1px solid #555;
    color: #e0e0e0;
    padding: 10px;
    font-family: 'Courier New', Courier, monospace;
    outline: none;
}

/* --- Notification --- */
#notification {
    position: fixed;
    top: env(safe-area-inset-top, 0);
    left: 50%;
    transform: translate(-50%, -150%);
    background-color: var(--success-color);
    color: white;
    padding: 12px 25px;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-family: var(--font-nunito);
    font-weight: 700;
    z-index: 200;
    transition: transform 0.5s var(--ease-out);
}
#notification.show {
    transform: translate(-50%, 20px);
}
#notification.loading {
    background-color: var(--secondary-color);
}
#notification.error {
    background-color: var(--danger-color);
}

/* --- Modal --- */
#modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-out);
}
#modal-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
.modal-content {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 24px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transform: scale(0.95);
    transition: transform 0.3s var(--ease-out);
}
#modal-overlay.visible .modal-content {
    transform: scale(1);
}
.modal-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    margin: 0 0 20px;
    text-align: center;
}
.modal-body {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-color);
    margin-bottom: 25px;
}
.modal-body ul {
    padding-left: 20px;
}
.modal-body ul li {
    margin-bottom: 8px;
}
.modal-form-group {
    margin-bottom: 15px;
}
.modal-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--soft-text);
}
.modal-input, .modal-textarea {
    width: 100%;
    height: 45px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0 15px;
    font-size: 16px;
    font-family: var(--font-lato);
}
.modal-textarea {
    height: auto;
    padding-top: 10px;
    padding-bottom: 10px;
    resize: vertical;
}
.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}
.modal-button {
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-family: var(--font-nunito);
    font-weight: 700;
    cursor: pointer;
}
.modal-button.secondary {
    background-color: #eee;
    color: #333;
}
.modal-button.primary {
    background-color: var(--accent-color);
    color: white;
}
</style>
</head>
<body>

<div id="app">
    <!-- Экран первоначальной настройки и генерации -->
    <div class="screen" id="setup-screen">
        <div class="setup-container">
            <svg class="setup-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#F0E7DD"/><path d="M50,10 A40,40 0 0,1 90,50" fill="none" stroke="#8B5E3C" stroke-width="8"/><path d="M50,90 A40,40 0 0,1 10,50" fill="none" stroke="#D4A373" stroke-width="8"/><circle cx="50" cy="50" r="20" fill="#fff"/><path d="M50 38 C 55 42, 55 48, 50 52 S 45 58, 50 62" stroke="#5E7A6E" stroke-width="4" fill="none" stroke-linecap="round"/></svg>
            <h1 class="setup-title">СЕМЕЙНОЕ МЕНЮ</h1>
            <p class="setup-subtitle">Ваш ИИ-помощник для вкусных и простых семейных обедов.</p>
            
            <div id="api-key-section">
                <div class="input-group">
                    <input type="password" id="api-key-input" placeholder="Ваш Google Gemini API ключ">
                </div>
                <button class="primary-button" id="start-setup-btn">Подключить Gemini</button>
            </div>

            <div id="generation-progress" class="hidden">
                <div id="progress-status"></div>
                <div class="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="progress-details"></div>
                <button class="primary-button hidden" id="finish-setup-btn">Открыть меню</button>
            </div>
        </div>
    </div>

    <!-- Основной экран приложения с навигацией -->
    <div class="screen hidden" id="main-screen">
        <header class="main-header" id="main-header-title">Меню на неделю</header>
        <div class="content-area">
            <div class="main-content active" id="menu-content">
                <div class="day-scroller" id="day-scroller-container"></div>
            </div>
            <div class="main-content" id="shopping-list-content">
                <p id="shopping-progress-text">0/0 куплено</p>
                <div class="progress-bar-shopping">
                    <div id="shopping-progress"></div>
                </div>
                <div id="shopping-list-container"></div>
                <div id="shopping-list-total"><span>Примерная сумма:</span> 0 ₽</div>
            </div>
            <div class="main-content" id="budget-content">
                <div class="budget-container">
                    <div class="pie-chart-container">
                        <svg class="pie-chart" viewBox="0 0 36 36">
                          <circle cx="18" cy="18" r="15.9155" stroke="#eee" stroke-width="32" fill="#fff"/>
                          <circle class="pie-slice" id="pie-products" cx="18" cy="18" r="15.9155" stroke="#8B5E3C" stroke-dasharray="0, 100"/>
                        </svg>
                        <div class="chart-center-text" id="budget-spent-total">0 ₽ <span>потрачено</span></div>
                    </div>
                    <div class="budget-summary">
                        <p>Бюджет: <span class="amount" id="budget-total">10000 ₽</span></p>
                        <p>Осталось: <span class="amount ok" id="budget-remaining">10000 ₽</span></p>
                    </div>
                </div>
            </div>
            <div class="main-content" id="settings-content">
                <div class="settings-section">
                    <h3 class="settings-title">Основные настройки</h3>
                    <div class="settings-form-group">
                        <label for="settings-menu-duration">Количество дней меню</label>
                        <input type="number" id="settings-menu-duration" class="settings-input" min="1" max="14">
                    </div>
                    <div class="settings-form-group">
                        <label for="settings-total-budget">Общий бюджет, ₽</label>
                        <input type="number" id="settings-total-budget" class="settings-input" step="500">
                    </div>
                    <div class="settings-form-group">
                        <label for="settings-preferences">Предпочтения и аллергии</label>
                        <textarea id="settings-preferences" class="settings-textarea" rows="3" placeholder="Например: без рыбы, меньше жареного"></textarea>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Состав семьи</h3>
                    <div id="family-members-container"></div>
                    <button class="secondary-button" id="add-family-member-btn">+ Добавить члена семьи</button>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Управление данными</h3>
                    <button class="primary-button" id="export-btn">📤 Экспортировать данные</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                    <button class="primary-button" id="import-btn" style="margin-top: 10px;">📥 Импортировать данные</button>
                    <button class="primary-button danger-button" id="regenerate-all-btn" style="margin-top: 20px;">🔄 Перегенерировать всё меню</button>
                </div>

                <div class="settings-section">
                    <h3 class="settings-title">Как установить приложение</h3>
                    <div class="install-instructions">
                        <span class="install-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.5V3M7.5 7.5L12 3l4.5 4.5M18 13.5v5.25c0 .93-.75 1.68-1.68 1.68H7.68c-.93 0-1.68-.75-1.68-1.68v-5.25"/></svg>
                        </span>
                        <div class="install-text">Нажмите "Поделиться" в браузере, а затем выберите "На экран 'Домой'", чтобы использовать приложение как нативное.</div>
                    </div>
                </div>
            </div>
        </div>
        <nav class="bottom-nav">
            <button class="nav-button active" data-content="menu-content" data-title="Меню на неделю">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                Меню
            </button>
            <button class="nav-button" data-content="shopping-list-content" data-title="Список покупок">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-6.817a.5.5 0 00-.47-.665H5.25l-.838-3.141A.5.5 0 003.838 3H2.25zM7.5 14.25v3H6a3 3 0 01-3-3h4.5zM16.5 14.25v3h1.5a3 3 0 003-3h-4.5z" /></svg>
                Покупки
            </button>
            <button class="nav-button" data-content="budget-content" data-title="Бюджет">
                 <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 3a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m15 0a2.25 2.25 0 01-2.25 2.25H9.75a2.25 2.25 0 01-2.25-2.25M15 12a2.25 2.25 0 00-2.25-2.25H9.75A2.25 2.25 0 007.5 12m7.5 0v6M7.5 12v6m7.5-6H9.75" /></svg>
                Бюджет
            </button>
            <button class="nav-button" data-content="settings-content" data-title="Настройки">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.008 1.11-1.226a2.25 2.25 0 012.58 1.226c.27.653.81 1.1 1.48 1.194.67.093 1.28-.29 1.63-.873a2.25 2.25 0 012.92 2.92c-.583.35-1.04.96-1.226 1.63-.194.67.194 1.28.873 1.63a2.25 2.25 0 01-2.92 2.92c-.35-.583-.96-1.04-1.63-1.226a2.25 2.25 0 00-1.48-1.194 2.25 2.25 0 00-2.58 1.226c-.09.542-.56 1.008-1.11 1.226a2.25 2.25 0 01-2.58-1.226c-.27-.653-.81-1.1-1.48-1.194-.67-.093-1.28.29-1.63.873a2.25 2.25 0 01-2.92-2.92c.583.35 1.04-.96 1.226-1.63.194-.67-.194-1.28-.873-1.63a2.25 2.25 0 012.92-2.92c.35.583.96 1.04 1.63 1.226.67.093 1.28-.29 1.48-1.194z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Настройки
            </button>
        </nav>
    </div>

    <!-- Экран рецепта -->
    <div class="screen hidden" id="recipe-screen">
        <header class="recipe-header">
            <button class="back-button" id="back-to-menu-btn">◀︎ Назад</button>
            <h2 id="recipe-title"></h2>
            <span id="step-indicator"></span>
        </header>
        <div id="recipe-content">
            <img id="step-image" src="" alt="Изображение шага">
            <p id="step-description"></p>
            <div class="timer-container hidden" id="timer-section">
                <div id="timer-display">00:00</div>
                <div class="timer-controls">
                    <button class="timer-button" id="start-timer-btn">▶️ Запустить</button>
                    <button class="timer-button" id="pause-timer-btn">⏸️ Пауза</button>
                    <button class="timer-button" id="reset-timer-btn">♻️ Сброс</button>
                </div>
            </div>
            <h3 id="step-ingredients-title">Ингредиенты на этом шаге:</h3>
            <ul id="step-ingredients"></ul>
            <div class="recipe-nav">
                <button class="nav-btn-recipe" id="prev-step-btn">← Назад</button>
                <button class="nav-btn-recipe" id="next-step-btn">Далее →</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно -->
    <div id="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title"></h3>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>
    
    <!-- Консоль разработчика -->
    <div id="dev-console">
        <div id="log-output"></div>
        <input type="text" id="command-input" placeholder="Введите команду...">
    </div>

    <!-- Уведомление -->
    <div id="notification"></div>
</div>

<audio id="notification-sound" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YU9vT18="></audio>

<script type="module">
import { GoogleGenAI, Type } from "https://esm.run/@google/genai";

const app = {
    state: {
        settings: {
            apiKey: null,
            family: [{ age: 30, gender: 'female', activity: 'moderate' }],
            preferences: "Без рыбы, без грибов",
            menuDuration: 7,
            totalBudget: 10000,
        },
        menu: [],
        recipes: {},
        shoppingList: [],
        timestamp: null,
    },
    
    dom: {},
    currentRecipe: {
        id: null,
        step: 0,
    },
    timer: {
        interval: null,
        timeLeft: 0,
        initialTime: 0,
        isRunning: false,
    },

    init() {
        this.cacheDom();
        this.addEventListeners();
        this.loadState();

        if (this.state.settings.apiKey && this.state.menu && this.state.menu.length > 0) {
            this.showScreen('main-screen');
            this.renderAll();
        } else {
            this.showScreen('setup-screen');
        }
    },

    cacheDom() {
        this.dom = {
            screens: document.querySelectorAll('.screen'),
            setupScreen: document.getElementById('setup-screen'),
            mainScreen: document.getElementById('main-screen'),
            recipeScreen: document.getElementById('recipe-screen'),
            
            apiKeySection: document.getElementById('api-key-section'),
            apiKeyInput: document.getElementById('api-key-input'),
            startSetupBtn: document.getElementById('start-setup-btn'),

            generationProgress: document.getElementById('generation-progress'),
            progressBar: document.getElementById('progress-bar'),
            progressStatus: document.getElementById('progress-status'),
            progressDetails: document.getElementById('progress-details'),
            finishSetupBtn: document.getElementById('finish-setup-btn'),
            
            bottomNav: document.querySelector('.bottom-nav'),
            mainContents: document.querySelectorAll('.main-content'),
            mainHeaderTitle: document.getElementById('main-header-title'),
            
            dayScroller: document.getElementById('day-scroller-container'),
            shoppingListContainer: document.getElementById('shopping-list-container'),
            shoppingProgressText: document.getElementById('shopping-progress-text'),
            shoppingProgress: document.getElementById('shopping-progress'),
            shoppingListTotal: document.getElementById('shopping-list-total'),

            backToMenuBtn: document.getElementById('back-to-menu-btn'),
            recipeTitle: document.getElementById('recipe-title'),
            stepIndicator: document.getElementById('step-indicator'),
            stepImage: document.getElementById('step-image'),
            stepDescription: document.getElementById('step-description'),
            timerSection: document.getElementById('timer-section'),
            timerDisplay: document.getElementById('timer-display'),
            startTimerBtn: document.getElementById('start-timer-btn'),
            pauseTimerBtn: document.getElementById('pause-timer-btn'),
            resetTimerBtn: document.getElementById('reset-timer-btn'),
            stepIngredientsList: document.getElementById('step-ingredients'),
            prevStepBtn: document.getElementById('prev-step-btn'),
            nextStepBtn: document.getElementById('next-step-btn'),
            
            budget: {
                pieProducts: document.getElementById('pie-products'),
                spentTotal: document.getElementById('budget-spent-total'),
                total: document.getElementById('budget-total'),
                remaining: document.getElementById('budget-remaining'),
            },

            settings: {
                duration: document.getElementById('settings-menu-duration'),
                budget: document.getElementById('settings-total-budget'),
                preferences: document.getElementById('settings-preferences'),
                familyContainer: document.getElementById('family-members-container'),
                addMemberBtn: document.getElementById('add-family-member-btn'),
                regenerateAllBtn: document.getElementById('regenerate-all-btn'),
            },
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importFileInput: document.getElementById('import-file-input'),

            devConsole: document.getElementById('dev-console'),
            logOutput: document.getElementById('log-output'),
            commandInput: document.getElementById('command-input'),

            notification: document.getElementById('notification'),
            notificationSound: document.getElementById('notification-sound'),

            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalButtons: document.getElementById('modal-buttons'),
        };
    },
    
    addEventListeners() {
        this.dom.startSetupBtn.addEventListener('click', () => this.startGenerationProcess());
        this.dom.finishSetupBtn.addEventListener('click', () => {
            document.getElementById('generation-progress').classList.add('hidden');
            document.getElementById('finish-setup-btn').classList.add('hidden');
            this.showScreen('main-screen');
            this.renderAll();
        });
        this.dom.bottomNav.addEventListener('click', (e) => this.handleNav(e));
        this.dom.backToMenuBtn.addEventListener('click', () => this.showScreen('main-screen'));
        
        this.dom.prevStepBtn.addEventListener('click', () => this.navigateRecipeStep(-1));
        this.dom.nextStepBtn.addEventListener('click', () => this.navigateRecipeStep(1));

        this.dom.startTimerBtn.addEventListener('click', () => this.startTimer());
        this.dom.pauseTimerBtn.addEventListener('click', () => this.pauseTimer());
        this.dom.resetTimerBtn.addEventListener('click', () => this.resetTimer());

        // Settings Listeners
        this.dom.settings.duration.addEventListener('change', () => this.saveSettings());
        this.dom.settings.budget.addEventListener('change', () => this.saveSettings());
        this.dom.settings.preferences.addEventListener('change', () => this.saveSettings());
        this.dom.settings.addMemberBtn.addEventListener('click', () => this.openFamilyMemberModal());
        this.dom.settings.regenerateAllBtn.addEventListener('click', () => this.confirmRegenerateAll());

        this.dom.exportBtn.addEventListener('click', () => this.exportData());
        this.dom.importBtn.addEventListener('click', () => this.dom.importFileInput.click());
        this.dom.importFileInput.addEventListener('change', (e) => this.importData(e));

        let longPressTimer;
        document.body.addEventListener('touchstart', e => {
            if (e.touches.length === 3) {
                longPressTimer = setTimeout(() => this.toggleDevConsole(), 1000);
            }
        });
        document.body.addEventListener('touchend', () => clearTimeout(longPressTimer));
        this.dom.commandInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') this.executeCommand(e.target.value);
        });

        this.dom.modalOverlay.addEventListener('click', (e) => {
            if (e.target === this.dom.modalOverlay) {
                this.hideModal();
            }
        });
    },

    saveState() {
        try {
            localStorage.setItem('familyMenuState', JSON.stringify(this.state));
        } catch (e) {
            console.error("Failed to save state:", e);
        }
    },
    
    loadState() {
        const savedState = localStorage.getItem('familyMenuState');
        if (savedState) {
            try {
                const loadedData = JSON.parse(savedState);
                if (loadedData.settings && loadedData.menu) {
                     this.state = loadedData;
                     // Ensure new properties exist for backward compatibility
                     if (!this.state.settings.family) this.state.settings.family = [{ age: 30, gender: 'female', activity: 'moderate' }];
                     if (!this.state.settings.menuDuration) this.state.settings.menuDuration = 7;
                     this.state.shoppingList.forEach(cat => {
                        (cat.items || []).forEach(item => {
                            if (item.purchases === undefined) item.purchases = item.completed ? [{ qty: item.needed?.qty || 1, price: item.actualPrice || item.price }] : [];
                        });
                     });
                } else {
                    this.resetState();
                }
            } catch (e) {
                this.resetState();
            }
        }
    },

    resetState() {
        localStorage.removeItem('familyMenuState');
        window.location.reload();
    },
    
    showScreen(screenId) {
        this.dom.screens.forEach(screen => {
            const isTarget = screen.id === screenId;
            screen.classList.toggle('hidden', !isTarget);
            if (screen.id === 'recipe-screen') {
                screen.classList.toggle('active', isTarget);
            }
        });
        if (screenId === 'main-screen') {
            document.getElementById('main-screen').classList.remove('hidden');
            this.renderAll();
        } else if (screenId === 'setup-screen') {
             document.getElementById('setup-screen').classList.remove('hidden');
        }
    },

    async startGenerationProcess(isRegenerating = false) {
        if (!isRegenerating) {
            const apiKey = this.dom.apiKeyInput.value.trim();
            if (!apiKey) {
                alert('Пожалуйста, введите API ключ.');
                return;
            }
            this.state.settings.apiKey = apiKey;
            this.saveState();
        }
        
        document.getElementById('api-key-section').classList.add('hidden');
        document.getElementById('generation-progress').classList.remove('hidden');
        if (isRegenerating) this.showScreen('setup-screen');
        
        try {
            this.ai = new GoogleGenAI({ apiKey: this.state.settings.apiKey });
            await this.updateProgress(1, 5, "Подключение к Google Gemini…", "Проверка ключа...");
            await this.ai.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
            this.logToConsole('✅ API KEY VALIDATED');
            this.dom.progressDetails.innerHTML += '<br>✅ Ключ активен. Доступ к Gemini получен.';
            
            await this.generateMenu();
            await this.generateRecipes();
            await this.generateShoppingList();
            
            await this.updateProgress(5, 5, "Готово!", "Добро пожаловать в 'СЕМЕЙНОЕ МЕНЮ'.");
            this.dom.finishSetupBtn.classList.remove('hidden');
            this.dom.finishSetupBtn.classList.add('reveal');
            
            this.state.timestamp = new Date().toISOString();
            this.saveState();

        } catch (error) {
            console.error("Generation failed:", error);
            this.updateProgress(0, 5, "Ошибка!", `Не удалось подключиться к Gemini. Проверьте ключ и соединение. ${error.message}`);
            document.getElementById('api-key-section').classList.remove('hidden');
            document.getElementById('generation-progress').classList.add('hidden');
            if(!isRegenerating) {
                this.state.settings.apiKey = null;
                this.saveState();
            }
        }
    },
    
    async updateProgress(step, totalSteps, status, details) {
        return new Promise(resolve => {
            const percent = (step / totalSteps) * 100;
            this.dom.progressBar.style.width = `${percent}%`;
            this.dom.progressStatus.textContent = `Шаг ${step}/${totalSteps}: ${status}`;
            this.dom.progressDetails.innerHTML = details;
            setTimeout(resolve, 300);
        });
    },

    async makeGeminiRequest(prompt, jsonSchema) {
        this.logToConsole(`🟡 REQUEST: ${prompt.substring(0, 50)}...`);
        let retries = 3;
        while (retries > 0) {
            try {
                const result = await this.ai.models.generateContent({
                  model: "gemini-2.5-flash",
                  contents: prompt,
                  config: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                  }
                });
                const jsonText = result.text.trim();
                const data = JSON.parse(jsonText);
                this.logToConsole(`✅ RESPONSE RECEIVED`);
                return data;
            } catch (error) {
                retries--;
                this.logToConsole(`🔴 ERROR: ${error}. Retrying... (${retries} left)`);
                if (retries === 0) throw error;
                await new Promise(res => setTimeout(res, 1000));
            }
        }
    },

    async generateMenu() {
        const { family, menuDuration, preferences } = this.state.settings;
        await this.updateProgress(2, 5, "Генерация меню...", `Для вашей семьи на ${menuDuration} дней.`);
        const familyDescription = family.map(p => `${p.gender === 'male' ? 'Мужчина' : 'Женщина'}, ${p.age} лет, активность: ${p.activity}`).join('; ');
        const prompt = `Сгенерируй разнообразное и сбалансированное меню на ${menuDuration} дней (с воскресенья по субботу) для семьи, состоящей из: ${familyDescription}. Учти их потребности в калориях. Предпочтения: ${preferences}. Каждый день должен включать: Завтрак, Перекус, Обед, Полдник, Ужин. Иногда используй остатки от ужина на обед следующего дня (помечай их как "Название блюда (остатки)").`;
        const schema = {type: Type.ARRAY, items: {type: Type.OBJECT, properties: {day: {type: Type.STRING}, meals: {type: Type.OBJECT, properties: {breakfast: {type: Type.STRING}, snack1: {type: Type.STRING}, lunch: {type: Type.STRING}, snack2: {type: Type.STRING}, dinner: {type: Type.STRING}}, required: ["breakfast", "snack1", "lunch", "snack2", "dinner"]}}, required: ["day", "meals"]}};
        this.state.menu = await this.makeGeminiRequest(prompt, schema);
        this.dom.progressDetails.innerHTML += `<br>✅ Сгенерировано меню.`;
    },
    
    async generateRecipes() {
        await this.updateProgress(3, 5, "Генерация рецептов…", "Создаём пошаговые инструкции...");
        const uniqueMeals = [...new Set(this.state.menu.flatMap(d => [d.meals.lunch, d.meals.dinner]))].filter(name => name && !name.includes("(остатки)"));
        const familySize = this.state.settings.family.length;
        const schema = {type: Type.OBJECT, properties: {id: {type: Type.STRING}, name: {type: Type.STRING}, ingredients: {type: Type.ARRAY, items: {type: Type.OBJECT, properties: {name: {type: Type.STRING}, quantity: {type: Type.STRING}}, required: ["name", "quantity"]}}, steps: {type: Type.ARRAY, items: {type: Type.OBJECT, properties: {description: {type: Type.STRING}, time: {type: Type.NUMBER, description: "Время в минутах. 0 если таймер не нужен."}, ingredients: {type: Type.ARRAY, items: {type: Type.STRING }}}, required: ["description", "time", "ingredients"]}}}, required: ["id", "name", "ingredients", "steps"]};
        
        this.state.recipes = {};
        for (const mealName of uniqueMeals) {
            this.dom.progressDetails.textContent = `Обрабатывается: "${mealName}"...`;
            const prompt = `Создай детальный рецепт для блюда "${mealName}" для семьи из ${familySize} человек (${this.state.settings.family.length} порции).`;
            const recipeData = await this.makeGeminiRequest(prompt, schema);
            this.state.recipes[recipeData.id] = recipeData;
        }
        this.dom.progressDetails.innerHTML += `<br>✅ Все ${uniqueMeals.length} рецептов сгенерированы.`;
    },

    async generateShoppingList() {
        await this.updateProgress(4, 5, "Формирование списка покупок…", "Собираем все ингредиенты...");
        const allIngredients = Object.values(this.state.recipes).flatMap(r => r.ingredients);
        const prompt = `Сгруппируй и суммируй этот список ингредиентов. Категории: "Мясо и птица", "Молочные и яйца", "Овощи и зелень", "Фрукты и орехи", "Бакалея", "Хлеб и выпечка", "Напитки", "Прочее". Для каждого ингредиента верни количество в виде числа и единицу измерения отдельно (например 'кг', 'г', 'шт', 'л', 'мл'). Укажи примерную цену в рублях. Ингредиенты: ${JSON.stringify(allIngredients)}`;
        const schema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { category: { type: Type.STRING }, items: { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { name: { type: Type.STRING }, needed: { type: Type.OBJECT, properties: { qty: { type: Type.NUMBER }, unit: { type: Type.STRING }}}, price: { type: Type.NUMBER } }, required: ["name", "needed", "price"] } } }, required: ["category", "items"] } };
        const shoppingListData = await this.makeGeminiRequest(prompt, schema);
        
        shoppingListData.forEach(category => {
            category.items.forEach(item => {
                item.purchases = []; // New property for partial purchases
            });
        });
        
        this.state.shoppingList = shoppingListData;
        const totalCost = shoppingListData.flatMap(c => c.items).reduce((sum, item) => sum + item.price, 0);
        this.dom.progressDetails.innerHTML += `<br>✅ Список из ${shoppingListData.flatMap(c => c.items).length} продуктов сгруппирован. Итого: ${totalCost} ₽`;
    },
    
    renderAll() {
        this.renderSettings();
        this.renderMenu();
        this.renderShoppingList();
        this.renderBudget();
    },

    renderMenu() {
        if (!this.state.menu || this.state.menu.length === 0) return;
        this.dom.dayScroller.innerHTML = '';
        const daysOrder = ["ВОСКРЕСЕНЬЕ", "ПОНЕДЕЛЬНИК", "ВТОРНИК", "СРЕДА", "ЧЕТВЕРГ", "ПЯТНИЦА", "СУББОТА"];
        
        // Filter out any potentially invalid entries to prevent crashes.
        const validMenuData = this.state.menu.filter(day => day && day.day && day.meals);
        
        const sortedMenu = [...validMenuData].sort((a, b) => {
            return daysOrder.indexOf(a.day.toUpperCase()) - daysOrder.indexOf(b.day.toUpperCase());
        });
        
        sortedMenu.forEach((dayData) => {
            const dayCard = document.createElement('div');
            dayCard.className = 'day-card';
            
            const mealHtml = (icon, mealName, mealKey, dayName) => {
                const isClickable = icon === '🍲' || icon === '🌙';
                const cleanName = (mealName || 'Не указано').replace(/\s*\(остатки\)/i, '');
                const isLeftover = (mealName || '').includes('(остатки)');
                return `
                <div class="meal ${isClickable ? 'clickable' : ''}" data-meal-name="${mealName || ''}" data-meal-key="${mealKey}" data-day-name="${dayName}">
                    <span class="meal-icon">${icon}</span>
                    <span class="meal-name">${cleanName}</span>
                    ${isLeftover ? '<span class="leftover-icon">🔄</span>' : ''}
                    ${isClickable && !isLeftover ? '<button class="regenerate-btn">🔄</button>' : ''}
                </div>`;
            };

            dayCard.innerHTML = `
                <div class="day-title-container">
                    <h3 class="day-title">${dayData.day}</h3>
                    <button class="regenerate-btn" data-day-name="${dayData.day}" title="Перегенерировать день">🔄</button>
                </div>
                ${mealHtml('☀️', dayData.meals.breakfast, 'breakfast', dayData.day)}
                ${mealHtml('🍎', dayData.meals.snack1, 'snack1', dayData.day)}
                ${mealHtml('🍲', dayData.meals.lunch, 'lunch', dayData.day)}
                ${mealHtml('🥛', dayData.meals.snack2, 'snack2', dayData.day)}
                ${mealHtml('🌙', dayData.meals.dinner, 'dinner', dayData.day)}
            `;
            
            dayCard.querySelectorAll('.clickable').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target.classList.contains('regenerate-btn')) return;
                    const mealName = e.currentTarget.dataset.mealName.replace(/\s*\(остатки\)/i, '').trim();
                    const recipe = Object.values(this.state.recipes).find(r => r.name === mealName);
                    if (recipe) {
                        this.checkIngredientsForRecipe(recipe.id);
                    } else if (mealName) {
                        this.showNotification(`Рецепт для "${mealName}" не найден.`, 'error');
                    }
                });
            });

            dayCard.querySelectorAll('.regenerate-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const el = e.currentTarget;
                    const dayName = el.dataset.dayName || el.closest('.meal')?.dataset.dayName;
                    const mealKey = el.closest('.meal')?.dataset.mealKey;
                    if (mealKey) {
                        this.openRegenerateModal('meal', { dayName, mealKey });
                    } else {
                        this.openRegenerateModal('day', { dayName });
                    }
                });
            });
            this.dom.dayScroller.appendChild(dayCard);
        });
    },

    renderShoppingList() {
        if (!this.state.shoppingList) return;
        this.dom.shoppingListContainer.innerHTML = '';
        
        this.state.shoppingList.forEach((category, catIndex) => {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category-group';
            
            const itemsHtml = category.items.map((item, itemIndex) => {
                const totalPurchased = item.purchases.reduce((sum, p) => sum + p.qty, 0);
                const isCompleted = totalPurchased >= item.needed.qty;
                const progressPercent = Math.min((totalPurchased / item.needed.qty) * 100, 100);

                const radius = 10;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (progressPercent / 100) * circumference;

                return `
                <li class="shopping-item ${isCompleted ? 'completed' : ''}" data-cat-index="${catIndex}" data-item-index="${itemIndex}">
                    <div class="item-checkbox-progress">
                        <svg viewBox="0 0 24 24">
                          <circle class="bg" cx="12" cy="12" r="${radius}"></circle>
                          <circle class="progress" cx="12" cy="12" r="${radius}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
                        </svg>
                        <span class="checkmark">✔</span>
                    </div>
                    <div class="item-details">
                        <span class="item-name">${item.name}</span>
                        <div class="item-quantity">Куплено: ${totalPurchased.toLocaleString()}/${item.needed.qty.toLocaleString()} ${item.needed.unit}</div>
                    </div>
                    <span class="item-price">${item.price} ₽</span>
                </li>
            `}).join('');
            
            categoryElement.innerHTML = `
                <button class="category-toggle">${category.category} ▼</button>
                <ul class="category-items">${itemsHtml}</ul>
            `;
            this.dom.shoppingListContainer.appendChild(categoryElement);
        });
        
        this.dom.shoppingListContainer.querySelectorAll('.shopping-item').forEach(itemEl => {
            itemEl.addEventListener('click', (e) => {
                const { catIndex, itemIndex } = e.currentTarget.dataset;
                this.openPurchaseModal(parseInt(catIndex), parseInt(itemIndex));
            });
        });
        
        this.dom.shoppingListContainer.querySelectorAll('.category-toggle').forEach(button => {
            button.addEventListener('click', e => {
                const list = e.target.nextElementSibling;
                list.classList.toggle('collapsed');
                e.target.innerHTML = list.classList.contains('collapsed') ? e.target.innerHTML.replace('▼', '▶') : e.target.innerHTML.replace('▶', '▼');
            });
        });

        this.updateShoppingProgress();
        const estimatedCost = this.state.shoppingList.flatMap(c => c.items).reduce((sum, item) => sum + (item.price || 0), 0);
        this.dom.shoppingListTotal.innerHTML = `<span>Примерная сумма:</span> ${estimatedCost.toLocaleString('ru-RU')} ₽`;
    },

    updateShoppingProgress() {
        if (!this.state.shoppingList) return;
        const allItems = this.state.shoppingList.flatMap(c => c.items || []);
        if (allItems.length === 0) return;
        const totalItems = allItems.length;
        const completedItems = allItems.filter(i => {
            const totalPurchased = i.purchases.reduce((sum, p) => sum + p.qty, 0);
            return totalPurchased >= i.needed.qty;
        }).length;
        const percent = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
        this.dom.shoppingProgress.style.width = `${percent}%`;
        this.dom.shoppingProgressText.textContent = `${completedItems}/${totalItems} куплено`;
    },

    renderBudget() {
        const totalBudget = this.state.settings.totalBudget;
        const spentOnProducts = this.state.shoppingList
            .flatMap(c => c.items || [])
            .flatMap(item => item.purchases)
            .reduce((sum, purchase) => sum + purchase.price, 0);

        const remaining = totalBudget - spentOnProducts;
        const spentPercent = totalBudget > 0 ? (spentOnProducts / totalBudget) * 100 : 0;
        
        this.dom.budget.pieProducts.style.strokeDasharray = `${spentPercent} 100`;
        this.dom.budget.spentTotal.innerHTML = `${spentOnProducts.toLocaleString('ru-RU')} ₽ <span>потрачено</span>`;
        this.dom.budget.total.textContent = `${totalBudget.toLocaleString('ru-RU')} ₽`;
        this.dom.budget.remaining.textContent = `${remaining.toLocaleString('ru-RU')} ₽`;
        this.dom.budget.remaining.className = `amount ${remaining >= 0 ? 'ok' : 'warning'}`;
    },
    
    // ... recipe rendering (unchanged) ...
    checkIngredientsForRecipe(recipeId) {
        const recipe = this.state.recipes[recipeId];
        if (!recipe || !recipe.ingredients) {
            this.showRecipe(recipeId);
            return;
        }

        const flatShoppingList = this.state.shoppingList.flatMap(c => c.items);
        const missingIngredients = [];

        recipe.ingredients.forEach(ing => {
            const shopItem = flatShoppingList.find(item => item.name.toLowerCase() === ing.name.toLowerCase());
            if (shopItem) {
                 const totalPurchased = shopItem.purchases.reduce((sum, p) => sum + p.qty, 0);
                 if (totalPurchased < shopItem.needed.qty) {
                     missingIngredients.push(ing.name);
                 }
            } else {
                missingIngredients.push(ing.name);
            }
        });

        if (missingIngredients.length > 0) {
            this.showMissingIngredientsWarning(missingIngredients, recipeId);
        } else {
            this.showRecipe(recipeId);
        }
    },
    showRecipe(recipeId) { /* ... unchanged ... */ },
    renderRecipeStep() { /* ... unchanged ... */ },
    navigateRecipeStep(direction) { /* ... unchanged ... */ },
    finishCooking() { /* ... unchanged ... */ },
    startTimer() { /* ... unchanged ... */ },
    pauseTimer() { /* ... unchanged ... */ },
    stopTimer(finished = false) { /* ... unchanged ... */ },
    resetTimer() { /* ... unchanged ... */ },
    updateTimerDisplay() { /* ... unchanged ... */ },
    
    handleNav(e) {
        const button = e.target.closest('.nav-button');
        if (!button) return;
        
        this.dom.bottomNav.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        const contentId = button.dataset.content;
        this.dom.mainHeaderTitle.textContent = button.dataset.title;
        this.dom.mainContents.forEach(content => {
            content.classList.toggle('active', content.id === contentId);
        });
        if (contentId === 'settings-content') this.renderSettings();
    },

    showNotification(message, type = 'success') {
        this.dom.notification.textContent = message;
        this.dom.notification.className = type; // success, loading, error
        this.dom.notification.classList.add('show');

        if (type !== 'loading') {
            setTimeout(() => {
                this.dom.notification.classList.remove('show');
            }, 3000);
        }
    },

    hideNotification() {
        this.dom.notification.classList.remove('show');
    },

    showModal(title, bodyHtml, buttons) {
        this.dom.modalTitle.textContent = title;
        this.dom.modalBody.innerHTML = bodyHtml;
        this.dom.modalButtons.innerHTML = '';
        buttons.forEach(btn => {
            const buttonEl = document.createElement('button');
            buttonEl.textContent = btn.text;
            buttonEl.className = `modal-button ${btn.class}`;
            buttonEl.addEventListener('click', () => {
                btn.action();
                if (btn.closes !== false) this.hideModal();
            });
            this.dom.modalButtons.appendChild(buttonEl);
        });
        this.dom.modalOverlay.classList.add('visible');
    },

    hideModal() {
        this.dom.modalOverlay.classList.remove('visible');
    },

    openPurchaseModal(catIndex, itemIndex) {
        const item = this.state.shoppingList[catIndex].items[itemIndex];
        const totalPurchased = item.purchases.reduce((sum, p) => sum + p.qty, 0);
        const remainingQty = item.needed.qty - totalPurchased;

        const bodyHtml = `
            <p>Нужно: ${item.needed.qty} ${item.needed.unit}. Осталось купить: ${remainingQty} ${item.needed.unit}</p>
            <div class="modal-form-group">
                <label for="purchase-qty">Сколько купили (${item.needed.unit})</label>
                <input type="number" id="purchase-qty" class="modal-input" value="${remainingQty > 0 ? remainingQty : ''}" placeholder="0">
            </div>
            <div class="modal-form-group">
                <label for="purchase-price">Цена за эту покупку (₽)</label>
                <input type="number" id="purchase-price" class="modal-input" placeholder="0">
            </div>
        `;

        const buttons = [
            { text: 'Отмена', class: 'secondary', action: () => {} },
            { text: 'Сохранить', class: 'primary', action: () => {
                const qty = parseFloat(document.getElementById('purchase-qty').value) || 0;
                const price = parseFloat(document.getElementById('purchase-price').value) || 0;
                if (qty > 0) {
                    item.purchases.push({ qty, price });
                    this.saveState();
                    this.renderShoppingList();
                    this.renderBudget();
                }
            }},
        ];
        this.showModal(`Покупка: ${item.name}`, bodyHtml, buttons);
    },

    showMissingIngredientsWarning(missingItems, recipeId) { /* ... unchanged ... */ },

    // SETTINGS LOGIC
    renderSettings() {
        const s = this.state.settings;
        this.dom.settings.duration.value = s.menuDuration;
        this.dom.settings.budget.value = s.totalBudget;
        this.dom.settings.preferences.value = s.preferences;
        this.renderFamilyMembers();
    },
    saveSettings() {
        const s = this.state.settings;
        s.menuDuration = parseInt(this.dom.settings.duration.value) || 7;
        s.totalBudget = parseInt(this.dom.settings.budget.value) || 10000;
        s.preferences = this.dom.settings.preferences.value;
        this.saveState();
        this.renderBudget(); // Update budget display immediately
        this.showNotification("Настройки сохранены");
    },
    renderFamilyMembers() {
        const container = this.dom.settings.familyContainer;
        container.innerHTML = '';
        if (this.state.settings.family.length === 0) {
            container.innerHTML = '<p>Добавьте членов семьи для расчета рациона.</p>';
        }
        this.state.settings.family.forEach((person, index) => {
            const card = document.createElement('div');
            card.className = 'family-member-card';
            const genderText = person.gender === 'male' ? 'муж.' : 'жен.';
            card.innerHTML = `
                <span>${person.age} лет, ${genderText}, ${person.activity}</span>
                <button data-index="${index}" class="delete-member-btn">✖</button>
            `;
            container.appendChild(card);
        });
        container.querySelectorAll('.delete-member-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.state.settings.family.splice(e.target.dataset.index, 1);
                this.saveState();
                this.renderFamilyMembers();
            });
        });
    },
    openFamilyMemberModal() {
        const bodyHtml = `
            <div class="modal-form-group">
                <label for="member-age">Возраст</label>
                <input type="number" id="member-age" class="modal-input" placeholder="30">
            </div>
            <div class="modal-form-group">
                <label for="member-gender">Пол</label>
                <select id="member-gender" class="settings-select">
                    <option value="female">Женский</option>
                    <option value="male">Мужской</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label for="member-activity">Уровень активности</label>
                <select id="member-activity" class="settings-select">
                    <option value="sedentary">Сидячий</option>
                    <option value="light">Легкая</option>
                    <option value="moderate">Умеренная</option>
                    <option value="high">Высокая</option>
                </select>
            </div>
        `;
        const buttons = [
            { text: 'Отмена', class: 'secondary', action: () => {} },
            { text: 'Добавить', class: 'primary', action: () => {
                const newMember = {
                    age: parseInt(document.getElementById('member-age').value) || 30,
                    gender: document.getElementById('member-gender').value,
                    activity: document.getElementById('member-activity').value,
                };
                this.state.settings.family.push(newMember);
                this.saveState();
                this.renderFamilyMembers();
            }},
        ];
        this.showModal("Новый член семьи", bodyHtml, buttons);
    },
    confirmRegenerateAll() {
        this.showModal(
            "Подтверждение",
            "<p>Вы уверены, что хотите полностью перегенерировать меню, рецепты и список покупок? Все текущие данные будут удалены.</p>",
            [
                { text: 'Отмена', class: 'secondary', action: () => {} },
                { text: 'Да, перегенерировать', class: 'primary', action: () => {
                    this.state.menu = [];
                    this.state.recipes = {};
                    this.state.shoppingList = [];
                    this.startGenerationProcess(true);
                }}
            ]
        );
    },
    
    // REGENERATION
    openRegenerateModal(type, data) {
        const title = type === 'meal' ? "Перегенерировать блюдо" : "Перегенерировать день";
        const bodyHtml = `
            <p>Вы можете указать дополнительные пожелания для этого обновления.</p>
            <div class="modal-form-group">
                <label for="regen-prompt">Пожелания (необязательно)</label>
                <textarea id="regen-prompt" class="modal-textarea" rows="2" placeholder="Например: что-то более легкое"></textarea>
            </div>
        `;
        const buttons = [
            { text: 'Отмена', class: 'secondary', action: () => {} },
            { text: 'Перегенерировать', class: 'primary', closes: false, action: () => this.handleRegeneration(type, data) }
        ];
        this.showModal(title, bodyHtml, buttons);
    },

    async handleRegeneration(type, data) {
        this.hideModal();
        this.showNotification("Обновляем меню...", 'loading');
        
        try {
            if (type === 'meal') {
                const { dayName, mealKey } = data;
                const originalDayIndex = this.state.menu.findIndex(d => d && d.day === dayName);
                
                if (originalDayIndex === -1) {
                    this.showNotification("Ошибка: не удалось найти день для обновления.", 'error');
                    console.error("Could not find day for regeneration:", dayName);
                    return;
                }

                const oldMealName = this.state.menu[originalDayIndex].meals[mealKey];
                const customPrompt = document.getElementById('regen-prompt').value;
                
                const familyDescription = this.state.settings.family.map(p => `${p.gender === 'male' ? 'Мужчина' : 'Женщина'}, ${p.age} лет`).join('; ');
                const prompt = `Замени одно блюдо: ${mealKey} в ${this.state.menu[originalDayIndex].day}. Старое блюдо: "${oldMealName}". Сгенерируй новое, учитывая общие предпочтения: "${this.state.settings.preferences}" и пожелание: "${customPrompt}". Рассчитай на семью: ${familyDescription}. Верни только название нового блюда.`;
                const schema = {type: Type.OBJECT, properties: { newMealName: {type: Type.STRING}}};
                const result = await this.makeGeminiRequest(prompt, schema);
                
                this.state.menu[originalDayIndex].meals[mealKey] = result.newMealName;

            } else { // type === 'day'
                // Regenerate the whole menu for simplicity and reliability.
                await this.generateMenu();
            }
            
            // Full recalculation is needed after any change.
            await this.generateRecipes();
            await this.generateShoppingList();

            this.saveState();
            this.renderAll();
            this.showNotification("Меню успешно обновлено!");

        } catch(e) {
            this.showNotification("Ошибка при обновлении.", 'error');
            console.error(e);
        }
    },


    exportData() { /* ... unchanged ... */ },
    importData(event) { /* ... unchanged ... */ },
    
    toggleDevConsole() { /* ... unchanged ... */ },
    logToConsole(message) { /* ... unchanged ... */ },
    executeCommand(commandStr) { /* ... unchanged ... */ }
};

document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
