<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–°–ï–ú–ï–ô–ù–û–ï –ú–ï–ù–Æ</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–°–ï–ú–ï–ô–ù–û–ï –ú–ï–ù–Æ">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiB2aWV3Qm94PSIwIDAgMTAyNCAxMDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiByeD0iMjMyIiBmaWxsPSIjRjlGN0Y0Ii8+CjxwYXRoIGQ9Ik01MTIgNzM5QzQ1ologi0OSA3MzkgNDE3IDcyMC4wOSA0MTcgNjY1QzQxNyA2MDkuOTEgNDU2LjkxIDU5MSA1MTIgNTkxQzU2Ny4wOSA1OTEgNjA3IDYwOS45MSA2MDcgNjY1QzYwNyA3MjAuMDkgNTY3LjA5IDczOSA1MTIgNzM5WiIgZmlsbD0iIzhCNUUzQyIvPgo8cGF0aCBkPSJNNTEyIDcxOEM0NjguNDMgNzE4IDQzMyA2OTYuNTcgNDMzIDY2NUM0MzMgNjMzLjQzIDQ2OC44MyA2MTIgNTEyIDYxMkM1NTUuNTcgNjEyIDU5MSA2MzMuNDMgNTkxIDY2NUM1OTEgNjk2LjU3IDU1NS41NyA3MTggNTEyIDcxOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik01MTIgMzQ0QzUxMiAzNDQgNTM2IDM4NSA1MTIgNDA5QzQ4OCAzODUgNTEyIDM0NCA1MTIgMzQ0WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+CjxwYXRoIGQ9Ik00ODQgMzI2QzQ4NCAzMjYgNTAzIDM1NBC42IDQ4NCAzNzZDNA2NSAzNTguNiA0ODQgMzI2IDQ4NCAzMjZaIiBmaWxsPSIjRDRBMzcyIiBvcGFjaXR5PSIwLjUiLz4KPHBhdGggZD0iTTU0MCAzMjZDNTAxIDMyNiA1OTcgMzU4LjYgNTQwIDM3NkM1NzMgMzU4LjYgNTQwIDMyNiA1NDAgMzI2WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+Cjwvc3ZnPgo=">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiB2aWV3Qm94PSIwIDAgMTAyNCAxMDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAyNCIgaGVpZ2h0PSIxMDI0IiByeD0iMjMyIiBmaWxsPSIjRjlGN0Y0Ii8+CjxwYXRoIGQ9Ik01MTIgNzM5QzQ1ologi0OSA3MzkgNDE3IDcyMC4wOSA0MTcgNjY1QzQxNyA2MDkuOTEgNDU2LjkxIDU5MSA1MTIgNTkxQzU2Ny4wOSA1OTEgNjA3IDYwOS45MSA2MDcgNjY1QzYwNyA3MjAuMDkgNTY3LjA5IDczOSA1MTIgNzM5WiIgZmlsbD0iIzhCNUUzQyIvPgo8cGF0aCBkPSJNNTEyIDcxOEM0NjguNDMgNzE4IDQzMyA2OTYuNTcgNDMzIDY2NUM0MzMgNjMzLjQzIDQ2OC44MyA2MTIgNTEyIDYxMkM1NTUuNTcgNjEyIDU5MSA2MzMuNDMgNTkxIDY2NUM1OTEgNjk2LjU3IDU1NS41NyA3MTggNTEyIDcxOFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik01MTIgMzQ0QzUxMiAzNDQgNTM2IDM4NSA1MTIgNDA5QzQ4OCAzODUgNTEyIDM0NCA1MTIgMzQ0WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+CjxwYXRoIGQ9Ik00ODQgMzI2QzQ4NCAzMjYgNTAzIDM1NBC42IDQ4NCAzNzZDNA2NSAzNTguNiA0ODQgMzI2IDQ4NCAzMjZaIiBmaWxsPSIjRDRBMzcyIiBvcGFjaXR5PSIwLjUiLz4KPHBhdGggZD0iTTU0MCAzMjZDNTAxIDMyNiA1OTcgMzU4LjYgNTQwIDM3NkM1NzMgMzU4LjYgNTQwIDMyNiA1NDAgMzI2WiIgZmlsbD0iI0Q0QTM3MyIgb3BhY2l0eT0iMC41Ii8+Cjwvc3ZnPgo=">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
    --font-nunito: 'Nunito', sans-serif;
    --font-lato: 'Lato', sans-serif;
    --bg-color: #F9F7F4;
    --accent-color: #8B5E3C;
    --secondary-color: #D4A373;
    --success-color: #5E7A6E;
    --warning-color: #E07A5F;
    --danger-color: #D9534F;
    --text-color: #333;
    --soft-text: #7D7D7D;
    --card-bg: #FFFFFF;
    --card-accent-bg: #F0E7DD;
    --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

/* Set a readable placeholder color */
::placeholder {
  color: #888;
  opacity: 1; /* Firefox */
}
:-ms-input-placeholder { /* Internet Explorer 10-11 */
  color: #888;
}
::-ms-input-placeholder { /* Microsoft Edge */
  color: #888;
}

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: var(--font-lato);
    background-color: var(--bg-color);
    color: var(--text-color);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%238B5E3C' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.1;
    z-index: -1;
}

#app {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* --- Splash Screen --- */
#splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(160deg, #F9F7F4, #EDE0D4);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    transition: opacity 0.5s ease-out, transform 0.5s ease-out;
}
#splash-screen.hidden {
    opacity: 0;
    transform: scale(1.05);
    pointer-events: none;
}
.splash-logo {
    width: 100px;
    height: 100px;
}
.splash-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 28px;
    color: var(--accent-color);
    margin: 10px 0;
}
.splash-features {
    margin: 30px 0;
    position: relative;
    height: 60px;
    width: 100%;
    overflow: hidden;
}
.feature-slide {
    position: absolute;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0;
    transform: translateY(20px);
    animation: slide-in-out 9s linear infinite;
}
.feature-slide:nth-child(1) { animation-delay: 0s; }
.feature-slide:nth-child(2) { animation-delay: 3s; }
.feature-slide:nth-child(3) { animation-delay: 6s; }
.feature-icon { font-size: 24px; }
.feature-text { font-family: var(--font-nunito); font-weight: 700; font-size: 18px; color: var(--soft-text); margin-top: 8px;}

@keyframes slide-in-out {
    0%, 33.33%, 100% { opacity: 0; transform: translateY(20px); }
    5%, 28.33% { opacity: 1; transform: translateY(0); }
}

.splash-author {
    position: absolute;
    bottom: calc(100px + env(safe-area-inset-bottom));
    font-size: 14px;
    color: var(--soft-text);
    text-align: center;
    line-height: 1.5;
}
.splash-author a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
}


#start-app-btn {
    position: absolute;
    bottom: calc(40px + env(safe-area-inset-bottom));
    width: 80%;
    max-width: 300px;
}


.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color);
    transition: transform 0.5s var(--ease-out), opacity 0.5s var(--ease-out);
    opacity: 1;
    transform: scale(1);
    overflow-y: auto;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
}

.screen.hidden {
    transform: scale(1.05);
    opacity: 0;
    pointer-events: none;
}
.hidden { display: none !important; }

/* --- Welcome Screen --- */
#welcome-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    background: linear-gradient(160deg, #F9F7F4, #EDE0D4);
}
.welcome-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    margin-top: 30px;
    margin-bottom: 30px;
}
.welcome-info {
    font-size: 14px;
    color: var(--soft-text);
    line-height: 1.5;
    max-width: 300px;
    margin: 0 auto;
}

/* --- Setup & Preview Screens --- */
#setup-screen, #preview-screen {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    text-align: center;
    background: linear-gradient(160deg, #F9F7F4, #EDE0D4);
}

.setup-container {
    max-width: 500px;
    width: 90%;
}

.setup-logo {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
    animation: spin 10s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.setup-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 24px;
    color: var(--accent-color);
    margin: 0 0 10px;
}

.setup-subtitle {
    font-size: 16px;
    color: var(--soft-text);
    margin-bottom: 30px;
    line-height: 1.5;
}
/* Setup Wizard */
#setup-wizard {
    position: relative;
    min-height: 250px; /* Adjust as needed */
}
.wizard-step {
    opacity: 0;
    visibility: hidden;
    position: absolute;
    top:0; left:0; right: 0;
    transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    transform: translateX(20px);
}
.wizard-step.active {
    opacity: 1;
    visibility: visible;
    position: static;
    transform: translateX(0);
}
.wizard-step-title {
    font-family: var(--font-nunito);
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 10px;
}
.wizard-step-description {
    font-size: 14px;
    color: var(--soft-text);
    line-height: 1.5;
    margin-bottom: 20px;
}

#wizard-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    gap: 10px;
}
#wizard-nav button { flex-grow: 1; }
.wizard-step-counter {
    font-size: 14px;
    color: var(--soft-text);
    margin-bottom: 15px;
}

.input-group {
    position: relative;
    margin-bottom: 20px;
}

.api-key-help-link {
    display: inline-block;
    margin-bottom: 15px;
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px dashed var(--accent-color);
}

#api-key-input {
    width: 100%;
    height: 50px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 0 20px;
    font-size: 16px;
    font-family: var(--font-lato);
    outline: none;
    transition: border-color 0.3s;
    color: var(--text-color);
    background-color: var(--card-bg);
}
#api-key-input:focus {
    border-color: var(--accent-color);
}

.primary-button {
    width: 100%;
    height: 50px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
    -webkit-appearance: none;
}
.primary-button:active {
    transform: scale(0.98);
}
.primary-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}
.primary-button.reveal {
    animation: reveal 0.5s var(--ease-out) forwards;
    opacity: 0;
    transform: translateY(20px);
}
@keyframes reveal {
    to { opacity: 1; transform: translateY(0); }
}
.danger-button {
    background-color: var(--danger-color);
}
.secondary-button {
    width: 100%;
    height: 50px;
    background: var(--card-accent-bg);
    color: var(--accent-color);
    border: none;
    border-radius: 12px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    transition: transform 0.2s;
}
.secondary-button:active {
    transform: scale(0.98);
}
/* Generation Progress */
#generation-progress {
    width: 100%;
}
.progress-bar-container {
    width: 100%;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 20px 0;
}
#progress-bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    transition: width 0.5s var(--ease-out);
}
#progress-status {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    color: var(--accent-color);
    margin-bottom: 5px;
    min-height: 25px;
}
#progress-details {
    font-size: 14px;
    color: var(--soft-text);
    min-height: 40px;
    line-height: 1.4;
}

/* --- Preview Screen --- */
#preview-menu-container {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 20px;
    width: 100%;
    max-height: 60vh;
    overflow-y: auto;
}
.preview-day {
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 10px;
}
.preview-day:last-child { border-bottom: none; margin-bottom: 0; }
.preview-day-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 18px;
    color: var(--accent-color);
    text-align: left;
    margin: 0 0 10px 0;
}
.preview-meal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 15px;
}
.preview-meal-name {
    text-align: left;
    flex-grow: 1;
}
.preview-meal .regenerate-btn {
    flex-shrink: 0;
    margin-left: 10px;
}
.preview-buttons {
    display: flex;
    gap: 15px;
    width: 100%;
    margin-top: 20px;
}

/* --- Main Screen --- */
#main-screen {
    padding: 0;
    padding-top: env(safe-area-inset-top);
    display: flex;
    flex-direction: column;
}
.main-header {
    padding: 15px 20px;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#main-header-title {
    font-family: var(--font-nunito);
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-color);
    margin: 0;
}
#open-settings-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    line-height: 0;
}
#open-settings-btn svg {
    stroke: var(--accent-color);
    width: 28px;
    height: 28px;
}

.content-area {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
}
.bottom-nav {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: #fff;
    border-top: 1px solid #eee;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    flex-shrink: 0;
}
.nav-button {
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
    font-size: 12px;
    color: var(--soft-text);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: color 0.2s;
    flex-grow: 1;
}
.nav-button svg {
    width: 24px;
    height: 24px;
    stroke: var(--soft-text);
    transition: stroke 0.2s;
}
.nav-button.active, .nav-button:active {
    color: var(--accent-color);
}
.nav-button.active svg, .nav-button:active svg {
    stroke: var(--accent-color);
}
.main-content {
    display: none;
}
.main-content.active {
    display: block;
    animation: fadeIn 0.5s var(--ease-out);
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- Menu Screen (New Design) --- */
#date-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0 20px;
}
.date-nav-arrow {
    background: none;
    border: none;
    font-size: 28px;
    color: var(--secondary-color);
    cursor: pointer;
    padding: 0 15px;
    transition: color 0.2s, transform 0.2s;
}
.date-nav-arrow:hover {
    color: var(--accent-color);
}
.date-nav-arrow:active {
    transform: scale(0.9);
}
#current-date-display {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-transform: uppercase;
}
#daily-menu-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.regenerate-btn {
    background: none; border: none; cursor: pointer; opacity: 0.5; transition: opacity 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
.regenerate-btn:hover { opacity: 1; }
.regenerate-icon {
    width: 20px; height: 20px;
    color: var(--secondary-color);
    transition: color 0.2s;
}
.regenerate-btn:hover .regenerate-icon {
    color: var(--accent-color);
    transform: scale(1.1);
}
.meal {
    display: flex;
    align-items: center;
    position: relative;
    background-color: var(--card-bg);
    border-radius: 16px;
    padding: 15px;
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--accent-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    font-size: 18px;
}
.meal-icon {
    margin-right: 15px;
    font-size: 20px;
    transition: opacity 0.3s;
}
.meal-name {
    flex-grow: 1;
    transition: opacity 0.3s;
    padding-right: 30px; /* Space for regenerate button */
}
.meal.placeholder {
    color: #ccc;
}
.meal.clickable {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.meal .regenerate-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
}
.meal.clickable:active {
    transform: scale(0.99);
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.leftover-icon {
    font-size: 16px;
    opacity: 0.5;
    margin-left: 8px;
    color: var(--secondary-color);
}
.cooked-toggle {
    background: none; border: none; cursor: pointer;
    width: 28px; height: 28px;
    margin-right: 10px;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    border: 2px solid #ccc;
    color: #ccc;
    transition: all 0.3s var(--ease-out);
}
.cooked-toggle svg {
    width: 18px; height: 18px;
    fill: currentColor;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s var(--ease-out);
}
.meal.cooked .cooked-toggle {
    border-color: var(--success-color);
    background-color: var(--success-color);
    color: white;
}
.meal.cooked .cooked-toggle svg {
    opacity: 1;
    transform: scale(1);
}
.meal.cooked .meal-name, .meal.cooked .meal-icon {
    opacity: 0.6;
    text-decoration: line-through;
}
.meal.cooked.clickable {
    color: var(--soft-text);
}


/* --- Recipe Screen --- */
#recipe-screen {
    background-color: #fff;
    transform: translateX(100%);
    z-index: 10;
}
#recipe-screen.active {
    transform: translateX(0);
}
.recipe-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0 15px 0;
}
.back-button {
    background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: var(--accent-color); font-weight: 600; display: flex; align-items: center;
}
#recipe-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-align: center;
    flex-grow: 1;
}
#step-indicator {
    font-size: 18px;
    color: var(--secondary-color);
    font-family: var(--font-nunito);
    font-weight: 600;
}
#step-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    background-color: #eee;
    transition: opacity 0.3s;
}
#step-description {
    font-size: 18px;
    line-height: 1.6;
    margin: 20px 0;
}
.timer-container {
    background-color: var(--card-accent-bg);
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
}
#timer-display {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 48px;
    color: var(--accent-color);
    letter-spacing: 2px;
}
.timer-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 15px;
}
.timer-button {
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: transform 0.2s;
}
.timer-button:active { transform: scale(0.95); }
#start-timer-btn { background-color: var(--success-color); color: white; }
#pause-timer-btn { background-color: var(--warning-color); color: white; }
#reset-timer-btn { background-color: #ccc; color: #333; }

#step-ingredients-title {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    margin-top: 20px;
}
#step-ingredients {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}
#step-ingredients li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 16px;
}
.ingredient-status {
    margin-right: 12px;
    font-size: 20px;
}
.ingredient-status.completed { color: var(--success-color); }
.ingredient-status.missing { color: var(--warning-color); }
.ingredient-status.unknown { color: #ccc; }
.ingredient-quantity {
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--soft-text);
}

.recipe-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}
.nav-btn-recipe {
    background: var(--card-accent-bg);
    color: var(--accent-color);
    border: none;
    border-radius: 12px;
    padding: 15px 30px;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
}
.nav-btn-recipe:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
#step-ingredients-title.hidden {
    display: none;
}


/* --- Shopping List --- */
#shopping-list-content { padding-bottom: 50px; }
.progress-bar-shopping {
    width: 100%;
    height: 8px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0 20px;
}
#shopping-progress {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    transition: width 0.5s var(--ease-out);
}
#shopping-progress-text {
    font-size: 14px;
    color: var(--soft-text);
    margin-bottom: 10px;
}
.category-toggle {
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    padding: 15px 0;
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 18px;
    color: var(--accent-color);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}
.category-items {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.5s var(--ease-out), padding 0.5s var(--ease-out);
}
.category-items.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
}
.shopping-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
}

.item-checkbox-progress {
    width: 24px; height: 24px;
    position: relative;
    margin-right: 15px;
    flex-shrink: 0;
}
.item-checkbox-progress svg {
    width: 100%; height: 100%;
    transform: rotate(-90deg);
}
.item-checkbox-progress circle {
    fill: none;
    stroke-width: 2.5;
}
.item-checkbox-progress .bg { stroke: #ccc; }
.item-checkbox-progress .progress { stroke: var(--success-color); transition: stroke-dasharray 0.3s linear; }
.item-checkbox-progress .checkmark {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    color: var(--success-color);
    font-size: 16px;
    transition: transform 0.2s var(--ease-out);
}
.shopping-item.completed .item-checkbox-progress .checkmark {
    transform: translate(-50%, -50%) scale(1);
}

.item-details {
    flex-grow: 1;
    transition: color 0.3s;
}
.item-name {
    font-size: 16px;
    font-weight: 600;
}
.item-quantity {
    font-size: 13px;
    color: var(--soft-text);
    line-height: 1.4;
}
.item-price {
    font-family: var(--font-nunito);
    font-weight: 700;
    font-size: 16px;
    color: var(--accent-color);
}
.shopping-item.completed .item-details { color: #aaa; }
.shopping-item.completed .item-name { text-decoration: line-through; }


#shopping-list-total {
    margin-top: 20px;
    padding: 20px;
    background-color: var(--card-accent-bg);
    border-radius: 16px;
    text-align: center;
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 20px;
    color: var(--accent-color);
}
#shopping-list-total span { font-weight: 400; font-size: 16px; }

/* --- Budget Screen --- */
#budget-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.budget-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.pie-chart-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin-bottom: 20px;
}
.pie-chart {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}
.pie-chart circle {
    fill: none;
    stroke-width: 32;
    transition: stroke-dasharray 0.8s var(--ease-out);
}
.chart-center-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 28px;
    color: var(--accent-color);
}
.chart-center-text span {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--soft-text);
}
.budget-summary {
    width: 100%;
    text-align: center;
}
.budget-summary p {
    margin: 8px 0;
    font-size: 16px;
}
.budget-summary .amount {
    font-family: var(--font-nunito);
    font-weight: 700;
}
.budget-summary #budget-remaining.ok {
    color: var(--success-color);
}
.budget-summary #budget-remaining.warning {
    color: var(--warning-color);
}

#bar-chart {
    width: 100%;
    height: 150px;
    display: flex;
    justify-content: space-around;
    align-items: flex-end;
    gap: 5px;
    padding: 10px 0;
}
.bar-chart-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.bar {
    width: 80%;
    background-color: var(--secondary-color);
    border-radius: 4px 4px 0 0;
    transition: height 0.5s var(--ease-out);
    position: relative;
}
.bar .bar-value {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--accent-color);
    background: rgba(255,255,255,0.7);
    padding: 1px 4px;
    border-radius: 4px;
    white-space: nowrap;
}
.bar-label {
    margin-top: 5px;
    font-size: 12px;
    color: var(--soft-text);
}


/* --- Settings Screen --- */
#settings-screen {
    background-color: var(--bg-color);
    transform: translateX(100%);
    z-index: 10;
    padding: 0;
    padding-top: env(safe-area-inset-top);
}
#settings-screen.active {
    transform: translateX(0);
}
#settings-content {
    padding: 20px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    height: calc(100% - 56px - env(safe-area-inset-top)); /* Adjust based on header height */
    overflow-y: auto;
}
#settings-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    text-align: center;
    flex-grow: 1;
    margin: 0;
}

.settings-section {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.settings-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 20px;
    color: var(--accent-color);
    margin: 0 0 20px 0;
}
.settings-form-group {
    margin-bottom: 15px;
}
.settings-form-group label {
    display: block;
    font-family: var(--font-nunito);
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 8px;
    text-align: left;
}
.settings-input, .settings-textarea, .settings-select {
    width: 100%;
    height: 45px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0 15px;
    font-size: 16px;
    font-family: var(--font-lato);
    background: #fff;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    color: var(--text-color);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}
.settings-textarea {
    height: auto;
    padding-top: 10px;
    padding-bottom: 10px;
    resize: vertical;
    background-image: none;
}
.wizard-step .settings-select {
    height: 50px;
}
.wizard-step .settings-input {
    height: 50px;
}
.wizard-step .settings-textarea {
     height: 60px;
}

.family-member-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--card-accent-bg);
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
}
.family-member-card button {
    background: none; border: none; font-size: 20px; cursor: pointer; color: var(--danger-color); opacity: 0.7;
}

.install-instructions {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--card-accent-bg);
    padding: 15px;
    border-radius: 12px;
}
.install-icon {
    font-size: 24px;
}
.install-text {
    font-size: 14px;
    line-height: 1.5;
}
.sync-info {
    font-size: 14px;
    line-height: 1.5;
    background-color: var(--card-accent-bg);
    padding: 15px;
    border-radius: 12px;
    color: var(--soft-text);
}
.sync-info strong {
    color: var(--accent-color);
}
.sync-info a {
    color: var(--accent-color);
    font-weight: 600;
    text-decoration: none;
}

/* --- Dev Console --- */
#dev-console {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 30vh;
    background-color: rgba(0,0,0,0.9);
    color: #e0e0e0;
    border-top: 1px solid var(--secondary-color);
    transform: translateY(100%);
    transition: transform 0.4s var(--ease-out);
    z-index: 100;
    display: flex;
    flex-direction: column;
}
#dev-console.visible {
    transform: translateY(0);
}
#log-output {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 12px;
}
#log-output p { margin: 2px 0; }
#command-input {
    width: 100%;
    background: #333;
    border: none;
    border-top: 1px solid #555;
    color: #e0e0e0;
    padding: 10px;
    font-family: 'Courier New', Courier, monospace;
    outline: none;
}

/* --- Notification --- */
#notification {
    position: fixed;
    top: env(safe-area-inset-top, 0);
    left: 50%;
    transform: translate(-50%, -150%);
    background-color: var(--success-color);
    color: white;
    padding: 12px 25px;
    border-radius: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-family: var(--font-nunito);
    font-weight: 700;
    z-index: 200;
    transition: transform 0.5s var(--ease-out);
}
#notification.show {
    transform: translate(-50%, 20px);
}
#notification.loading {
    background-color: var(--secondary-color);
}
#notification.error {
    background-color: var(--danger-color);
}

/* --- Modal --- */
#modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-out);
}
#modal-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
.modal-content {
    background: var(--card-bg);
    padding: 25px;
    border-radius: 24px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transform: scale(0.95);
    transition: transform 0.3s var(--ease-out);
}
#modal-overlay.visible .modal-content {
    transform: scale(1);
}
.modal-title {
    font-family: var(--font-nunito);
    font-weight: 800;
    font-size: 22px;
    color: var(--accent-color);
    margin: 0 0 20px;
    text-align: center;
}
.modal-body {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-color);
    margin-bottom: 25px;
    text-align: left;
    max-height: 60vh;
    overflow-y: auto;
}
.modal-body ul {
    padding-left: 20px;
}
.modal-body ul li {
    margin-bottom: 8px;
}
.modal-form-group {
    margin-bottom: 15px;
}
.modal-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--soft-text);
}
.modal-input, .modal-textarea {
    width: 100%;
    height: 45px;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 0 15px;
    font-size: 16px;
    font-family: var(--font-lato);
    color: var(--text-color);
    background-color: var(--card-bg);
}
.modal-textarea {
    height: auto;
    padding-top: 10px;
    padding-bottom: 10px;
    resize: vertical;
}
.modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.modal-button {
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-family: var(--font-nunito);
    font-weight: 700;
    cursor: pointer;
    width: 100%;
}
.modal-button.secondary {
    background-color: #eee;
    color: #333;
}
.modal-button.primary {
    background-color: var(--accent-color);
    color: white;
}
</style>
</head>
<body>

<div id="app">
    <!-- –≠–∫—Ä–∞–Ω-–∑–∞—Å—Ç–∞–≤–∫–∞ -->
    <div class="screen" id="splash-screen">
        <svg class="splash-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#F0E7DD"/><path d="M50,10 A40,40 0 0,1 90,50" fill="none" stroke="#8B5E3C" stroke-width="8"/><path d="M50,90 A40,40 0 0,1 10,50" fill="none" stroke="#D4A373" stroke-width="8"/><circle cx="50" cy="50" r="20" fill="#fff"/><path d="M50 38 C 55 42, 55 48, 50 52 S 45 58, 50 62" stroke="#5E7A6E" stroke-width="4" fill="none" stroke-linecap="round"/></svg>
        <h1 class="splash-title">–°–ï–ú–ï–ô–ù–û–ï –ú–ï–ù–Æ</h1>
        <div class="splash-features">
            <div class="feature-slide">
                <div class="feature-icon">üóìÔ∏è</div>
                <div class="feature-text">–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
            <div class="feature-slide">
                <div class="feature-icon">üõí</div>
                <div class="feature-text">–°–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ —É–º–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</div>
            </div>
            <div class="feature-slide">
                <div class="feature-icon">üë©‚Äçüç≥</div>
                <div class="feature-text">–ì–æ—Ç–æ–≤—å—Ç–µ –ª–µ–≥–∫–æ –ø–æ —à–∞–≥–∞–º</div>
            </div>
        </div>
        <div class="splash-author">
          –ê–≤—Ç–æ—Ä: –ö–ª–∏–º–æ–≤ –ï–≤–≥–µ–Ω–∏–π<br>
          <a href="https://t.me/eklimov" target="_blank">Telegram: @eklimov</a>
        </div>
        <button class="primary-button" id="start-app-btn">–ù–∞—á–∞—Ç—å</button>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
    <div class="screen hidden" id="welcome-screen">
        <div class="setup-container">
            <svg class="setup-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#F0E7DD"/><path d="M50,10 A40,40 0 0,1 90,50" fill="none" stroke="#8B5E3C" stroke-width="8"/><path d="M50,90 A40,40 0 0,1 10,50" fill="none" stroke="#D4A373" stroke-width="8"/><circle cx="50" cy="50" r="20" fill="#fff"/><path d="M50 38 C 55 42, 55 48, 50 52 S 45 58, 50 62" stroke="#5E7A6E" stroke-width="4" fill="none" stroke-linecap="round"/></svg>
            <h1 class="setup-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <p class="setup-subtitle">–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å?</p>
            <div class="welcome-buttons">
                <button class="primary-button" id="start-setup-wizard-btn">üöÄ –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É</button>
                <button class="secondary-button" id="load-from-file-btn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
            </div>
            <p class="welcome-info">–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É.</p>
        </div>
    </div>


    <!-- –≠–∫—Ä–∞–Ω –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
    <div class="screen hidden" id="setup-screen">
        <div class="setup-container">
            <svg class="setup-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#F0E7DD"/><path d="M50,10 A40,40 0 0,1 90,50" fill="none" stroke="#8B5E3C" stroke-width="8"/><path d="M50,90 A40,40 0 0,1 10,50" fill="none" stroke="#D4A373" stroke-width="8"/><circle cx="50" cy="50" r="20" fill="#fff"/><path d="M50 38 C 55 42, 55 48, 50 52 S 45 58, 50 62" stroke="#5E7A6E" stroke-width="4" fill="none" stroke-linecap="round"/></svg>
            <h1 class="setup-title">–°–ï–ú–ï–ô–ù–û–ï –ú–ï–ù–Æ</h1>
            <p class="setup-subtitle">–í–∞—à –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –≤–∫—É—Å–Ω—ã—Ö –∏ –ø—Ä–æ—Å—Ç—ã—Ö —Å–µ–º–µ–π–Ω—ã—Ö –æ–±–µ–¥–æ–≤.</p>
            <p class="wizard-step-counter" id="wizard-step-counter"></p>
            
            <div id="setup-wizard">
                <div class="wizard-step" data-step="1">
                    <h3 class="wizard-step-title">–®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ò–ò</h3>
                    <p class="wizard-step-description">–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —É–∫–∞–∂–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –¥–ª—è Google Gemini.</p>
                    <a href="#" id="api-key-help-link" class="api-key-help-link">–ì–¥–µ –≤–∑—è—Ç—å –∫–ª—é—á? –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>
                    <div class="input-group">
                        <input type="password" id="api-key-input" placeholder="–í–∞—à Google Gemini API –∫–ª—é—á">
                    </div>
                </div>

                <div class="wizard-step" data-step="2">
                    <h3 class="wizard-step-title">–®–∞–≥ 2: –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π —Å–µ–º—å–µ</h3>
                    <p class="wizard-step-description">–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç –ò–ò —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –∫–∞–∂–¥–æ–≥–æ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏.</p>
                    <div id="wizard-family-members-container"></div>
                    <button class="secondary-button" id="wizard-add-family-member-btn" style="height: 45px; font-size: 16px;">+ –î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏</button>
                </div>

                <div class="wizard-step" data-step="3">
                    <h3 class="wizard-step-title">–®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∞—à–µ –º–µ–Ω—é</h3>
                    <p class="wizard-step-description">–£–∫–∞–∂–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
                    <div class="settings-form-group">
                        <label for="wizard-menu-duration">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –º–µ–Ω—é</label>
                        <input type="number" id="wizard-menu-duration" class="settings-input" min="1" max="14">
                    </div>
                    <div class="settings-form-group">
                        <label for="wizard-total-budget">–û–±—â–∏–π –±—é–¥–∂–µ—Ç, ‚ÇΩ</label>
                        <input type="number" id="wizard-total-budget" class="settings-input" step="500">
                    </div>
                    <div class="settings-form-group">
                        <label for="wizard-preferences">–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –∞–ª–ª–µ—Ä–≥–∏–∏</label>
                        <textarea id="wizard-preferences" class="settings-textarea" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ —Ä—ã–±—ã, –º–µ–Ω—å—à–µ –∂–∞—Ä–µ–Ω–æ–≥–æ"></textarea>
                    </div>
                    <div class="settings-form-group">
                        <label for="wizard-cuisine">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –∫—É—Ö–Ω—è</label>
                        <select id="wizard-cuisine" class="settings-select">
                            <option value="–õ—é–±–∞—è">–õ—é–±–∞—è</option>
                            <option value="–†—É—Å—Å–∫–∞—è">–†—É—Å—Å–∫–∞—è</option>
                            <option value="–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è">–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è</option>
                            <option value="–ê–∑–∏–∞—Ç—Å–∫–∞—è">–ê–∑–∏–∞—Ç—Å–∫–∞—è</option>
                            <option value="–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∞—è">–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∞—è</option>
                            <option value="–ö–∞–≤–∫–∞–∑—Å–∫–∞—è">–ö–∞–≤–∫–∞–∑—Å–∫–∞—è</option>
                        </select>
                    </div>
                     <div class="settings-form-group">
                        <label for="wizard-difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å –±–ª—é–¥</label>
                        <select id="wizard-difficulty" class="settings-select">
                            <option value="–õ—é–±–∞—è">–õ—é–±–∞—è</option>
                            <option value="–ü—Ä–æ—Å—Ç–∞—è">–ü—Ä–æ—Å—Ç–∞—è (–±—ã—Å—Ç—Ä–æ –∏ –ª–µ–≥–∫–æ)</option>
                            <option value="–°—Ä–µ–¥–Ω—è—è">–°—Ä–µ–¥–Ω—è—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã)</option>
                            <option value="–°–ª–æ–∂–Ω–∞—è">–°–ª–æ–∂–Ω–∞—è (–¥–ª—è –æ—Å–æ–±—ã—Ö —Å–ª—É—á–∞–µ–≤)</option>
                        </select>
                    </div>
                </div>

                <div class="wizard-step" data-step="4">
                    <h3 class="wizard-step-title">–í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –º–∞–≥–∏–∏!</h3>
                    <p class="wizard-step-description">–ú—ã —Å–æ–±—Ä–∞–ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—à –ò–ò —Å–æ–∑–¥–∞–ª –≤–∞—à–µ –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–µ–º–µ–π–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é.</p>
                </div>
            </div>
            
            <div id="wizard-nav" class="hidden">
                 <button class="secondary-button" id="wizard-back-btn">–ù–∞–∑–∞–¥</button>
                 <button class="primary-button" id="wizard-next-btn">–î–∞–ª–µ–µ</button>
            </div>

            <div id="generation-progress" class="hidden">
                <div id="progress-status"></div>
                <div class="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <div id="progress-details"></div>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div class="screen hidden" id="preview-screen">
        <div class="setup-container">
            <h1 class="setup-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–Ω—é</h1>
            <p class="setup-subtitle">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ª—é–±–æ–µ –±–ª—é–¥–æ –∏–ª–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ.</p>
            <div id="preview-menu-container"></div>
            <div class="preview-buttons">
                <button class="secondary-button" id="preview-regenerate-all-btn">–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤—Å—ë</button>
                <button class="primary-button" id="preview-accept-btn">–ü—Ä–∏–Ω—è—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
    <div class="screen hidden" id="main-screen">
        <header class="main-header">
            <h1 id="main-header-title">–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
            <button id="open-settings-btn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
        </header>
        <div class="content-area">
            <div class="main-content active" id="menu-content">
                <div id="date-selector">
                    <button id="prev-day-btn" class="date-nav-arrow" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å">‚óÄÔ∏é</button>
                    <div id="current-date-display"></div>
                    <button id="next-day-btn" class="date-nav-arrow" aria-label="–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å">‚ñ∂Ô∏é</button>
                </div>
                <div id="daily-menu-container"></div>
            </div>
            <div class="main-content" id="shopping-list-content">
                <p id="shopping-progress-text">0/0 –∫—É–ø–ª–µ–Ω–æ</p>
                <div class="progress-bar-shopping">
                    <div id="shopping-progress"></div>
                </div>
                <div id="shopping-list-container"></div>
                <div id="shopping-list-total"><span>–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—É–º–º–∞:</span> 0 ‚ÇΩ</div>
            </div>
            <div class="main-content" id="budget-content">
                <div class="budget-container">
                    <div class="pie-chart-container">
                        <svg class="pie-chart" viewBox="0 0 36 36">
                          <circle cx="18" cy="18" r="15.9155" stroke="#eee" stroke-width="32" fill="#fff"/>
                          <circle class="pie-slice" id="pie-products" cx="18" cy="18" r="15.9155" stroke="#8B5E3C" stroke-dasharray="0, 100"/>
                        </svg>
                        <div class="chart-center-text" id="budget-spent-total">0 ‚ÇΩ <span>–ø–æ—Ç—Ä–∞—á–µ–Ω–æ</span></div>
                    </div>
                    <div class="budget-summary">
                        <p>–ë—é–¥–∂–µ—Ç: <span class="amount" id="budget-total">10000 ‚ÇΩ</span></p>
                        <p>–û—Å—Ç–∞–ª–æ—Å—å: <span class="amount ok" id="budget-remaining">10000 ‚ÇΩ</span></p>
                    </div>
                </div>
                <div id="budget-chart-container" class="settings-section">
                    <h3 class="settings-title">–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ (7 –¥–Ω–µ–π)</h3>
                    <div id="bar-chart"></div>
                </div>
            </div>
        </div>
        <nav class="bottom-nav">
            <button class="nav-button active" data-content="menu-content" data-title="–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                –ú–µ–Ω—é
            </button>
            <button class="nav-button" data-content="shopping-list-content" data-title="–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫">
                <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-6.817a.5.5 0 00-.47-.665H5.25l-.838-3.141A.5.5 0 003.838 3H2.25zM7.5 14.25v3H6a3 3 0 01-3-3h4.5zM16.5 14.25v3h1.5a3 3 0 003-3h-4.5z" /></svg>
                –ü–æ–∫—É–ø–∫–∏
            </button>
            <button class="nav-button" data-content="budget-content" data-title="–ë—é–¥–∂–µ—Ç">
                 <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25-2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 3a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m15 0a2.25 2.25 0 01-2.25 2.25H9.75a2.25 2.25 0 01-2.25-2.25M15 12a2.25 2.25 0 00-2.25-2.25H9.75A2.25 2.25 0 007.5 12m7.5 0v6M7.5 12v6m7.5-6H9.75" /></svg>
                –ë—é–¥–∂–µ—Ç
            </button>
        </nav>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Ä–µ—Ü–µ–ø—Ç–∞ -->
    <div class="screen hidden" id="recipe-screen">
        <header class="recipe-header">
            <button class="back-button" id="back-to-menu-btn">‚óÄÔ∏é –ù–∞–∑–∞–¥</button>
            <h2 id="recipe-title"></h2>
            <span id="step-indicator"></span>
        </header>
        <div id="recipe-content">
            <img id="step-image" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–≥–∞">
            <p id="step-description"></p>
            <div class="timer-container hidden" id="timer-section">
                <div id="timer-display">00:00</div>
                <div class="timer-controls">
                    <button class="timer-button" id="start-timer-btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                    <button class="timer-button" id="pause-timer-btn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                    <button class="timer-button" id="reset-timer-btn">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
                </div>
            </div>
            <h3 id="step-ingredients-title">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –Ω–∞ —ç—Ç–æ–º —à–∞–≥–µ:</h3>
            <ul id="step-ingredients"></ul>
            <div class="recipe-nav">
                <button class="nav-btn-recipe" id="prev-step-btn">‚Üê –ù–∞–∑–∞–¥</button>
                <button class="nav-btn-recipe" id="next-step-btn">–î–∞–ª–µ–µ ‚Üí</button>
            </div>
        </div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω –ù–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="screen hidden" id="settings-screen">
        <header class="recipe-header" style="padding: 15px 20px; border-bottom: 1px solid #eee;">
            <button class="back-button" id="close-settings-btn">‚óÄÔ∏é –ù–∞–∑–∞–¥</button>
            <h2 id="settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <span style="width: 50px;"></span> <!-- Spacer -->
        </header>
        <div id="settings-content">
            <div class="settings-section">
                <h3 class="settings-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ–Ω—é</h3>
                <div class="settings-form-group">
                    <label for="settings-menu-duration">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –º–µ–Ω—é</label>
                    <input type="number" id="settings-menu-duration" class="settings-input" min="1" max="14">
                </div>
                <div class="settings-form-group">
                    <label for="settings-total-budget">–û–±—â–∏–π –±—é–¥–∂–µ—Ç, ‚ÇΩ</label>
                    <input type="number" id="settings-total-budget" class="settings-input" step="500">
                </div>
                <div class="settings-form-group">
                    <label for="settings-cuisine">–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –∫—É—Ö–Ω—è</label>
                    <select id="settings-cuisine" class="settings-select">
                        <option value="–õ—é–±–∞—è">–õ—é–±–∞—è</option>
                        <option value="–†—É—Å—Å–∫–∞—è">–†—É—Å—Å–∫–∞—è</option>
                        <option value="–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è">–ò—Ç–∞–ª—å—è–Ω—Å–∫–∞—è</option>
                        <option value="–ê–∑–∏–∞—Ç—Å–∫–∞—è">–ê–∑–∏–∞—Ç—Å–∫–∞—è</option>
                        <option value="–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∞—è">–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∞—è</option>
                        <option value="–ö–∞–≤–∫–∞–∑—Å–∫–∞—è">–ö–∞–≤–∫–∞–∑—Å–∫–∞—è</option>
                    </select>
                </div>
                 <div class="settings-form-group">
                    <label for="settings-difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å –±–ª—é–¥</label>
                    <select id="settings-difficulty" class="settings-select">
                        <option value="–õ—é–±–∞—è">–õ—é–±–∞—è</option>
                        <option value="–ü—Ä–æ—Å—Ç–∞—è">–ü—Ä–æ—Å—Ç–∞—è (–±—ã—Å—Ç—Ä–æ –∏ –ª–µ–≥–∫–æ)</option>
                        <option value="–°—Ä–µ–¥–Ω—è—è">–°—Ä–µ–¥–Ω—è—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã)</option>
                        <option value="–°–ª–æ–∂–Ω–∞—è">–°–ª–æ–∂–Ω–∞—è (–¥–ª—è –æ—Å–æ–±—ã—Ö —Å–ª—É—á–∞–µ–≤)</option>
                    </select>
                </div>
                <div class="settings-form-group">
                    <label for="settings-preferences">–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –∞–ª–ª–µ—Ä–≥–∏–∏</label>
                    <textarea id="settings-preferences" class="settings-textarea" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–µ–∑ —Ä—ã–±—ã, –º–µ–Ω—å—à–µ –∂–∞—Ä–µ–Ω–æ–≥–æ"></textarea>
                </div>
                <button class="primary-button" id="save-settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

            <div class="settings-section">
                <h3 class="settings-title">–°–æ—Å—Ç–∞–≤ —Å–µ–º—å–∏</h3>
                <div id="family-members-container"></div>
                <button class="secondary-button" id="add-family-member-btn" style="height: 45px; font-size: 16px;">+ –î–æ–±–∞–≤–∏—Ç—å —á–ª–µ–Ω–∞ —Å–µ–º—å–∏</button>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                <button class="primary-button" id="export-btn">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
                <button class="primary-button" id="import-btn" style="margin-top: 10px;">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
                <div class="sync-info" style="margin-top: 15px;">
                    <strong>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</strong> –ß—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ª—é–±–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä. –ù–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å", —á—Ç–æ–±—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.
                </div>
                 <button class="secondary-button" id="run-wizard-btn" style="margin-top: 20px; height: 45px; font-size: 16px;">–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="primary-button" id="regenerate-all-btn" style="margin-top: 10px;">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë –º–µ–Ω—é</button>
            </div>
            
             <div class="settings-section">
                <h3 class="settings-title">API-–∫–ª—é—á</h3>
                <div class="settings-form-group">
                    <label for="settings-api-key">Google Gemini API Key</label>
                    <input type="password" id="settings-api-key" class="settings-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–ª—é—á">
                </div>
                <button class="primary-button" id="save-api-key-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>


            <div class="settings-section">
                <h3 class="settings-title">–ö–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                <div class="install-instructions">
                    <span class="install-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.5V3M7.5 7.5L12 3l4.5 4.5M18 13.5v5.25c0 .93-.75 1.68-1.68 1.68H7.68c-.93 0-1.68-.75-1.68-1.68v-5.25"/></svg>
                    </span>
                    <div class="install-text">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –∞ –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ "–ù–∞ —ç–∫—Ä–∞–Ω '–î–æ–º–æ–π'", —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ.</div>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-title">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                <p id="app-version-info" style="color: var(--soft-text); font-size: 14px; margin-bottom: 15px;"></p>
                <button class="secondary-button" id="show-changelog-btn" style="height: 45px; font-size: 16px;">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</button>
                <div class="sync-info" style="margin-top: 15px;">
                    –ê–≤—Ç–æ—Ä: –ö–ª–∏–º–æ–≤ –ï–≤–≥–µ–Ω–∏–π<br>
                    <a href="https://t.me/eklimov" target="_blank">–°–≤—è–∑–∞—Ç—å—Å—è –≤ Telegram</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modal-title"></h3>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-buttons" id="modal-buttons"></div>
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
    <div id="dev-console">
        <div id="log-output"></div>
        <input type="text" id="command-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É...">
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification"></div>
</div>

<audio id="notification-sound" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YU9vT18="></audio>

<script type="module">
import { GoogleGenAI, Type } from "https://esm.run/@google/genai";

const app = {
    version: '1.4.0',
    changelog: {
        '1.4.0': [
            '–£–ª—É—á—à–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã.',
            '–î–æ–±–∞–≤–ª–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã –≤—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ –≤ –∫—É—Ä—Å–µ –Ω–æ–≤—à–µ—Å—Ç–≤.',
            '–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞–ª –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ —É–¥–æ–±–Ω—ã–º.'
        ],
        '1.3.0': [
            '–î–æ–±–∞–≤–ª–µ–Ω —ç–∫—Ä–∞–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–Ω—é –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.',
            '–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–ª—é–¥ –∏ –¥–Ω–µ–π.',
            '–ó–∞–º–µ–Ω–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é.',
            '–í —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –∫ –ø–æ–∫—É–ø–∫–µ.',
            '–ü—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –±–ª—é–¥–∞ –∫–∞–∫ "–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ" –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∏–∑ –∑–∞–ø–∞—Å–æ–≤.',
            '–ù–∞ —ç–∫—Ä–∞–Ω –±—é–¥–∂–µ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.',
        ],
        '1.2.0': [
            '–î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –∏ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.',
            '–ü—Ä–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–Ω—é —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.',
            '–£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤ –±–ª—é–¥ –≤ –º–µ–Ω—é, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.',
            '–û–±–Ω–æ–≤–ª–µ–Ω –¥–∏–∑–∞–π–Ω –∫–Ω–æ–ø–∫–∏ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.',
            '–£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.',
        ],
        '1.1.0': [
            '–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞—Å—Ç–∞–≤–∫–∞-–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è.',
            '–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫—É—Ö–Ω—è, —Å–ª–æ–∂–Ω–æ—Å—Ç—å, –≤—Ä–µ–º—è).',
            '–£–ª—É—á—à–µ–Ω –ò–ò –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫ —Å —É—á–µ—Ç–æ–º "–º–∞–≥–∞–∑–∏–Ω–Ω—ã—Ö" –µ–¥–∏–Ω–∏—Ü.',
            '–í —à–∞–≥–∞—Ö —Ä–µ—Ü–µ–ø—Ç–∞ —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.',
            '–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è "–ü–æ–ø—Ä–æ—Å–∏—Ç—å –∫—É–ø–∏—Ç—å" –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã.',
        ],
        '1.0.0': ['–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–ø—É—Å–∫.'],
    },
    state: {
        settings: {
            apiKey: null,
            family: [],
            preferences: "–ë–µ–∑ —Ä—ã–±—ã, –±–µ–∑ –≥—Ä–∏–±–æ–≤",
            menuDuration: 7,
            totalBudget: 10000,
            cuisine: "–õ—é–±–∞—è",
            difficulty: "–õ—é–±–∞—è",
        },
        menu: [],
        recipes: {},
        shoppingList: [],
        cookedMeals: {},
        timestamp: null,
        currentDayIndex: 0,
    },
    
    tempState: null, // For preview screen
    dom: {},
    wizard: {
        currentStep: 1,
        totalSteps: 4,
    },
    currentRecipe: {
        id: null,
        step: 0,
    },
    timer: {
        interval: null,
        timeLeft: 0,
        initialTime: 0,
        isRunning: false,
    },

    async init() {
        this.cacheDom();
        this.addEventListeners();
        this.loadState();

        const hasSeenSplash = localStorage.getItem('hasSeenSplash') === 'true';
        if (!hasSeenSplash) {
            this.showScreen('splash-screen');
        } else {
            this.handleStartSetup();
        }
    },

    cacheDom() {
        this.dom = {
            splashScreen: document.getElementById('splash-screen'),
            startAppBtn: document.getElementById('start-app-btn'),
            screens: document.querySelectorAll('.screen'),
            welcomeScreen: document.getElementById('welcome-screen'),
            startSetupWizardBtn: document.getElementById('start-setup-wizard-btn'),
            loadFromFileBtn: document.getElementById('load-from-file-btn'),
            setupScreen: document.getElementById('setup-screen'),
            mainScreen: document.getElementById('main-screen'),
            recipeScreen: document.getElementById('recipe-screen'),
            settingsScreen: document.getElementById('settings-screen'),
            previewScreen: document.getElementById('preview-screen'),
            
            // Wizard
            setupWizard: document.getElementById('setup-wizard'),
            wizardSteps: document.querySelectorAll('.wizard-step'),
            wizardNav: document.getElementById('wizard-nav'),
            wizardBackBtn: document.getElementById('wizard-back-btn'),
            wizardNextBtn: document.getElementById('wizard-next-btn'),
            wizardStepCounter: document.getElementById('wizard-step-counter'),
            apiKeyInput: document.getElementById('api-key-input'),
            apiKeyHelpLink: document.getElementById('api-key-help-link'),
            wizardFamilyContainer: document.getElementById('wizard-family-members-container'),
            wizardAddMemberBtn: document.getElementById('wizard-add-family-member-btn'),
            wizardDuration: document.getElementById('wizard-menu-duration'),
            wizardBudget: document.getElementById('wizard-total-budget'),
            wizardPreferences: document.getElementById('wizard-preferences'),
            wizardCuisine: document.getElementById('wizard-cuisine'),
            wizardDifficulty: document.getElementById('wizard-difficulty'),

            generationProgress: document.getElementById('generation-progress'),
            progressBar: document.getElementById('progress-bar'),
            progressStatus: document.getElementById('progress-status'),
            progressDetails: document.getElementById('progress-details'),
            
            // Preview
            previewMenuContainer: document.getElementById('preview-menu-container'),
            previewRegenerateAllBtn: document.getElementById('preview-regenerate-all-btn'),
            previewAcceptBtn: document.getElementById('preview-accept-btn'),

            // Main UI
            mainHeaderTitle: document.getElementById('main-header-title'),
            openSettingsBtn: document.getElementById('open-settings-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            bottomNav: document.querySelector('.bottom-nav'),
            mainContents: document.querySelectorAll('.main-content'),
            
            // New Menu UI
            dateSelector: document.getElementById('date-selector'),
            prevDayBtn: document.getElementById('prev-day-btn'),
            currentDateDisplay: document.getElementById('current-date-display'),
            nextDayBtn: document.getElementById('next-day-btn'),
            dailyMenuContainer: document.getElementById('daily-menu-container'),

            shoppingListContainer: document.getElementById('shopping-list-container'),
            shoppingProgressText: document.getElementById('shopping-progress-text'),
            shoppingProgress: document.getElementById('shopping-progress'),
            shoppingListTotal: document.getElementById('shopping-list-total'),

            backToMenuBtn: document.getElementById('back-to-menu-btn'),
            recipeTitle: document.getElementById('recipe-title'),
            stepIndicator: document.getElementById('step-indicator'),
            stepImage: document.getElementById('step-image'),
            stepDescription: document.getElementById('step-description'),
            timerSection: document.getElementById('timer-section'),
            timerDisplay: document.getElementById('timer-display'),
            startTimerBtn: document.getElementById('start-timer-btn'),
            pauseTimerBtn: document.getElementById('pause-timer-btn'),
            resetTimerBtn: document.getElementById('reset-timer-btn'),
            stepIngredientsList: document.getElementById('step-ingredients'),
            stepIngredientsTitle: document.getElementById('step-ingredients-title'),
            prevStepBtn: document.getElementById('prev-step-btn'),
            nextStepBtn: document.getElementById('next-step-btn'),
            
            budget: {
                pieProducts: document.getElementById('pie-products'),
                spentTotal: document.getElementById('budget-spent-total'),
                total: document.getElementById('budget-total'),
                remaining: document.getElementById('budget-remaining'),
                barChart: document.getElementById('bar-chart'),
            },

            settings: {
                content: document.getElementById('settings-content'),
                duration: document.getElementById('settings-menu-duration'),
                budget: document.getElementById('settings-total-budget'),
                preferences: document.getElementById('settings-preferences'),
                cuisine: document.getElementById('settings-cuisine'),
                difficulty: document.getElementById('settings-difficulty'),
                saveBtn: document.getElementById('save-settings-btn'),
                familyContainer: document.getElementById('family-members-container'),
                addMemberBtn: document.getElementById('add-family-member-btn'),
                regenerateAllBtn: document.getElementById('regenerate-all-btn'),
                apiKeyInput: document.getElementById('settings-api-key'),
                saveApiKeyBtn: document.getElementById('save-api-key-btn'),
                runWizardBtn: document.getElementById('run-wizard-btn'),
                appVersionInfo: document.getElementById('app-version-info'),
                showChangelogBtn: document.getElementById('show-changelog-btn'),
            },
            exportBtn: document.getElementById('export-btn'),
            importBtn: document.getElementById('import-btn'),
            importFileInput: document.getElementById('import-file-input'),

            devConsole: document.getElementById('dev-console'),
            logOutput: document.getElementById('log-output'),
            commandInput: document.getElementById('command-input'),

            notification: document.getElementById('notification'),
            notificationSound: document.getElementById('notification-sound'),

            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalButtons: document.getElementById('modal-buttons'),
        };
    },
    
    addEventListeners() {
        this.dom.startAppBtn.addEventListener('click', () => {
            localStorage.setItem('hasSeenSplash', 'true');
            this.handleStartSetup();
        });
        
        this.dom.startSetupWizardBtn.addEventListener('click', () => this.handleStartSetup(true));
        this.dom.loadFromFileBtn.addEventListener('click', () => this.dom.importFileInput.click());

        this.dom.wizardNextBtn.addEventListener('click', () => this.navigateWizard(1));
        this.dom.wizardBackBtn.addEventListener('click', () => this.navigateWizard(-1));
        this.dom.apiKeyInput.addEventListener('input', () => this.updateWizardView());
        this.dom.apiKeyHelpLink.addEventListener('click', (e) => {
            e.preventDefault();
            this.showApiKeyHelpModal();
        });

        this.dom.previewAcceptBtn.addEventListener('click', () => this.acceptPreview());
        this.dom.previewRegenerateAllBtn.addEventListener('click', () => this.startGenerationProcess(true));

        this.dom.bottomNav.addEventListener('click', (e) => this.handleNav(e));
        this.dom.backToMenuBtn.addEventListener('click', () => this.showScreen('main-screen'));
        
        this.dom.prevStepBtn.addEventListener('click', () => this.navigateRecipeStep(-1));
        this.dom.nextStepBtn.addEventListener('click', () => this.navigateRecipeStep(1));
        
        this.dom.prevDayBtn.addEventListener('click', () => this.navigateMenuDay(-1));
        this.dom.nextDayBtn.addEventListener('click', () => this.navigateMenuDay(1));

        this.dom.startTimerBtn.addEventListener('click', () => this.startTimer());
        this.dom.pauseTimerBtn.addEventListener('click', () => this.pauseTimer());
        this.dom.resetTimerBtn.addEventListener('click', () => this.resetTimer());

        // Settings Listeners
        this.dom.openSettingsBtn.addEventListener('click', () => this.showSettingsPanel());
        this.dom.closeSettingsBtn.addEventListener('click', () => this.hideSettingsPanel());
        this.dom.settings.saveBtn.addEventListener('click', () => this.saveSettings());
        this.dom.settings.addMemberBtn.addEventListener('click', () => this.openFamilyMemberModal());
        this.dom.settings.regenerateAllBtn.addEventListener('click', () => this.confirmRegenerateAll());
        this.dom.settings.saveApiKeyBtn.addEventListener('click', () => this.saveApiKey());
        this.dom.wizardAddMemberBtn.addEventListener('click', () => this.openFamilyMemberModal(true));
        this.dom.settings.runWizardBtn.addEventListener('click', () => {
            this.hideSettingsPanel();
            this.showWizard();
        });
        this.dom.settings.showChangelogBtn.addEventListener('click', () => this.showChangelogModal());

        this.dom.exportBtn.addEventListener('click', () => this.exportData());
        this.dom.importBtn.addEventListener('click', () => this.dom.importFileInput.click());
        this.dom.importFileInput.addEventListener('change', (e) => this.importData(e));

        let longPressTimer;
        document.body.addEventListener('touchstart', e => {
            if (e.touches.length === 3) {
                longPressTimer = setTimeout(() => this.toggleDevConsole(), 1000);
            }
        });
        document.body.addEventListener('touchend', () => clearTimeout(longPressTimer));
        this.dom.commandInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') this.executeCommand(e.target.value);
        });

        this.dom.modalOverlay.addEventListener('click', (e) => {
            if (e.target === this.dom.modalOverlay) {
                this.hideModal();
            }
        });
    },

    async handleStartSetup(forceWizard = false) {
        if (forceWizard) {
             this.showWizard();
             return;
        }

        if (this.state.settings.apiKey && this.state.menu && this.state.menu.length > 0) {
            this.showScreen('main-screen');
            this.renderAll();
        } else if (this.state.settings.apiKey) {
             this.showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞...', 'loading');
            try {
                this.ai = new GoogleGenAI({ apiKey: this.state.settings.apiKey });
                await this.ai.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
                this.hideNotification();
                this.wizard.currentStep = 2; 
                this.showWizard();
                this.updateWizardView();
            } catch (e) {
                this.showNotification('API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π.', 'error');
                this.state.settings.apiKey = null; 
                this.saveState();
                this.showWizard();
            }
        } else {
             this.showScreen('welcome-screen');
        }
    },

    saveState() {
        try {
            localStorage.setItem('familyMenuState', JSON.stringify(this.state));
        } catch (e) {
            console.error("Failed to save state:", e);
        }
    },
    
    loadState() {
        const savedState = localStorage.getItem('familyMenuState');
        if (savedState) {
            try {
                const loadedData = JSON.parse(savedState);
                if (loadedData.settings) {
                     this.state = loadedData;
                     // Ensure new properties exist for backward compatibility
                     if (!this.state.settings.family) this.state.settings.family = [];
                     if (!this.state.settings.menuDuration) this.state.settings.menuDuration = 7;
                     if (!this.state.cookedMeals) this.state.cookedMeals = {};
                     if (!this.state.settings.cuisine) this.state.settings.cuisine = "–õ—é–±–∞—è";
                     if (!this.state.settings.difficulty) this.state.settings.difficulty = "–õ—é–±–∞—è";
                     if (this.state.currentDayIndex === undefined) this.state.currentDayIndex = 0;

                     (this.state.shoppingList || []).forEach(cat => {
                        (cat.items || []).forEach(item => {
                            if (item.purchases === undefined) item.purchases = item.completed ? [{ qty: item.shoppingSuggestion?.qty || 1, price: item.price, date: new Date().toISOString() }] : [];
                            item.purchases.forEach(p => { if (!p.date) p.date = new Date().toISOString() });
                            if (item.consumedQty === undefined) item.consumedQty = 0;
                        });
                     });
                } else {
                    this.resetState();
                }
            } catch (e) {
                this.resetState();
            }
        }
    },

    resetState() {
        localStorage.removeItem('familyMenuState');
        localStorage.removeItem('hasSeenSplash');
        window.location.reload();
    },
    
    showScreen(screenId) {
        this.dom.screens.forEach(screen => {
            const isTarget = screen.id === screenId;
            screen.classList.toggle('hidden', !isTarget);
            if (['recipe-screen', 'splash-screen', 'settings-screen'].includes(screen.id)) {
                screen.classList.toggle('active', isTarget);
            }
        });
        if (screenId === 'main-screen') {
            document.getElementById('main-screen').classList.remove('hidden');
            this.renderAll();
        } else if (['setup-screen', 'welcome-screen', 'preview-screen'].includes(screenId)) {
             document.getElementById(screenId).classList.remove('hidden');
        }
    },

    showWizard() {
        this.showScreen('setup-screen');
        this.wizard.currentStep = 1;
        this.updateWizardView();
    },

    updateWizardView() {
        const { currentStep, totalSteps } = this.wizard;
        
        // Populate inputs from state
        this.dom.apiKeyInput.value = this.state.settings.apiKey || '';
        this.dom.wizardDuration.value = this.state.settings.menuDuration;
        this.dom.wizardBudget.value = this.state.settings.totalBudget;
        this.dom.wizardPreferences.value = this.state.settings.preferences;
        this.dom.wizardCuisine.value = this.state.settings.cuisine;
        this.dom.wizardDifficulty.value = this.state.settings.difficulty;
        
        this.dom.wizardNav.classList.remove('hidden');
        this.dom.generationProgress.classList.add('hidden');
        this.dom.setupWizard.classList.remove('hidden');
        this.dom.wizardStepCounter.classList.remove('hidden');

        this.dom.wizardStepCounter.textContent = `–®–∞–≥ ${currentStep} –∏–∑ ${totalSteps}`;

        this.dom.wizardSteps.forEach(step => {
            step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
        });

        this.dom.wizardBackBtn.classList.toggle('hidden', currentStep === 1);
        this.dom.wizardNextBtn.textContent = currentStep === totalSteps ? '–ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é' : '–î–∞–ª–µ–µ';
        
        // Validation for 'Next' button
        let isStepValid = false;
        switch(currentStep) {
            case 1: isStepValid = this.dom.apiKeyInput.value.trim().length > 0; break;
            case 2: isStepValid = this.state.settings.family.length > 0; break;
            default: isStepValid = true;
        }
        this.dom.wizardNextBtn.disabled = !isStepValid;

        if (currentStep === 2) {
            this.renderFamilyMembers(true);
        }
    },

    async navigateWizard(direction) {
        const { currentStep, totalSteps } = this.wizard;
        // Validation & State saving for current step before navigating
        if (direction > 0) {
            if (currentStep === 1) {
                this.state.settings.apiKey = this.dom.apiKeyInput.value.trim();
            } else if (currentStep === 3) {
                this.state.settings.menuDuration = parseInt(this.dom.wizardDuration.value) || 7;
                this.state.settings.totalBudget = parseInt(this.dom.wizardBudget.value) || 10000;
                this.state.settings.preferences = this.dom.wizardPreferences.value;
                this.state.settings.cuisine = this.dom.wizardCuisine.value;
                this.state.settings.difficulty = this.dom.wizardDifficulty.value;
            } else if (currentStep === totalSteps) {
                this.saveState();
                await this.startGenerationProcess();
                return;
            }
        }
        
        this.wizard.currentStep += direction;
        this.updateWizardView();
    },

    async startGenerationProcess(isRegenerating = false, purchasedItems = '', extraPrompt = '') {
        if (!this.state.settings.apiKey) {
            alert('API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω.');
            this.showWizard();
            return;
        }
        
        this.dom.setupWizard.classList.add('hidden');
        this.dom.wizardNav.classList.add('hidden');
        this.dom.wizardStepCounter.classList.add('hidden');
        this.dom.generationProgress.classList.remove('hidden');
        this.showScreen('setup-screen');
        
        try {
            this.ai = new GoogleGenAI({ apiKey: this.state.settings.apiKey });
            await this.updateProgress(1, 2, "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Gemini‚Ä¶", "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞...");
            await this.ai.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
            this.logToConsole('‚úÖ API KEY VALIDATED');
            this.dom.progressDetails.innerHTML += '<br>‚úÖ –ö–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω. –î–æ—Å—Ç—É–ø –∫ Gemini –ø–æ–ª—É—á–µ–Ω.';
            
            await this.updateProgress(2, 2, "–ú–∞–≥–∏—è –ò–ò –≤ –¥–µ–π—Å—Ç–≤–∏–∏‚Ä¶", "–°–æ–∑–¥–∞–µ–º –º–µ–Ω—é, —Ä–µ—Ü–µ–ø—Ç—ã –∏ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫...");
            
            const comprehensiveData = await this.generateComprehensiveData(purchasedItems, extraPrompt);

            if (!comprehensiveData || !comprehensiveData.menu || comprehensiveData.menu.length === 0) {
                throw new Error("Menu generation failed or returned empty data. Please check your prompt and settings.");
            }
            
            this.tempState = comprehensiveData;
            this.renderPreview();
            this.showScreen('preview-screen');

        } catch (error) {
            console.error("Generation failed:", error);
            this.updateProgress(0, 2, "–û—à–∏–±–∫–∞!", `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é. ${error.message}`);
            this.dom.generationProgress.innerHTML += `<button class="primary-button" onclick="window.location.reload()" style="margin-top: 20px;">–ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>`;
            if(!isRegenerating) {
                this.state.settings.apiKey = null;
                this.saveState();
            }
        }
    },
    
    async updateProgress(step, totalSteps, status, details) {
        return new Promise(resolve => {
            const percent = (step / totalSteps) * 100;
            this.dom.progressBar.style.width = `${percent}%`;
            this.dom.progressStatus.textContent = `–®–∞–≥ ${step}/${totalSteps}: ${status}`;
            this.dom.progressDetails.innerHTML = details;
            setTimeout(resolve, 300);
        });
    },

    async makeGeminiRequest(prompt, jsonSchema) {
        this.logToConsole(`üü° REQUEST: ${prompt.substring(0, 50)}...`);
        let retries = 3;
        while (retries > 0) {
            try {
                const response = await this.ai.models.generateContent({
                  model: "gemini-2.5-flash",
                  contents: prompt,
                  config: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                  }
                });
                const jsonText = response.text.trim();
                const data = JSON.parse(jsonText);
                this.logToConsole(`‚úÖ RESPONSE RECEIVED`);
                return data;
            } catch (error) {
                retries--;
                this.logToConsole(`üî¥ ERROR: ${error}. Retrying... (${retries} left)`);
                if (retries === 0) throw error;
                await new Promise(res => setTimeout(res, 1000));
            }
        }
    },
    
    async generateComprehensiveData(purchasedItems = '', extraPrompt = '') {
        const { family, menuDuration, preferences, cuisine, difficulty, totalBudget } = this.state.settings;
        const familyDescription = family.map(p => `${p.gender === 'male' ? '–ú—É–∂—á–∏–Ω–∞' : '–ñ–µ–Ω—â–∏–Ω–∞'}, ${p.age} –ª–µ—Ç, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${p.activity}`).join('; ');

        let promptText = `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ–¥–Ω–∏–º JSON-–æ—Ç–≤–µ—Ç–æ–º –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç—Ä–∏ –∫–ª—é—á–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è: "menu", "recipes", "shoppingList".

1.  **menu**: –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –º–µ–Ω—é –Ω–∞ ${menuDuration} –¥–Ω–µ–π (—Å –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è –ø–æ —Å—É–±–±–æ—Ç—É) –¥–ª—è —Å–µ–º—å–∏: ${familyDescription}.
    *   –£—á—Ç–∏ –∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ –∫–∞–ª–æ—Ä–∏—è—Ö.
    *   –û–±—â–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${preferences}.
    *   –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –∫—É—Ö–Ω—è: ${cuisine}.
    *   –ñ–µ–ª–∞–µ–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –±–ª—é–¥: ${difficulty}.
    *   –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å: –ó–∞–≤—Ç—Ä–∞–∫, –ü–µ—Ä–µ–∫—É—Å, –û–±–µ–¥, –ü–æ–ª–¥–Ω–∏–∫, –£–∂–∏–Ω.
    *   –ò–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç —É–∂–∏–Ω–∞ –Ω–∞ –æ–±–µ–¥ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è (–ø–æ–º–µ—á–∞–π –∏—Ö –∫–∞–∫ "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–æ—Å—Ç–∞—Ç–∫–∏)").

2.  **recipes**: –ú–∞—Å—Å–∏–≤ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –¥–ª—è –ö–ê–ñ–î–û–ì–û —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –±–ª—é–¥–∞ –∏–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ–Ω—é (–∫—Ä–æ–º–µ –±–ª—é–¥ —Å –ø–æ–º–µ—Ç–∫–æ–π "–æ—Å—Ç–∞—Ç–∫–∏").
    *   –ö–∞–∂–¥—ã–π —Ä–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π 'id' (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'borsch-s-govyadinoy').
    *   –ù–∞–∑–≤–∞–Ω–∏–µ 'name' —Ä–µ—Ü–µ–ø—Ç–∞ –¥–æ–ª–∂–Ω–æ –¢–û–ß–ù–û —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –º–µ–Ω—é.
    *   –í–∫–ª—é—á–∏ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–ª—è —Å–µ–º—å–∏ –∏–∑ ${family.length} —á–µ–ª–æ–≤–µ–∫.
    *   –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ 'steps'. –í –∫–∞–∂–¥–æ–º —à–∞–≥–µ —É–∫–∞–∂–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.

3.  **shoppingList**: –°–≤–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
    *   –°—É–º–º–∏—Ä—É–π –í–°–ï –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ –í–°–ï–• —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤.
    *   –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: "–ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞", "–ú–æ–ª–æ—á–Ω—ã–µ –∏ —è–π—Ü–∞", "–û–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å", "–§—Ä—É–∫—Ç—ã –∏ –æ—Ä–µ—Ö–∏", "–ë–∞–∫–∞–ª–µ—è", "–•–ª–µ–± –∏ –≤—ã–ø–µ—á–∫–∞", "–ù–∞–ø–∏—Ç–∫–∏", "–ü—Ä–æ—á–µ–µ".
    *   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —É–∫–∞–∂–∏ –æ–±—â–µ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 'totalNeeded', –∞ –∑–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ 'shoppingSuggestion' ‚Äî —Ä–∞–∑—É–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –æ–∫—Ä—É–≥–ª—è—è –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —É–ø–∞–∫–æ–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è 750–≥ –º—É–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫—É–ø–∏—Ç—å 1–∫–≥).
    *   –£–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—É—é —Ü–µ–Ω—É 'price' –≤ —Ä—É–±–ª—è—Ö –¥–ª—è 'shoppingSuggestion'. –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å –±—é–¥–∂–µ—Ç ${totalBudget} —Ä—É–±–ª–µ–π.
`;

        if (purchasedItems) {
            promptText += `\n–í–ê–ñ–ù–û: –ü—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –º–µ–Ω—é –æ—Ç–¥–∞–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±–ª—é–¥–∞–º, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã. –°–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${purchasedItems}.`;
        }
        if (extraPrompt) {
             promptText += `\n–û–°–û–ë–û–ï –£–ö–ê–ó–ê–ù–ò–ï: ${extraPrompt}`;
        }

        const ingredientsSchema = { type: Type.ARRAY, items: { type: Type.OBJECT, properties: { name: { type: Type.STRING }, quantity: { type: Type.STRING, description: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä '200 –≥' –∏–ª–∏ '1 —à—Ç'" } }, required: ["name", "quantity"] } };
        
        const schema = {
            type: Type.OBJECT,
            properties: {
                menu: {
                    type: Type.ARRAY,
                    description: "–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é.",
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            day: { type: Type.STRING },
                            meals: {
                                type: Type.OBJECT,
                                properties: {
                                    breakfast: { type: Type.STRING },
                                    snack1: { type: Type.STRING },
                                    lunch: { type: Type.STRING },
                                    snack2: { type: Type.STRING },
                                    dinner: { type: Type.STRING }
                                },
                                required: ["breakfast", "snack1", "lunch", "snack2", "dinner"]
                            }
                        },
                        required: ["day", "meals"]
                    }
                },
                recipes: {
                    type: Type.ARRAY,
                    description: "–†–µ—Ü–µ–ø—Ç—ã –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –±–ª—é–¥ –∏–∑ –º–µ–Ω—é.",
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            id: { type: Type.STRING, description: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–∞" },
                            name: { type: Type.STRING, description: "–ù–∞–∑–≤–∞–Ω–∏–µ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é" },
                            ingredients: ingredientsSchema,
                            steps: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        description: { type: Type.STRING },
                                        time: { type: Type.NUMBER, description: "–í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö. 0 –µ—Å–ª–∏ —Ç–∞–π–º–µ—Ä –Ω–µ –Ω—É–∂–µ–Ω." },
                                        ingredients: ingredientsSchema
                                    },
                                    required: ["description", "time", "ingredients"]
                                }
                            }
                        },
                        required: ["id", "name", "ingredients", "steps"]
                    }
                },
                shoppingList: {
                    type: Type.ARRAY,
                    description: "–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.",
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            category: { type: Type.STRING },
                            items: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        name: { type: Type.STRING },
                                        totalNeeded: { type: Type.OBJECT, properties: { qty: { type: Type.NUMBER }, unit: { type: Type.STRING } } },
                                        shoppingSuggestion: { type: Type.OBJECT, properties: { qty: { type: Type.NUMBER }, unit: { type: Type.STRING } } },
                                        price: { type: Type.NUMBER }
                                    },
                                    required: ["name", "totalNeeded", "shoppingSuggestion", "price"]
                                }
                            }
                        },
                        required: ["category", "items"]
                    }
                }
            },
            required: ["menu", "recipes", "shoppingList"]
        };

        const comprehensiveData = await this.makeGeminiRequest(promptText, schema);

        // Process data for internal use
        const recipesMap = {};
        if (comprehensiveData.recipes) {
            comprehensiveData.recipes.forEach(recipe => {
                recipesMap[recipe.id] = recipe;
            });
        }

        if (comprehensiveData.shoppingList) {
            comprehensiveData.shoppingList.forEach(category => {
                (category.items || []).forEach(item => {
                    item.purchases = [];
                    item.consumedQty = 0;
                });
            });
        }
        
        return {
            menu: comprehensiveData.menu || [],
            recipes: recipesMap,
            shoppingList: comprehensiveData.shoppingList || []
        };
    },

    renderAll() {
        this.renderMenu();
        this.renderShoppingList();
        this.renderBudget();
    },

    getRegenerateIcon() {
        return `<svg class="regenerate-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.681 4.06c.064.155.19.284.348.348l4.06 1.68c.772.321.772 1.415 0 1.736l-4.06 1.68a.5.5 0 00-.348.349l-1.68 4.06c-.321-.772-1.415-.772-1.736 0l-1.681-4.06a.5.5 0 00-.348-.348l-4.06-1.68c-.772-.321-.772-1.415 0-1.736l4.06-1.68a.5.5 0 00.348-.348l1.68-4.06z" clip-rule="evenodd" /></svg>`;
    },
    
    getSortedMenu() {
        const daysOrder = ["–í–û–°–ö–†–ï–°–ï–ù–¨–ï", "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö", "–í–¢–û–†–ù–ò–ö", "–°–†–ï–î–ê", "–ß–ï–¢–í–ï–†–ì", "–ü–Ø–¢–ù–ò–¶–ê", "–°–£–ë–ë–û–¢–ê"];
        const menuCopy = JSON.parse(JSON.stringify(this.state.menu || []));
        return menuCopy.sort((a, b) => {
            return daysOrder.indexOf(a.day.toUpperCase()) - daysOrder.indexOf(b.day.toUpperCase());
        });
    },

    renderMenu() {
        if (!this.state.menu || this.state.menu.length === 0) {
            this.dom.dailyMenuContainer.innerHTML = '<p style="text-align: center; color: var(--soft-text); margin-top: 30px;">–ú–µ–Ω—é –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</p>';
            this.dom.currentDateDisplay.textContent = '–ù–µ—Ç –º–µ–Ω—é';
            return;
        };

        const sortedMenu = this.getSortedMenu();
        
        if (this.state.currentDayIndex >= sortedMenu.length || this.state.currentDayIndex < 0) {
            this.state.currentDayIndex = 0;
        }
        
        const dayData = sortedMenu[this.state.currentDayIndex];
        if (!dayData) {
            console.error('No day data found for index:', this.state.currentDayIndex);
            return;
        }

        this.dom.currentDateDisplay.textContent = dayData.day;
        
        const mealHtml = (icon, mealName, mealKey, dayName) => {
            const cleanName = (mealName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ').replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i, '');
            const isLeftover = (mealName || '').includes('(–æ—Å—Ç–∞—Ç–∫–∏)');
            const hasContent = mealName && mealName.trim() !== '' && mealName.trim() !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const hasRecipe = !isLeftover && hasContent;
            const isCooked = this.state.cookedMeals[dayName] && this.state.cookedMeals[dayName].includes(mealKey);
            
            return `
            <div class="meal ${hasRecipe ? 'clickable' : ''} ${isCooked ? 'cooked' : ''}" data-meal-name="${mealName || ''}" data-meal-key="${mealKey}" data-day-name="${dayName}">
                <button class="cooked-toggle" data-day-name="${dayName}" data-meal-key="${mealKey}" aria-label="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </button>
                <span class="meal-icon">${icon}</span>
                <span class="meal-name">${cleanName}</span>
                ${isLeftover ? '<span class="leftover-icon">üîÑ</span>' : ''}
                ${hasContent ? `<button class="regenerate-btn" title="–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ">${this.getRegenerateIcon()}</button>` : ''}
            </div>`;
        };

        this.dom.dailyMenuContainer.innerHTML = `
            ${mealHtml('‚òÄÔ∏è', dayData.meals.breakfast, 'breakfast', dayData.day)}
            ${mealHtml('üçé', dayData.meals.snack1, 'snack1', dayData.day)}
            ${mealHtml('üç≤', dayData.meals.lunch, 'lunch', dayData.day)}
            ${mealHtml('ü•õ', dayData.meals.snack2, 'snack2', dayData.day)}
            ${mealHtml('üåô', dayData.meals.dinner, 'dinner', dayData.day)}
        `;

        // Re-attach listeners
        this.dom.dailyMenuContainer.querySelectorAll('.meal.clickable').forEach(el => {
            el.addEventListener('click', (e) => {
                if (e.target.closest('.regenerate-btn') || e.target.closest('.cooked-toggle')) return;
                const mealName = e.currentTarget.dataset.mealName.replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i, '').trim();
                const recipe = Object.values(this.state.recipes).find(r => r.name === mealName);
                if (recipe) {
                    this.checkIngredientsForRecipe(recipe.id);
                } else if (mealName) {
                    this.showNotification(`–†–µ—Ü–µ–ø—Ç –¥–ª—è "${mealName}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`, 'error');
                }
            });
        });

        this.dom.dailyMenuContainer.querySelectorAll('.cooked-toggle').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening recipe view
                const { dayName, mealKey } = e.currentTarget.dataset;
                this.toggleCookedStatus(dayName, mealKey);
            });
        });

        this.dom.dailyMenuContainer.querySelectorAll('.regenerate-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const el = e.currentTarget;
                const mealDiv = el.closest('.meal');
                const {dayName, mealKey} = mealDiv.dataset;
                this.openRegenerateModal('meal', { dayName, mealKey });
            });
        });
    },

    navigateMenuDay(direction) {
        if (!this.state.menu || this.state.menu.length === 0) return;
        const menuLength = this.state.menu.length;
        let newIndex = this.state.currentDayIndex + direction;
        
        if (newIndex < 0) {
            newIndex = menuLength - 1;
        } else if (newIndex >= menuLength) {
            newIndex = 0;
        }
        
        this.state.currentDayIndex = newIndex;
        this.saveState(); 
        this.renderMenu();
    },

    toggleCookedStatus(dayName, mealKey) {
        if (!this.state.cookedMeals[dayName]) {
            this.state.cookedMeals[dayName] = [];
        }

        const isCooking = !this.state.cookedMeals[dayName].includes(mealKey);
        const factor = isCooking ? 1 : -1;

        const mealName = (this.state.menu.find(d => d.day === dayName)?.meals[mealKey] || '').replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i, '').trim();
        const recipe = Object.values(this.state.recipes).find(r => r.name === mealName);
        
        if (recipe && recipe.ingredients) {
            recipe.ingredients.forEach(ing => {
                const shopItem = this.findShopItemByName(ing.name);
                const parsedIng = this.parseQuantity(ing.quantity);
                if (shopItem && parsedIng) {
                    if (shopItem.consumedQty === undefined) shopItem.consumedQty = 0;
                    // Simple logic assuming units match. More complex conversion would be needed for perfect accuracy.
                    shopItem.consumedQty += factor * parsedIng.qty;
                    shopItem.consumedQty = Math.max(0, shopItem.consumedQty); // Don't go below zero
                }
            });
        }

        const mealIndex = this.state.cookedMeals[dayName].indexOf(mealKey);
        if (mealIndex > -1) {
            this.state.cookedMeals[dayName].splice(mealIndex, 1);
        } else {
            this.state.cookedMeals[dayName].push(mealKey);
        }

        this.saveState();
        this.renderMenu();
        this.showNotification(isCooking ? "–ë–ª—é–¥–æ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ!" : "–û—Ç–º–µ—Ç–∫–∞ –æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏ —Å–Ω—è—Ç–∞.", "success");
    },
    
    findShopItemByName(name) {
        if (!name) return null;
        const lname = name.toLowerCase().trim().replace(/—ë/g, '–µ');
        for (const category of this.state.shoppingList) {
            for (const item of category.items) {
                const itemName = item.name.toLowerCase().trim().replace(/—ë/g, '–µ');
                if (itemName.includes(lname) || lname.includes(itemName)) {
                    return item;
                }
            }
        }
        return null;
    },
    
    parseQuantity(quantityStr) {
        if (typeof quantityStr !== 'string') return null;
        const match = quantityStr.match(/(\d+[\.,]?\d*)\s*([–∞-—è–ê-–Øa-zA-Z]+)?/);
        if (!match) return null;
        return {
            qty: parseFloat(match[1].replace(',', '.')),
            unit: (match[2] || '').toLowerCase()
        };
    },

    renderShoppingList() {
        if (!this.state.shoppingList) return;
        this.dom.shoppingListContainer.innerHTML = '';
        
        this.state.shoppingList.forEach((category, catIndex) => {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category-group';
            
            const itemsHtml = category.items.map((item, itemIndex) => {
                const totalPurchased = (item.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                const remainingQty = Math.max(0, item.shoppingSuggestion.qty - totalPurchased);
                const isCompleted = remainingQty <= 0;
                const progressPercent = item.shoppingSuggestion.qty > 0 ? Math.min((totalPurchased / item.shoppingSuggestion.qty) * 100, 100) : 0;

                const radius = 10;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (progressPercent / 100) * circumference;

                return `
                <li class="shopping-item ${isCompleted ? 'completed' : ''}" data-cat-index="${catIndex}" data-item-index="${itemIndex}">
                    <div class="item-checkbox-progress">
                        <svg viewBox="0 0 24 24">
                          <circle class="bg" cx="12" cy="12" r="${radius}"></circle>
                          <circle class="progress" cx="12" cy="12" r="${radius}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
                        </svg>
                        <span class="checkmark">‚úî</span>
                    </div>
                    <div class="item-details">
                        <span class="item-name">${item.name}</span>
                        <div class="item-quantity">
                           –ù—É–∂–Ω–æ: ${item.shoppingSuggestion.qty.toLocaleString('ru-RU')} ${item.shoppingSuggestion.unit} <br>
                           <span style="font-weight: bold; color: ${remainingQty > 0 ? 'var(--warning-color)' : 'var(--success-color)'};">–û—Å—Ç–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å: ${remainingQty.toLocaleString('ru-RU')} ${item.shoppingSuggestion.unit}</span>
                        </div>
                    </div>
                    <span class="item-price">${item.price} ‚ÇΩ</span>
                </li>
            `}).join('');
            
            categoryElement.innerHTML = `
                <button class="category-toggle">${category.category} ‚ñº</button>
                <ul class="category-items">${itemsHtml}</ul>
            `;
            this.dom.shoppingListContainer.appendChild(categoryElement);
        });
        
        this.dom.shoppingListContainer.querySelectorAll('.shopping-item').forEach(itemEl => {
            itemEl.addEventListener('click', (e) => {
                const { catIndex, itemIndex } = e.currentTarget.dataset;
                this.openPurchaseModal(parseInt(catIndex), parseInt(itemIndex));
            });
        });
        
        this.dom.shoppingListContainer.querySelectorAll('.category-toggle').forEach(button => {
            button.addEventListener('click', e => {
                const list = e.target.nextElementSibling;
                list.classList.toggle('collapsed');
                e.target.innerHTML = list.classList.contains('collapsed') ? e.target.innerHTML.replace('‚ñº', '‚ñ∂') : e.target.innerHTML.replace('‚ñ∂', '‚ñº');
            });
        });

        this.updateShoppingProgress();
        const estimatedCost = this.state.shoppingList.flatMap(c => c.items).reduce((sum, item) => sum + (item.price || 0), 0);
        this.dom.shoppingListTotal.innerHTML = `<span>–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—É–º–º–∞:</span> ${estimatedCost.toLocaleString('ru-RU')} ‚ÇΩ`;
    },

    updateShoppingProgress() {
        if (!this.state.shoppingList) return;
        const allItems = this.state.shoppingList.flatMap(c => c.items || []);
        if (allItems.length === 0) return;
        const totalItems = allItems.length;
        const completedItems = allItems.filter(i => {
            const totalPurchased = (i.purchases || []).reduce((sum, p) => sum + p.qty, 0);
            return totalPurchased >= i.shoppingSuggestion.qty;
        }).length;
        const percent = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
        this.dom.shoppingProgress.style.width = `${percent}%`;
        this.dom.shoppingProgressText.textContent = `${completedItems}/${totalItems} –∫—É–ø–ª–µ–Ω–æ`;
    },

    renderBudget() {
        const totalBudget = this.state.settings.totalBudget;
        const spentOnProducts = this.state.shoppingList
            .flatMap(c => c.items || [])
            .flatMap(item => item.purchases || [])
            .reduce((sum, purchase) => sum + purchase.price, 0);

        const remaining = totalBudget - spentOnProducts;
        const spentPercent = totalBudget > 0 ? Math.min((spentOnProducts / totalBudget) * 100, 100) : 0;
        
        this.dom.budget.pieProducts.style.strokeDasharray = `${spentPercent} 100`;
        this.dom.budget.spentTotal.innerHTML = `${spentOnProducts.toLocaleString('ru-RU')} ‚ÇΩ <span>–ø–æ—Ç—Ä–∞—á–µ–Ω–æ</span>`;
        this.dom.budget.total.textContent = `${totalBudget.toLocaleString('ru-RU')} ‚ÇΩ`;
        this.dom.budget.remaining.textContent = `${remaining.toLocaleString('ru-RU')} ‚ÇΩ`;
        this.dom.budget.remaining.className = `amount ${remaining >= 0 ? 'ok' : 'warning'}`;
        
        this.renderBudgetChart();
    },
    
    renderBudgetChart() {
        const purchases = this.state.shoppingList.flatMap(c => c.items || []).flatMap(i => i.purchases || []);
        const spendingByDay = {};
        
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const key = d.toISOString().split('T')[0];
            spendingByDay[key] = {
                amount: 0,
                label: d.toLocaleDateString('ru-RU', { weekday: 'short' })
            };
        }
        
        purchases.forEach(p => {
            const key = new Date(p.date).toISOString().split('T')[0];
            if (spendingByDay[key]) {
                spendingByDay[key].amount += p.price;
            }
        });
        
        const dataValues = Object.values(spendingByDay).map(d => d.amount);
        const maxSpending = Math.max(...dataValues, 1); // Avoid division by zero
        
        this.dom.budget.barChart.innerHTML = Object.values(spendingByDay).map(day => {
            const height = (day.amount / maxSpending) * 100;
            return `
                <div class="bar-chart-item">
                    <div class="bar" style="height: ${height}%;">
                        ${day.amount > 0 ? `<div class="bar-value">${Math.round(day.amount)}</div>` : ''}
                    </div>
                    <div class="bar-label">${day.label}</div>
                </div>
            `;
        }).join('');
    },
    
    checkIngredientsForRecipe(recipeId) {
        const recipe = this.state.recipes[recipeId];
        if (!recipe || !recipe.ingredients) {
            this.showRecipe(recipeId);
            return;
        }

        const missingIngredients = [];
        recipe.ingredients.forEach(ing => {
            const shopItem = this.findShopItemByName(ing.name);
            const parsedIng = this.parseQuantity(ing.quantity);

            if (shopItem && parsedIng) {
                 const totalPurchased = (shopItem.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                 const availableStock = totalPurchased - (shopItem.consumedQty || 0);
                 if (availableStock < parsedIng.qty) {
                     missingIngredients.push(shopItem);
                 }
            } else {
                missingIngredients.push({name: ing.name, shoppingSuggestion: {qty: parsedIng?.qty || 1, unit: parsedIng?.unit || '—à—Ç'}});
            }
        });

        if (missingIngredients.length > 0) {
            this.showMissingIngredientsWarning(missingIngredients, recipeId);
        } else {
            this.showRecipe(recipeId);
        }
    },
    
    showRecipe(recipeId) {
        this.currentRecipe.id = recipeId;
        this.currentRecipe.step = 0;
        const recipe = this.state.recipes[recipeId];
        if (!recipe) {
            this.showNotification(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç —Å ID: ${recipeId}.`, 'error');
            return;
        }
        this.showScreen('recipe-screen');
        this.renderRecipeStep();
    },

    renderRecipeStep() {
        const { id, step } = this.currentRecipe;
        const recipe = this.state.recipes[id];
        if (!recipe || !recipe.steps || !recipe.steps[step]) {
            console.error('Invalid recipe or step:', id, step);
            this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ—Ü–µ–ø—Ç–∞.', 'error');
            this.showScreen('main-screen');
            return;
        }

        const stepData = recipe.steps[step];

        this.dom.recipeTitle.textContent = recipe.name;
        this.dom.stepIndicator.textContent = `–®–∞–≥ ${step + 1}/${recipe.steps.length}`;
        this.dom.stepDescription.textContent = stepData.description;

        this.dom.stepImage.style.opacity = '0.5';
        if (stepData.imageUrl) {
            this.dom.stepImage.src = stepData.imageUrl;
            this.dom.stepImage.alt = stepData.description;
            this.dom.stepImage.style.opacity = '1';
        } else {
            this.dom.stepImage.src = ''; 
            this.dom.stepImage.alt = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
            this.generateStepImage(id, step);
        }

        this.stopTimer();
        if (stepData.time && stepData.time > 0) {
            this.timer.initialTime = stepData.time * 60;
            this.resetTimer();
            this.dom.timerSection.classList.remove('hidden');
        } else {
            this.dom.timerSection.classList.add('hidden');
        }

        this.dom.stepIngredientsList.innerHTML = '';
        if (stepData.ingredients && stepData.ingredients.length > 0) {
            this.dom.stepIngredientsTitle.classList.remove('hidden');
            stepData.ingredients.forEach(ing => {
                const li = document.createElement('li');
                const shopItem = this.findShopItemByName(ing.name);
                const parsedIng = this.parseQuantity(ing.quantity);

                let statusClass = 'unknown';
                let statusIcon = '‚ùî';
                if (shopItem && parsedIng) {
                    const totalPurchased = (shopItem.purchases || []).reduce((sum, p) => sum + p.qty, 0);
                    const availableStock = totalPurchased - (shopItem.consumedQty || 0);
                    if (availableStock >= parsedIng.qty) {
                        statusClass = 'completed';
                        statusIcon = '‚úÖ';
                    } else {
                        statusClass = 'missing';
                        statusIcon = '‚ö†Ô∏è';
                    }
                }
                li.innerHTML = `<span><span class="ingredient-status ${statusClass}">${statusIcon}</span> ${ing.name}</span> <span class="ingredient-quantity">${ing.quantity}</span>`;
                this.dom.stepIngredientsList.appendChild(li);
            });
        } else {
            this.dom.stepIngredientsTitle.classList.add('hidden');
        }

        this.dom.prevStepBtn.disabled = step === 0;
        this.dom.nextStepBtn.textContent = (step === recipe.steps.length - 1) ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úÖ' : '–î–∞–ª–µ–µ ‚Üí';
    },

    async generateStepImage(recipeId, stepIndex) {
        if (!this.ai) {
             if (this.state.settings.apiKey) {
                this.ai = new GoogleGenAI({ apiKey: this.state.settings.apiKey });
            } else {
                return;
            }
        }
        try {
            const recipe = this.state.recipes[recipeId];
            const stepDescription = recipe.steps[stepIndex].description;
            const prompt = `Food photography, realistic, high-detail photo of a cooking step: "${stepDescription}"`;
            
            const response = await this.ai.models.generateImages({
                model: 'imagen-4.0-generate-001',
                prompt: prompt,
                config: {
                  numberOfImages: 1,
                  outputMimeType: 'image/jpeg',
                  aspectRatio: '4:3',
                },
            });

            const base64ImageBytes = response.generatedImages[0].image.imageBytes;
            const imageUrl = `data:image/jpeg;base64,${base64ImageBytes}`;

            if (this.currentRecipe.id === recipeId && this.currentRecipe.step === stepIndex) {
                this.dom.stepImage.src = imageUrl;
                this.dom.stepImage.style.opacity = '1';
            }
            this.state.recipes[recipeId].steps[stepIndex].imageUrl = imageUrl;
            this.saveState();
        } catch (error) {
            console.error("Image generation failed:", error);
            if (this.currentRecipe.id === recipeId && this.currentRecipe.step === stepIndex) {
               this.dom.stepImage.alt = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            }
        }
    },

    navigateRecipeStep(direction) {
        const { id, step } = this.currentRecipe;
        const recipe = this.state.recipes[id];
        
        if (direction > 0 && step === recipe.steps.length - 1) {
            this.finishCooking();
            return;
        }
        
        const newStep = step + direction;
        if (newStep >= 0 && newStep < recipe.steps.length) {
            this.currentRecipe.step = newStep;
            this.renderRecipeStep();
        }
    },

    finishCooking() {
        const { id } = this.currentRecipe;
        const recipe = this.state.recipes[id];

        let mealInfo = null;
        for (const day of this.state.menu) {
            for (const mealKey in day.meals) {
                const mealName = (day.meals[mealKey] || '').replace(/\s*\(–æ—Å—Ç–∞—Ç–∫–∏\)/i, '').trim();
                if (mealName === recipe.name) {
                    mealInfo = { dayName: day.day, mealKey: mealKey };
                    break;
                }
            }
            if (mealInfo) break;
        }

        if (mealInfo) {
            this.toggleCookedStatus(mealInfo.dayName, mealInfo.mealKey);
        }
        
        this.showNotification(`"${recipe.name}" –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ!`, 'success');
        this.showScreen('main-screen');
    },

    startTimer() {
        if (this.timer.isRunning || this.timer.timeLeft <= 0) return;
        this.timer.isRunning = true;
        this.timer.interval = setInterval(() => {
            this.timer.timeLeft--;
            this.updateTimerDisplay();
            if (this.timer.timeLeft <= 0) {
                this.stopTimer(true); // finished
            }
        }, 1000);
    },

    pauseTimer() {
        this.timer.isRunning = false;
        clearInterval(this.timer.interval);
    },
    
    stopTimer(finished = false) {
        this.pauseTimer();
        if (finished) {
            this.dom.timerDisplay.textContent = "–ì–æ—Ç–æ–≤–æ!";
            this.showNotification("–¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!", "success");
            this.dom.notificationSound.play().catch(e => console.log("Audio play failed", e));
        }
    },

    resetTimer() {
        this.stopTimer();
        this.timer.timeLeft = this.timer.initialTime;
        this.updateTimerDisplay();
    },

    updateTimerDisplay() {
        const minutes = Math.floor(this.timer.timeLeft / 60);
        const seconds = this.timer.timeLeft % 60;
        this.dom.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    },
    
    handleNav(e) {
        const button = e.target.closest('.nav-button');
        if (!button) return;
        
        this.dom.bottomNav.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        const contentId = button.dataset.content;
        this.dom.mainHeaderTitle.textContent = button.dataset.title;
        this.dom.mainContents.forEach(content => {
            content.classList.toggle('active', content.id === contentId);
        });
        if (contentId === 'budget-content') this.renderBudget();
    },

    showNotification(message, type = 'success') {
        this.dom.notification.textContent = message;
        this.dom.notification.className = type; // success, loading, error
        this.dom.notification.classList.add('show');

        if (type !== 'loading') {
            setTimeout(() => {
                this.dom.notification.classList.remove('show');
            }, 3000);
        }
    },

    hideNotification() {
        this.dom.notification.classList.remove('show');
    },

    showModal(title, bodyHtml, buttons) {
        this.dom.modalTitle.textContent = title;
        this.dom.modalBody.innerHTML = bodyHtml;
        this.dom.modalButtons.innerHTML = '';
        buttons.forEach(btn => {
            const buttonEl = document.createElement('button');
            buttonEl.textContent = btn.text;
            buttonEl.className = `modal-button ${btn.class}`;
            buttonEl.addEventListener('click', () => {
                btn.action();
                if (btn.closes !== false) this.hideModal();
            });
            this.dom.modalButtons.appendChild(buttonEl);
        });
        this.dom.modalOverlay.classList.add('visible');
    },

    hideModal() {
        this.dom.modalOverlay.classList.remove('visible');
    },

    showApiKeyHelpModal() {
        const bodyHtml = `
            <style>
                .help-step { margin-bottom: 20px; }
                .help-step h5 { font-family: var(--font-nunito); font-weight: 700; color: var(--accent-color); margin: 0 0 8px 0; font-size: 18px; }
                .help-step p { margin: 0 0 10px 0; line-height: 1.5; font-size: 15px; }
                .help-step a { color: var(--accent-color); font-weight: 600; }
                .connection-check { background-color: var(--card-accent-bg); padding: 15px; border-radius: 12px; text-align: center; }
                #connection-status { font-weight: 600; margin-top: 10px; min-height: 20px; }
            </style>
            <div class="help-step">
                <h5>–®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞</h5>
                <p>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–µ–Ω –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á (API Key) –æ—Ç Google Gemini.</p>
                <p>1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>
                <p>2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É <strong>"Create API key in new project"</strong>.</p>
                <p>3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —ç–∫—Ä–∞–Ω–µ.</p>
            </div>
            <div class="help-step">
                <h5>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h5>
                <p>–ò–Ω–æ–≥–¥–∞ —Å–µ—Ä–≤–∏—Å—ã Google –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –≤–∞—à –¥–æ—Å—Ç—É–ø.</p>
                <div class="connection-check">
                    <button class="secondary-button" id="check-connection-btn" style="height: 45px; font-size: 16px;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
                    <div id="connection-status"></div>
                </div>
            </div>
            <div class="help-step" id="troubleshooting-step" style="display: none;">
                <h5>–ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ—Ç?</h5>
                <p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É –∏–ª–∏ —Å–∞–π—Ç –∏–∑ –®–∞–≥–∞ 1 –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã Google AI –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ.</p>
                <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–∫–∏–º —Å–µ—Ä–≤–∏—Å–∞–º –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN. VPN –∏–∑–º–µ–Ω—è–µ—Ç –≤–∞—à–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.</p>
                <p>1. –í–∫–ª—é—á–∏—Ç–µ –ª—é–±–æ–π VPN-—Å–µ—Ä–≤–∏—Å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É, –≥–¥–µ Gemini –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–®–ê, –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è).</p>
                <p>2. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ <strong>–®–∞–≥ 1</strong> –∏ <strong>–®–∞–≥ 2</strong> —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º VPN.</p>
                <p>–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞, VPN –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.</p>
            </div>
        `;

        this.showModal(
            '–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á?',
            bodyHtml,
            [{ text: '–ü–æ–Ω—è—Ç–Ω–æ', class: 'primary', action: () => {} }]
        );

        document.getElementById('check-connection-btn').addEventListener('click', async (e) => {
            const btn = e.target;
            const statusDiv = document.getElementById('connection-status');
            const troubleshootingDiv = document.getElementById('troubleshooting-step');
            
            btn.disabled = true;
            statusDiv.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            statusDiv.style.color = 'var(--soft-text)';

            try {
                await fetch('https://generativelanguage.googleapis.com/$rpc/google.ai.generativelanguage.v1beta.ModelService/ListModels', {
                    method: 'GET',
                    mode: 'cors'
                });
                statusDiv.textContent = '‚úÖ –û—Ç–ª–∏—á–Ω–æ! –î–æ—Å—Ç—É–ø –µ—Å—Ç—å.';
                statusDiv.style.color = 'var(--success-color)';
                troubleshootingDiv.style.display = 'none';
            } catch (error) {
                console.error('Connection check failed:', error);
                statusDiv.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞! –î–æ—Å—Ç—É–ø, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.';
                statusDiv.style.color = 'var(--danger-color)';
                troubleshootingDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        });
    },

    openPurchaseModal(catIndex, itemIndex) {
        const item = this.state.shoppingList[catIndex].items[itemIndex];
        const totalPurchased = (item.purchases || []).reduce((sum, p) => sum + p.qty, 0);
        const remainingQty = Math.max(0, item.shoppingSuggestion.qty - totalPurchased);

        const bodyHtml = `
            <p>–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å: ${item.shoppingSuggestion.qty} ${item.shoppingSuggestion.unit}. –û—Å—Ç–∞–ª–æ—Å—å: ${remainingQty} ${item.shoppingSuggestion.unit}</p>
            <div class="modal-form-group">
                <label for="purchase-qty">–°–∫–æ–ª—å–∫–æ –∫—É–ø–∏–ª–∏ (${item.shoppingSuggestion.unit})</label>
                <input type="number" id="purchase-qty" class="modal-input" value="${remainingQty > 0 ? remainingQty : ''}" placeholder="0">
            </div>
            <div class="modal-form-group">
                <label for="purchase-price">–¶–µ–Ω–∞ –∑–∞ —ç—Ç—É –ø–æ–∫—É–ø–∫—É (‚ÇΩ)</label>
                <input type="number" id="purchase-price" class="modal-input" placeholder="0">
            </div>
        `;

        const buttons = [
            { text: '–û—Ç–º–µ–Ω–∞', class: 'secondary', action: () => {} },
            { text: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', class: 'primary', action: () => {
                const qty = parseFloat(document.getElementById('purchase-qty').value) || 0;
                const price = parseFloat(document.getElementById('purchase-price').value) || 0;
                if (qty > 0) {
                    if (!item.purchases) item.purchases = [];
                    item.purchases.push({ qty, price, date: new Date().toISOString() });
                    this.saveState();
                    this.renderShoppingList();
                    this.renderBudget();
                }
            }},
        ];
        this.showModal(`–ü–æ–∫—É–ø–∫–∞: ${item.name}`, bodyHtml, buttons);
    },

    async shareMissingItems(missingItems) {
        const text = "–ü—Ä–∏–≤–µ—Ç! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫—É–ø–∏ –¥–ª—è —É–∂–∏–Ω–∞:\n" + 
                     missingItems.map(item => `- ${item.name} (${item.shoppingSuggestion.qty} ${item.shoppingSuggestion.unit})`).join('\n');
        
        try {
            if (navigator.share) {
                await navigator.share({
                    title: '–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫',
                    text: text,
                });
            } else {
                await navigator.clipboard.writeText(text);
                this.showNotification("–°–ø–∏—Å–æ–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
            }
        } catch (err) {
            console.error('Share/Copy failed:', err);
            this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è/—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.", 'error');
        }
    },

    showMissingIngredientsWarning(missingItems, recipeId) {
        const bodyHtml = `
            <p>–î–ª—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –±–ª—é–¥–∞ –≤–∞–º –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:</p>
            <ul>${missingItems.map(item => `<li>${item.name}</li>`).join('')}</ul>
            <p>–•–æ—Ç–∏—Ç–µ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∫–æ–≥–æ-—Ç–æ —Å—Ö–æ–¥–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω?</p>
        `;
        const buttons = [
             { text: '–í—Å–µ —Ä–∞–≤–Ω–æ –≥–æ—Ç–æ–≤–∏—Ç—å', class: 'primary', action: () => this.showRecipe(recipeId) },
             { text: 'üõí –ü–æ–ø—Ä–æ—Å–∏—Ç—å –∫—É–ø–∏—Ç—å', class: 'secondary', action: () => this.shareMissingItems(missingItems) },
             { text: '–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é', class: 'secondary', action: () => {} },
        ];
        this.showModal("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤", bodyHtml, buttons);
    },

    // SETTINGS LOGIC
    showSettingsPanel() {
        this.renderSettings();
        this.dom.settingsScreen.classList.remove('hidden');
        // A short delay ensures the transition is applied correctly after changing display property
        setTimeout(() => this.dom.settingsScreen.classList.add('active'), 10);
    },
    hideSettingsPanel() {
        this.dom.settingsScreen.classList.remove('active');
        // Add the 'hidden' class back after the transition completes (0.5s duration)
        setTimeout(() => {
            this.dom.settingsScreen.classList.add('hidden');
        }, 500);
    },
    renderSettings() {
        const s = this.state.settings;
        this.dom.settings.duration.value = s.menuDuration;
        this.dom.settings.budget.value = s.totalBudget;
        this.dom.settings.preferences.value = s.preferences;
        this.dom.settings.cuisine.value = s.cuisine;
        this.dom.settings.difficulty.value = s.difficulty;
        this.dom.settings.apiKeyInput.value = s.apiKey || '';
        this.dom.settings.appVersionInfo.textContent = `–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${this.version}`;
        this.renderFamilyMembers();
    },
    saveSettings() {
        const s = this.state.settings;
        s.menuDuration = parseInt(this.dom.settings.duration.value) || 7;
        s.totalBudget = parseInt(this.dom.settings.budget.value) || 10000;
        s.preferences = this.dom.settings.preferences.value;
        s.cuisine = this.dom.settings.cuisine.value;
        s.difficulty = this.dom.settings.difficulty.value;
        this.saveState();
        this.renderBudget(); 
        this.showNotification("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ß—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–µ–Ω—é.");
    },
    async saveApiKey() {
        const newApiKey = this.dom.settings.apiKeyInput.value.trim();
        if (!newApiKey) {
            this.showNotification('API –∫–ª—é—á –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
            return;
        }
        this.showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞...', 'loading');
        try {
            const testAI = new GoogleGenAI({ apiKey: newApiKey });
            await testAI.models.generateContent({model:'gemini-2.5-flash', contents: 'test'});
            
            this.state.settings.apiKey = newApiKey;
            this.ai = testAI; 
            this.saveState();
            this.showNotification('API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω!');
        } catch (error) {
            console.error("API Key validation failed:", error);
            this.showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
        }
    },
    renderFamilyMembers(isWizard = false) {
        const container = isWizard ? this.dom.wizardFamilyContainer : this.dom.settings.familyContainer;
        container.innerHTML = '';
        if (this.state.settings.family.length === 0) {
            container.innerHTML = '<p style="font-size:14px; color: var(--soft-text);">–î–æ–±–∞–≤—å—Ç–µ —á–ª–µ–Ω–æ–≤ —Å–µ–º—å–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Ü–∏–æ–Ω–∞.</p>';
        }
        this.state.settings.family.forEach((person, index) => {
            const card = document.createElement('div');
            card.className = 'family-member-card';
            const genderText = person.gender === 'male' ? '–º—É–∂.' : '–∂–µ–Ω.';
            const activityMap = { sedentary: '—Å–∏–¥—è—á–∏–π', light: '–ª–µ–≥–∫–∞—è', moderate: '—É–º–µ—Ä–µ–Ω–Ω–∞—è', high: '–≤—ã—Å–æ–∫–∞—è' };
            card.innerHTML = `
                <span>${person.age} –ª–µ—Ç, ${genderText}, ${activityMap[person.activity] || person.activity}</span>
                <button data-index="${index}" class="delete-member-btn">‚úñ</button>
            `;
            container.appendChild(card);
        });
        container.querySelectorAll('.delete-member-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.state.settings.family.splice(e.target.dataset.index, 1);
                this.saveState();
                this.renderFamilyMembers(isWizard);
                if (!isWizard) this.renderFamilyMembers(false);
                this.updateWizardView();
            });
        });
    },
    openFamilyMemberModal(isWizard = false) {
        const bodyHtml = `
            <div class="modal-form-group">
                <label for="member-age">–í–æ–∑—Ä–∞—Å—Ç</label>
                <input type="number" id="member-age" class="modal-input" placeholder="30">
            </div>
            <div class="modal-form-group">
                <label for="member-gender">–ü–æ–ª</label>
                <select id="member-gender" class="settings-select" style="height: 45px;">
                    <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                    <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label for="member-activity">–£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</label>
                <select id="member-activity" class="settings-select" style="height: 45px;">
                    <option value="sedentary">–°–∏–¥—è—á–∏–π</option>
                    <option value="light">–õ–µ–≥–∫–∞—è</option>
                    <option value="moderate">–£–º–µ—Ä–µ–Ω–Ω–∞—è</option>
                    <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                </select>
            </div>
        `;
        const buttons = [
            { text: '–û—Ç–º–µ–Ω–∞', class: 'secondary', action: () => {} },
            { text: '–î–æ–±–∞–≤–∏—Ç—å', class: 'primary', action: () => {
                const newMember = {
                    age: parseInt(document.getElementById('member-age').value) || 30,
                    gender: document.getElementById('member-gender').value,
                    activity: document.getElementById('member-activity').value,
                };
                this.state.settings.family.push(newMember);
                this.saveState();
                this.renderFamilyMembers(isWizard);
                if (!isWizard) this.renderFamilyMembers(false);
                this.updateWizardView();
            }},
        ];
        this.showModal("–ù–æ–≤—ã–π —á–ª–µ–Ω —Å–µ–º—å–∏", bodyHtml, buttons);
    },
    confirmRegenerateAll() {
        this.showModal(
            "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
            "<p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã, –Ω–æ –ò–ò –ø–æ—Å—Ç–∞—Ä–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã.</p>",
            [
                { text: '–û—Ç–º–µ–Ω–∞', class: 'secondary', action: () => {} },
                { text: '–î–∞, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å', class: 'primary', action: () => {
                    const purchasedItems = (this.state.shoppingList || [])
                        .flatMap(c => c.items || [])
                        .filter(item => (item.purchases || []).length > 0)
                        .map(item => `${item.name} (${item.purchases.reduce((sum, p) => sum + p.qty, 0)} ${item.shoppingSuggestion.unit})`)
                        .join(', ');
                    this.hideSettingsPanel();
                    this.startGenerationProcess(true, purchasedItems);
                }}
            ]
        );
    },
    showChangelogModal() {
        const versions = Object.keys(this.changelog).sort((a,b) => b.localeCompare(a, undefined, {numeric: true}));
        const bodyHtml = versions.map(version => `
            <h4>–í–µ—Ä—Å–∏—è ${version}</h4>
            <ul>
                ${this.changelog[version].map(change => `<li>${change}</li>`).join('')}
            </ul>
        `).join('');
        this.showModal('–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π', bodyHtml, [{text: '–ó–∞–∫—Ä—ã—Ç—å', class: 'primary', action: () => {}}]);
    },
    
    // REGENERATION
    openRegenerateModal(type, data) {
        const title = type === 'meal' ? "–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ" : "–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å";
        const bodyHtml = `
            <p>–í—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.</p>
            <div class="modal-form-group">
                <label for="regen-prompt">–ü–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="regen-prompt" class="modal-textarea" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ –ª–µ–≥–∫–æ–µ"></textarea>
            </div>
        `;
        const buttons = [
            { text: '–û—Ç–º–µ–Ω–∞', class: 'secondary', action: () => {} },
            { text: '–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å', class: 'primary', action: () => {
                const customPrompt = document.getElementById('regen-prompt')?.value || '';
                this.handleRegeneration(type, data, false, customPrompt);
            }}
        ];
        this.showModal(title, bodyHtml, buttons);
    },

    async handleRegeneration(type, data, isPreview = false, customPrompt = '') {
        this.showNotification("–û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é...", 'loading');
        
        const sourceState = isPreview ? this.tempState : this.state;
        if (!sourceState) return;

        if (!this.ai) {
            if (this.state.settings.apiKey) {
                this.ai = new GoogleGenAI({ apiKey: this.state.settings.apiKey });
            } else {
                this.showNotification("API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.", "error");
                return;
            }
        }

        try {
            let extraPrompt = '';
            const currentMenuString = JSON.stringify(sourceState.menu.map(d => ({day: d.day, meals: d.meals})));
            
            if (type === 'meal') {
                const { dayName, mealKey } = data;
                const mealName = sourceState.menu.find(d => d.day === dayName)?.meals[mealKey];
                extraPrompt = `–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –º–µ–Ω—é: ${currentMenuString}. –°–î–ï–õ–ê–ô –¢–û–õ–¨–ö–û –û–î–ù–û –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¥–ª—è –¥–Ω—è "${dayName}" –∑–∞–º–µ–Ω–∏ –±–ª—é–¥–æ "${mealKey}" ("${mealName}") –Ω–∞ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ. –ü–æ–∂–µ–ª–∞–Ω–∏–µ: ${customPrompt || '—Å–¥–µ–ª–∞–π —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ'}. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª—é–¥–∞ –≤ –º–µ–Ω—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏ —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –ø–æ–∫—É–ø–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —ç—Ç–∏–º –æ–¥–Ω–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º.`;
            } else { // type === 'day'
                const { dayName } = data;
                extraPrompt = `–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –º–µ–Ω—é: ${currentMenuString}. –°–î–ï–õ–ê–ô –ò–ó–ú–ï–ù–ï–ù–ò–Ø –¢–û–õ–¨–ö–û –î–õ–Ø –û–î–ù–û–ì–û –î–ù–Ø: –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–∏ –º–µ–Ω—é –¥–ª—è –¥–Ω—è "${dayName}". –ü–æ–∂–µ–ª–∞–Ω–∏–µ: ${customPrompt || '—Å–¥–µ–ª–∞–π —ç—Ç–æ—Ç –¥–µ–Ω—å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–µ–µ'}. –°–æ—Ö—Ä–∞–Ω–∏ –º–µ–Ω—é –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏ —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –ø–æ–∫—É–ø–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —ç—Ç–æ–≥–æ –¥–Ω—è.`;
            }

            const purchasedItems = (this.state.shoppingList || [])
                .flatMap(c => c.items || [])
                .filter(item => (item.purchases || []).length > 0)
                .map(item => item.name)
                .join(', ');
            
            const newData = await this.generateComprehensiveData(purchasedItems, extraPrompt);
            
            if (isPreview) {
                this.tempState = newData;
                this.renderPreview();
                this.showNotification("–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!");
            } else {
                Object.assign(this.state, newData);
                this.saveState();
                this.renderAll();
                this.showNotification("–ú–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
            }

        } catch(e) {
            this.showNotification("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.", 'error');
            console.error(e);
        }
    },
    
    // PREVIEW FLOW
    renderPreview() {
        const container = this.dom.previewMenuContainer;
        container.innerHTML = '';
        if (!this.tempState || !this.tempState.menu) return;

        this.tempState.menu.forEach(dayData => {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'preview-day';

            const mealsHtml = Object.entries(dayData.meals).map(([key, name]) => `
                <div class="preview-meal" data-day-name="${dayData.day}" data-meal-key="${key}">
                    <span class="preview-meal-name">${name || '...'}</span>
                    <button class="regenerate-btn" title="–ò–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ">${this.getRegenerateIcon()}</button>
                </div>
            `).join('');

            dayDiv.innerHTML = `<h4 class="preview-day-title">${dayData.day}</h4>${mealsHtml}`;
            container.appendChild(dayDiv);
        });

        container.querySelectorAll('.regenerate-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const mealDiv = e.target.closest('.preview-meal');
                const { dayName, mealKey } = mealDiv.dataset;
                const mealName = this.tempState.menu.find(d=>d.day===dayName).meals[mealKey];
                this.showModal(
                    "–ò–∑–º–µ–Ω–∏—Ç—å –±–ª—é–¥–æ",
                    `<p>–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –≤–∏–¥–µ—Ç—å –≤–º–µ—Å—Ç–æ "${mealName}"?</p>
                     <textarea id="regen-prompt" class="modal-textarea" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —á—Ç–æ-—Ç–æ –∏–∑ –∫—É—Ä–∏—Ü—ã"></textarea>`,
                    [
                        { text: '–û—Ç–º–µ–Ω–∞', class: 'secondary', action: () => {} },
                        { text: '–ò–∑–º–µ–Ω–∏—Ç—å', class: 'primary', action: () => {
                            const customPrompt = document.getElementById('regen-prompt')?.value || '';
                            this.handleRegeneration('meal', { dayName, mealKey }, true, customPrompt);
                        }}
                    ]
                );
            });
        });
    },

    acceptPreview() {
        if (this.tempState) {
            Object.assign(this.state, this.tempState);
            this.state.timestamp = new Date().toISOString();
            this.state.currentDayIndex = 0;
            this.saveState();
            this.tempState = null;
            this.showScreen('main-screen');
            this.renderAll();
            this.showNotification("–ú–µ–Ω—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        }
    },

    async exportData() {
        const fileName = `family_menu_backup_${new Date().toISOString().split('T')[0]}.json`;
        const dataBlob = new Blob([JSON.stringify(this.state)], { type: 'application/json' });

        try {
            const dataFile = new File([dataBlob], fileName, { type: 'application/json' });
            if (navigator.share && navigator.canShare({ files: [dataFile] })) {
                await navigator.share({
                    files: [dataFile],
                    title: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –°–µ–º–µ–π–Ω–æ–≥–æ –ú–µ–Ω—é',
                    text: '–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –º–µ–Ω—é. –ó–∞–≥—Ä—É–∑–∏ –µ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "–°–µ–º–µ–π–Ω–æ–µ –º–µ–Ω—é+".',
                });
                this.showNotification("–î–∞–Ω–Ω—ã–º–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å!");
                return;
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                 console.error('Share failed:', error);
            }
        }

        try {
            const dataUrl = URL.createObjectURL(dataBlob);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.href = dataUrl;
            downloadAnchorNode.download = fileName;
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            document.body.removeChild(downloadAnchorNode);
            URL.revokeObjectURL(dataUrl);
            this.showNotification("–§–∞–π–ª –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–∫–∞—á–∞–Ω!");
        } catch (fallbackError) {
            console.error('Fallback download failed:', fallbackError);
            this.showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª.", 'error');
        }
    },
    importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedState = JSON.parse(e.target.result);
                if (importedState.settings) {
                    this.state = importedState;
                    this.saveState();
                    this.showNotification("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
                    this.handleStartSetup();
                } else {
                    throw new Error("Invalid file format");
                }
            } catch (error) {
                this.showNotification("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.", 'error');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    },
    
    toggleDevConsole() {
        this.dom.devConsole.classList.toggle('visible');
    },
    logToConsole(message) {
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        this.dom.logOutput.appendChild(p);
        this.dom.logOutput.scrollTop = this.dom.logOutput.scrollHeight;
    },
    executeCommand(commandStr) {
        this.logToConsole(`> ${commandStr}`);
        try {
            switch(commandStr.toLowerCase()) {
                case 'clear':
                    this.dom.logOutput.innerHTML = '';
                    break;
                case 'state':
                    console.log(this.state);
                    this.logToConsole('State logged to browser console.');
                    break;
                case 'reset':
                    this.resetState();
                    break;
                default:
                    this.logToConsole('Unknown command. Available: clear, state, reset');
            }
        } catch (e) {
            this.logToConsole(`Error: ${e.message}`);
        }
        this.dom.commandInput.value = '';
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>